<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Calculadora de Comiss√£o Semanal - Barbearia</title>
<script src="https://cdn.tailwindcss.com"></script>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" integrity="sha512-iecdLmaskl7CVkqkXNQ/ZH/XLlvWZOJyj7Yy7tcenmpD1ypASozpmT/E0iPtmFIB46ZmdtAc9eNBvH0H/ZpiBw==" crossorigin="anonymous" referrerpolicy="no-referrer" />
<style>
  body { font-family: 'Inter', sans-serif; }
  .day-btn.active { background-color: #0891b2; color: white; }
  .transaction-item:hover .action-btn { opacity: 1; }
  .action-btn { opacity: 0; transition: opacity 0.2s ease-in-out; }
  .modal-backdrop {
    background-color: rgba(0,0,0,0.5);
    transition: opacity 0.3s ease;
  }
  input:disabled, select:disabled, button:disabled {
    background-color: #4a5568 !important;
    cursor: not-allowed;
    opacity: 0.6;
  }
</style>
</head>
<body class="bg-gray-900 text-white antialiased">

<!-- Tela de Login -->
<div id="login-screen" class="min-h-screen flex items-center justify-center">
  <div class="bg-gray-800 p-8 rounded-xl shadow-lg border border-gray-700 w-full max-w-sm">
    <h2 class="text-3xl font-bold text-center text-cyan-400 mb-6">Barber<span class="text-white">Commission</span></h2>
    <div class="space-y-4">
      <div>
        <label for="email" class="block text-sm font-medium text-gray-300 mb-1">Email</label>
        <input type="email" id="email" class="w-full bg-gray-700 border border-gray-600 rounded-md px-3 py-2 focus:ring-2 focus:ring-cyan-500 transition" placeholder="seu@email.com">
      </div>
      <div>
        <label for="password" class="block text-sm font-medium text-gray-300 mb-1">Senha</label>
        <input type="password" id="password" class="w-full bg-gray-700 border border-gray-600 rounded-md px-3 py-2 focus:ring-2 focus:ring-cyan-500 transition" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢">
      </div>
      <button id="loginBtn" class="w-full bg-cyan-600 hover:bg-cyan-700 text-white font-bold py-2 px-4 rounded-md transition duration-300">Entrar</button>
    </div>
  </div>
</div>

<!-- Container Principal do App -->
<div id="app-container" class="hidden">
  <div class="container mx-auto p-4 md:p-8 max-w-7xl">

    <!-- Cabe√ßalho -->
    <header class="text-center mb-6">
      <h1 class="text-4xl font-bold text-cyan-400">Barber<span class="text-white">Commission</span></h1>
      <p class="text-gray-400 mt-2">Fechamento de comiss√£o semanal (Ter√ßa a S√°bado)</p>
      <p id="currentWeek" class="text-cyan-500 font-semibold mt-2"></p>
      <p id="welcomeMessage" class="text-white mt-2"></p>
    </header>

    <!-- Se√ß√£o do Relat√≥rio do Admin -->
    <div id="admin-report-section" class="hidden bg-gray-800 p-6 rounded-xl shadow-lg border border-gray-700 mb-8">
      <h2 class="text-2xl font-semibold mb-4 text-center text-cyan-400">üìä Relat√≥rio Geral da Barbearia</h2>
      <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 text-center">
        <div class="lg:col-span-2 bg-gray-700 p-4 rounded-lg">
            <h3 class="text-lg font-medium text-gray-300 mt-4 mb-2">Faturamento Semanal - Loja 01</h3>
            <p id="loja01WeeklyTotal" class="text-2xl font-bold text-blue-400">R$ 0,00</p>
        </div>
        <div class="lg:col-span-2 bg-gray-700 p-4 rounded-lg">
            <h3 class="text-lg font-medium text-gray-300 mt-4 mb-2">Faturamento Semanal - Loja 02</h3>
            <p id="loja02WeeklyTotal" class="text-2xl font-bold text-yellow-400">R$ 0,00</p>
        </div>
        <div class="lg:col-span-2 bg-gray-700 p-4 rounded-lg">
          <h3 class="text-lg font-medium text-gray-300 mb-2">Faturamento Di√°rio - Loja 01 (Hoje)</h3>
          <p id="loja01DailyTotal" class="text-xl font-bold text-blue-400">R$ 0,00</p>
        </div>
        <div class="lg:col-span-2 bg-gray-700 p-4 rounded-lg">
            <h3 class="text-lg font-medium text-gray-300 mb-2">Faturamento Di√°rio - Loja 02 (Hoje)</h3>
            <p id="loja02DailyTotal" class="text-xl font-bold text-yellow-400">R$ 0,00</p>
        </div>
        <div class="lg:col-span-4 bg-gray-700 p-4 rounded-lg flex flex-col">
          <h3 class="text-lg font-medium text-gray-300 mb-2">Ranking de Faturamento (Semanal)</h3>
          <div id="barberRankingList" class="space-y-2 flex-grow overflow-y-auto"></div>
        </div>
      </div>
    </div>
    
    <!-- Seletor de Barbeiro (Vis√£o Admin/L√≠der) -->
    <div id="admin-selector-container" class="max-w-md mx-auto mb-8 hidden">
      <label for="barberSelector" class="block text-center text-lg font-medium text-gray-300 mb-2">Selecione o Funcion√°rio</label>
      <select id="barberSelector" class="w-full bg-gray-700 border border-gray-600 rounded-md px-3 py-3 text-lg focus:ring-2 focus:ring-cyan-500 transition"></select>
    </div>

    <!-- Conte√∫do Principal (Lan√ßamentos e Resumo) -->
    <div id="main-content" class="grid grid-cols-1 lg:grid-cols-5 gap-8 hidden">
      <!-- Coluna Esquerda: Lan√ßamentos -->
      <div class="lg:col-span-3 flex flex-col gap-6">
        <div class="bg-gray-800 p-6 rounded-xl shadow-lg border border-gray-700">
          <h2 class="text-2xl font-semibold mb-4">Lan√ßamentos da Semana</h2>
          <div id="day-selector" class="grid grid-cols-3 sm:grid-cols-5 gap-2 mb-6"></div>
          
          <!-- Formul√°rio de Lan√ßamento -->
          <div id="transaction-form" class="bg-gray-700/50 p-4 rounded-lg space-y-4">
            <!-- (o resto do formul√°rio permanece id√™ntico) -->
          </div>

          <!-- Atividade e Vale -->
          <div class="mt-6">
            <h3 class="font-semibold text-lg mb-2">Atividade do Dia</h3>
            <div id="daily-log" class="space-y-2 max-h-96 overflow-y-auto pr-2">
              <p id="daily-log-placeholder" class="text-gray-500 text-center p-4">Nenhum lan√ßamento para este dia.</p>
            </div>
            <div class="relative mt-4">
              <label for="vale" class="block text-sm font-medium text-yellow-400 mb-1">Registrar Vale para o Dia</label>
              <div class="flex gap-2">
                <input type="number" id="vale" placeholder="Valor do Vale (R$)" class="entry-input w-full bg-gray-700 border border-gray-600 rounded-md px-3 py-2">
                <button id="saveValeBtn" class="bg-yellow-600 hover:bg-yellow-700 text-white font-bold py-2 px-4 rounded-md transition">Salvar</button>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Coluna Direita: Resumo -->
      <div class="lg:col-span-2">
        <div class="bg-gray-800 p-6 rounded-xl shadow-lg border border-gray-700 sticky top-8">
          <h2 class="text-2xl font-semibold mb-4">Resumo da Semana</h2>
          <!-- (a estrutura do resumo permanece id√™ntica) -->
          <button id="closeWeekBtn" class="mt-6 w-full bg-green-600 hover:bg-green-700 text-white font-bold py-3 px-4 rounded-md transition duration-300 flex items-center justify-center gap-2">
            <i class="fa-solid fa-lock"></i>
            Encerrar e Pagar Semana
          </button>
        </div>
      </div>
    </div>
    
    <!-- Se√ß√£o de Hist√≥rico -->
    <div id="history-section" class="mt-12 hidden lg:col-span-5">
      <!-- (a estrutura do hist√≥rico permanece id√™ntica) -->
    </div>
  </div>
</div>

<!-- Modal de Edi√ß√£o -->
<div id="edit-modal" class="fixed inset-0 z-50 items-center justify-center hidden modal-backdrop">
  <!-- (a estrutura do modal permanece id√™ntica) -->
</div>

<!-- ======================================================== -->
<!-- =================== C√ìDIGO JAVASCRIPT ================== -->
<!-- ======================================================== -->
<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
  import { getAuth, signInWithEmailAndPassword, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
  import { getFirestore, doc, setDoc, onSnapshot, collection, addDoc, serverTimestamp, query, deleteDoc, getDocs, collectionGroup } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

  // *****************************************************************
  // CONFIGURA√á√ÉO E DADOS GLOBAIS
  // *****************************************************************
  const firebaseConfig = {
    apiKey: "AIzaSyBCfdVci2RFEearjQzByEysTXtV6D4Tofs",
    authDomain: "comisao-dos-barbeiros.firebaseapp.com",
    projectId: "comisao-dos-barbeiros",
    storageBucket: "comisao-dos-barbeiros.firebasestorage.app",
    messagingSenderId: "571199864529",
    appId: "1:571199864529:web:0ea9584c0c5372192e4ff0",
    measurementId: "G-VW7EZCR5G5"
  };

  const users = {
    "admin@exemplo.com": { password: "753951", role: "admin", name: "Admin", email: "admin@exemplo.com", barberId: "1DlWcbIq0ANITQiquGcTV5RzY7y2" },
    "adrianopessanha@exemplo.com": { password: "123456", role: "barber", name: "Adriano Pessanha", email: "adrianopessanha@exemplo.com", barberId: "mZAck0O4a6Ts2VUSSV75OHauzMG3" },
    "rodrigo@exemplo.com": { password: "123456", role: "barber", name: "Rodrigo Azevedo", email: "rodrigo@exemplo.com", barberId: "zs99mAYa5eNKoEPh56qINO8w7J22", canViewBarbers: ["hTaN1vL0afbINmeOjdbQJ13sJPg1", "xfk8NmhR9haZwjmagOAeYXCU9PY2"] },
    "veloso@exemplo.com": { password: "123456", role: "barber", name: "Veloso", email: "veloso@exemplo.com", barberId: "hTaN1vL0afbINmeOjdbQJ13sJPg1" },
    "wellington@exemplo.com": { password: "123456", role: "barber", name: "Wellington", email: "wellington@exemplo.com", barberId: "HE7OZUptfdVbN8QmUaGzYgRUWrU2" },
    "jonata@exemplo.com": { password: "123456", role: "barber", name: "Jonata Silva", email: "jonata@exemplo.com", barberId: "q0v1NPLF6jVrqWvPgTkiJBLcq242" },
    "mauro@exemplo.com": { password: "123456", role: "barber", name: "Mauro", email: "mauro@exemplo.com", barberId: "xfk8NmhR9haZwjmagOAeYXCU9PY2" }
  };

  const barberStoreMap = {
    "mZAck0O4a6Ts2VUSSV75OHauzMG3": "loja02", "zs99mAYa5eNKoEPh56qINO8w7J22": "loja01", "hTaN1vL0afbINmeOjdbQJ13sJPg1": "loja01", "HE7OZUptfdVbN8QmUaGzYgRUWrU2": "loja02", "q0v1NPLF6jVrqWvPgTkiJBLcq242": "loja02", "xfk8NmhR9haZwjmagOAeYXCU9PY2": "loja01"
  };

  // --- VARI√ÅVEIS GLOBAIS DE ESTADO E DOM ---
  let db, auth;
  let loggedInUser = null;
  let selectedBarberId = null;
  let currentWeekId;
  let selectedDay;
  let weeklyData = {};
  let currentEditingTransactionId = null;
  let unsubscribeWeeklyData = () => {};
  let unsubscribeHistory = () => {};
  let unsubscribeAdminReport = () => {};
  let elements = {};

  const weekDays = { 2: 'Ter√ßa', 3: 'Quarta', 4: 'Quinta', 5: 'Sexta', 6: 'S√°bado' };
  const formatCurrency = (value) => new Intl.NumberFormat('pt-BR', { style: 'currency', currency: 'BRL' }).format(value || 0);
  const getWeekId = (d = new Date()) => { d=new Date(Date.UTC(d.getFullYear(),d.getMonth(),d.getDate())); d.setUTCDate(d.getUTCDate()+4-(d.getUTCDay()||7)); const yearStart=new Date(Date.UTC(d.getUTCFullYear(),0,1)); const weekNo=Math.ceil((((d-yearStart)/86400000)+1)/7); return `${d.getUTCFullYear()}-W${String(weekNo).padStart(2, '0')}`; };

  // --- PONTO DE ENTRADA PRINCIPAL ---
  document.addEventListener('DOMContentLoaded', main);

  function main() {
    try {
      const app = initializeApp(firebaseConfig);
      db = getFirestore(app);
      auth = getAuth(app);
      
      initializeDOMElements();
      setupLoginListeners();
      setupAuthListener();
      
      currentWeekId = getWeekId();
    } catch (error) {
      console.error("ERRO CR√çTICO: N√£o foi poss√≠vel inicializar o Firebase.", error);
      alert("ERRO CR√çTICO: N√£o foi poss√≠vel inicializar o Firebase. Detalhes: " + error.message);
    }
  }

  // --- FUN√á√ïES DE SETUP ---
  function initializeDOMElements() {
    const allIds = [ 'login-screen', 'app-container', 'loginBtn', 'email', 'password', 'barberSelector', 'admin-selector-container', 'welcomeMessage', 'main-content', 'history-section', 'day-selector', 'addServiceTransactionBtn', 'addProductTransactionBtn', 'addPlanTransactionBtn', 'saveValeBtn', 'vale', 'daily-log', 'daily-log-placeholder', 'edit-modal', 'close-edit-modal-btn', 'saveEditBtn', 'closeWeekBtn', 'currentWeek', 'historyTableBody', 'historyPlaceholder', 'admin-report-section', 'barberDetailsSection', 'faturamentoBruto', 'comissaoServicos', 'comissaoProdutos', 'subtotalComissao', 'descontoVale', 'comissaoFinal', 'reportFaturamentoTotal', 'reportDinheiro', 'reportPix', 'reportDebito', 'reportCredito', 'reportQtdAssinaturas', 'reportValorAssinaturas', 'reportQtdCartaoPresente', 'reportValorCartaoPresente', 'reportComissaoAssinaturasCartao', 'reportFaturamentoDiarioDinheiro', 'reportFaturamentoDiarioPix', 'reportFaturamentoDiarioDebito', 'reportFaturamentoDiarioCredito', 'reportFaturamentoDiarioTotal', 'barberRankingList', 'loja01DailyDinheiro', 'loja01DailyPix', 'loja01DailyDebito', 'loja01DailyCredito', 'loja01WeeklyTotal', 'loja01DailyTotal', 'loja02DailyDinheiro', 'loja02DailyPix', 'loja02DailyDebito', 'loja02DailyCredito', 'loja02WeeklyTotal', 'loja02DailyTotal', 'comissaoAssinaturas', 'comissaoCartaoPresente', 'detalheAssinaturas', 'detalheCartaoPresente', 'detalheDinheiro', 'detalhePix', 'detalheDebito', 'detalheCredito', 'detalheTotalProdutos' ];
    allIds.forEach(id => {
        elements[id] = document.getElementById(id);
        if (id.startsWith('edit')) {
            const formId = id.replace('edit', '').charAt(0).toLowerCase() + id.slice(5);
            if (!elements.editTransactionForm) elements.editTransactionForm = {};
            elements.editTransactionForm[formId] = elements[id];
        } else if (id === 'clientName' || id === 'serviceDescription' || id === 'serviceValue' || id === 'paymentMethod' || id === 'productDescription' || id === 'productsSold' || id === 'productSaleValue' || id === 'productPaymentMethod' || id === 'clientNamePlan' || id === 'planSaleValue' || id === 'planSaleType' || id === 'planSalePaymentMethod') {
            if (!elements.transactionForm) elements.transactionForm = {};
            elements.transactionForm[id] = elements[id];
        }
    });
  }

  function setupLoginListeners() {
    elements.loginBtn.addEventListener('click', handleLogin);
    elements.password.addEventListener('keyup', (event) => {
      if (event.key === 'Enter') handleLogin();
    });
  }

  function setupAuthListener() {
    onAuthStateChanged(auth, (user) => {
      if (user) {
        // *** ESTA √â A LINHA CORRIGIDA ***
        const userInfo = Object.values(users).find(u => u.email.toLowerCase() === user.email.toLowerCase());
        
        if (userInfo) {
            loggedInUser = { ...userInfo, uid: user.uid };
            elements.loginScreen.classList.add('hidden');
            elements.appContainer.classList.remove('hidden');
            setupUIForUser();
        } else {
            console.error("SUCESSO NO LOGIN, FALHA NA BUSCA LOCAL: Usu√°rio logado no Firebase, mas n√£o encontrado na lista 'users':", user.email);
            auth.signOut();
            alert("Erro de configura√ß√£o: usu√°rio autenticado mas n√£o reconhecido pelo sistema. Contate o suporte.");
        }
      } else {
        loggedInUser = null;
        elements.loginScreen.classList.remove('hidden');
        elements.appContainer.classList.add('hidden');
        if (unsubscribeWeeklyData) unsubscribeWeeklyData();
        if (unsubscribeHistory) unsubscribeHistory();
      }
    });
  }

  // --- L√ìGICA DE LOGIN E UI ---
  async function handleLogin() {
    const email = elements.email.value.toLowerCase().trim();
    const password = elements.password.value;
    if (!email || !password) return alert("Por favor, preencha o e-mail e a senha.");
    try {
      await signInWithEmailAndPassword(auth, email, password);
    } catch (error) {
      console.error("Login Error:", error.code);
      alert("Email ou senha inv√°lidos. Verifique os dados.");
    }
  }

  function setupUIForUser() {
    elements.welcomeMessage.textContent = `Bem-vindo(a), ${loggedInUser.name}!`;
    if (loggedInUser.role === 'admin') {
      elements.adminSelectorContainer.classList.remove('hidden');
      elements.adminReportSection.classList.remove('hidden');
      listenToAdminReportData();
      elements.barberDetailsSection.classList.add('hidden');
      setupAdminBarberSelector();
    } else { 
      elements.adminReportSection.classList.add('hidden'); 
      if (loggedInUser.canViewBarbers?.length > 0) {
        elements.adminSelectorContainer.classList.remove('hidden');
        elements.barberDetailsSection.classList.remove('hidden');
        setupLeaderBarberSelector();
      } else {
        elements.adminSelectorContainer.classList.add('hidden');
        elements.barberDetailsSection.classList.remove('hidden');
        selectedBarberId = loggedInUser.barberId;
        elements.mainContent.classList.remove('hidden');
        elements.historySection.classList.remove('hidden');
        startListeners();
      }
    }
    setupCommonUI();
  }
  
  function setupAdminBarberSelector() {
    elements.barberSelector.innerHTML = '<option value="">-- Vis√£o Geral / Selecione um funcion√°rio --</option>';
    const sortedBarbers = Object.values(users)
        .filter(u => u.role === 'barber')
        .sort((a, b) => a.name.localeCompare(b.name));
    
    sortedBarbers.forEach(barber => {
        elements.barberSelector.innerHTML += `<option value="${barber.barberId}">${barber.name}</option>`;
    });

    elements.barberSelector.addEventListener('change', () => {
      selectedBarberId = elements.barberSelector.value;
      if (selectedBarberId) {
        elements.mainContent.classList.remove('hidden');
        elements.historySection.classList.remove('hidden');
        elements.barberDetailsSection.classList.remove('hidden'); 
        startListeners();
      } else {
        elements.mainContent.classList.add('hidden');
        elements.historySection.classList.add('hidden');
        elements.barberDetailsSection.classList.add('hidden'); 
        if (unsubscribeWeeklyData) unsubscribeWeeklyData();
        if (unsubscribeHistory) unsubscribeHistory();
      }
    });
  }
  
  function setupLeaderBarberSelector() {
    elements.barberSelector.innerHTML = `<option value="${loggedInUser.barberId}">Minha Vis√£o (${loggedInUser.name})</option>`;
    loggedInUser.canViewBarbers.forEach(barberIdToView => {
        const barberInfo = Object.values(users).find(u => u.barberId === barberIdToView);
        if (barberInfo) {
            elements.barberSelector.innerHTML += `<option value="${barberInfo.barberId}">${barberInfo.name}</option>`;
        }
    });
    selectedBarberId = loggedInUser.barberId;
    elements.mainContent.classList.remove('hidden');
    elements.historySection.classList.remove('hidden');
    startListeners();

    elements.barberSelector.addEventListener('change', () => {
      selectedBarberId = elements.barberSelector.value;
      startListeners();
    });
  }

  function setupCommonUI() {
    elements.daySelector.innerHTML = Object.entries(weekDays).map(([dayIndex, dayName]) =>
      `<button class="day-btn p-2 rounded-md bg-gray-700 hover:bg-gray-600 transition" data-day-index="${dayIndex}">${dayName}</button>`
    ).join('');

    const todayIndex = new Date().getDay();
    selectedDay = (todayIndex >= 2 && todayIndex <= 6) ? todayIndex : 2; 
    updateDaySelection(); 

    elements.daySelector.querySelectorAll('.day-btn').forEach(btn => {
      btn.addEventListener('click', () => {
        selectedDay = parseInt(btn.dataset.dayIndex);
        updateDaySelection();
      });
    });

    const weekStartDate = new Date();
    weekStartDate.setDate(weekStartDate.getDate() - (weekStartDate.getDay() - 2 + 7) % 7);
    const weekEndDate = new Date(weekStartDate);
    weekEndDate.setDate(weekEndDate.getDate() + 4);

    elements.currentWeek.textContent = `Semana: ${weekStartDate.toLocaleDateString('pt-BR')} - ${weekEndDate.toLocaleDateString('pt-BR')}`;

    elements.addServiceTransactionBtn.addEventListener('click', () => addTransaction('service'));
    elements.addProductTransactionBtn.addEventListener('click', () => addTransaction('product'));
    elements.addPlanTransactionBtn.addEventListener('click', () => addTransaction('plan'));

    elements.saveValeBtn.addEventListener('click', saveVale);
    elements.closeWeekBtn.addEventListener('click', closeWeek);
    elements.closeEditModalBtn.addEventListener('click', () => {
      elements.editModal.classList.add('hidden');
      elements.editModal.classList.remove('flex');
    });
    elements.saveEditBtn.addEventListener('click', saveEditedTransaction);
  }

  function startListeners() {
    if (unsubscribeWeeklyData) unsubscribeWeeklyData();
    if (unsubscribeHistory) unsubscribeHistory();
    listenToWeeklyData();
    listenToClosingsHistory();
  }

  function updateInputState() {
      const currentDayIndex = new Date().getDay();
      const isTodayOrFuture = selectedDay >= currentDayIndex;
      const isAdmin = loggedInUser.role === 'admin';
      const canEdit = isAdmin || isTodayOrFuture;
      const inputs = document.querySelectorAll('#transaction-form input, #transaction-form select, #vale');
      const buttons = document.querySelectorAll('#transaction-form button, #saveValeBtn');
      inputs.forEach(el => el.disabled = !canEdit);
      buttons.forEach(el => el.disabled = !canEdit);
  }

  function updateDaySelection() {
    elements.daySelector.querySelectorAll('.day-btn').forEach(btn => {
      btn.classList.toggle('active', parseInt(btn.dataset.dayIndex) === selectedDay);
    });
    calculateWeeklySummary(); 
    renderDailyLog();
    updateInputState();
  }
  
  function renderDailyLog() {
    const dayKey = weekDays[selectedDay];
    const dayData = weeklyData[dayKey] || { transactions: [], vale: 0 };
    const transactions = dayData.transactions || [];
    const currentDayIndex = new Date().getDay();
    const isTodayOrFuture = selectedDay >= currentDayIndex;
    const canEdit = loggedInUser.role === 'admin' || isTodayOrFuture;
    elements.dailyLog.innerHTML = '';

    if (transactions.length === 0) {
      elements.dailyLog.appendChild(elements.dailyLogPlaceholder);
      elements.dailyLogPlaceholder.style.display = 'block';
    } else {
      elements.dailyLogPlaceholder.style.display = 'none';
      transactions.forEach(t => {
        const item = document.createElement('div');
        item.className = 'transaction-item bg-gray-600/50 p-3 rounded-md flex justify-between items-center';
        let descriptionHtml = '';
        if (t.serviceDescription && t.value > 0) { descriptionHtml += `<p class="font-semibold">${t.serviceDescription} <span class="text-cyan-400">${formatCurrency(t.value)}</span> <span class="text-gray-400">(${t.paymentMethod})</span></p>`; }
        if (t.productDescription && t.products > 0) {
            let prefix = (t.serviceDescription && t.value > 0) ? `<p class="text-sm text-gray-400 mt-1">` : `<p class="font-semibold">`;
            descriptionHtml += `${prefix}Produto: ${t.productDescription} <span class="text-cyan-400">(${t.products} unid.)</span>`;
            if (t.productSaleValue > 0) descriptionHtml += ` <span class="text-cyan-400">${formatCurrency(t.productSaleValue)}</span>`;
            if (t.productPaymentMethod) descriptionHtml += ` <span class="text-gray-400">(${t.productPaymentMethod})</span>`;
            descriptionHtml += `</p>`;
        }
        if (t.planSaleType && t.planSaleValue > 0) {
            let planSaleText = `Venda de ${t.planSaleType}`;
            if (t.clientNamePlan) planSaleText += ` para ${t.clientNamePlan}`; 
            let prefix = ((t.serviceDescription && t.value > 0) || (t.productDescription && t.products > 0)) ? `<p class="text-sm text-purple-400 mt-1">` : `<p class="font-semibold text-purple-400">`;
            descriptionHtml += `${prefix}${planSaleText} <span class="text-cyan-400">${formatCurrency(t.planSaleValue)}</span> <span class="text-gray-400">(${t.planSalePaymentMethod})</span></p>`;
        }
        if (t.clientName && !t.clientNamePlan) { descriptionHtml += `<p class="text-xs text-gray-500">Cliente: ${t.clientName}</p>`; }
        item.innerHTML = `<div>${descriptionHtml}</div><div class="flex items-center gap-3 ${canEdit ? '' : 'hidden'}"><button class="action-btn edit-btn text-blue-400 hover:text-blue-300" data-id="${t.id}"><i class="fa-solid fa-pencil"></i></button><button class="action-btn delete-btn text-red-500 hover:text-red-400" data-id="${t.id}" data-transaction-day-index="${selectedDay}"><i class="fa-solid fa-trash"></i></button></div>`;
        elements.dailyLog.appendChild(item);
      });
    }

    elements.dailyLog.querySelectorAll('.delete-btn').forEach(btn => btn.addEventListener('click', (event) => deleteTransaction(event.currentTarget.dataset.id, parseInt(event.currentTarget.dataset.transactionDayIndex))));
    elements.dailyLog.querySelectorAll('.edit-btn').forEach(btn => btn.addEventListener('click', () => openEditModal(btn.dataset.id)));
    elements.vale.value = dayData.vale || '';
  }

  async function updateFirestoreData(newData) {
    if (!selectedBarberId) return;
    try {
      const docRef = doc(db, "barbers", selectedBarberId, "weekly_entries", currentWeekId);
      await setDoc(docRef, newData, { merge: true });
    } catch (error) {
      console.error("Error updating Firestore:", error);
      alert("ERRO AO SALVAR DADOS: " + error.message);
    }
  }

  async function addTransaction(type) {
    const currentDayIndex = new Date().getDay();
    if (loggedInUser.role === 'barber' && selectedDay < currentDayIndex) return alert("Voc√™ s√≥ pode adicionar lan√ßamentos para o dia atual ou futuros.");
    if (loggedInUser.role === 'barber' && loggedInUser.barberId !== selectedBarberId) return alert("Voc√™ n√£o tem permiss√£o para adicionar lan√ßamentos para outros barbeiros.");
    
    let newTransaction = { id: crypto.randomUUID() };
    if (type === 'service') {
        const serviceDescription = elements.transactionForm.serviceDescription.value.trim();
        const serviceValue = parseFloat(elements.transactionForm.serviceValue.value) || 0;
        if (!serviceDescription || serviceValue <= 0) return alert("Por favor, preencha a descri√ß√£o e o valor do servi√ßo.");
        Object.assign(newTransaction, { clientName: elements.transactionForm.clientName.value.trim(), serviceDescription, value: serviceValue, paymentMethod: elements.transactionForm.paymentMethod.value });
        ['clientName', 'serviceDescription', 'serviceValue'].forEach(id => elements.transactionForm[id].value = '');
    } else if (type === 'product') {
        // L√≥gica de produto...
    } else if (type === 'plan') {
        // L√≥gica de plano...
    } else { return; }

    const dayKey = weekDays[selectedDay];
    const updatedData = JSON.parse(JSON.stringify(weeklyData));
    if (!updatedData[dayKey]) updatedData[dayKey] = { transactions: [], vale: 0 };
    updatedData[dayKey].transactions.push(newTransaction);
    await updateFirestoreData(updatedData);
  }

  async function deleteTransaction(transactionId, transactionDayIndex) {
    const currentDayIndex = new Date().getDay();
    if (loggedInUser.role === 'barber' && transactionDayIndex < currentDayIndex) return alert("Voc√™ s√≥ pode excluir lan√ßamentos do dia atual.");
    if (loggedInUser.role === 'barber' && loggedInUser.barberId !== selectedBarberId) return alert("Voc√™ n√£o tem permiss√£o para excluir lan√ßamentos de outros barbeiros.");
    if (!confirm("Tem certeza que deseja apagar este lan√ßamento?")) return;
    const dayKey = weekDays[transactionDayIndex];
    const updatedData = JSON.parse(JSON.stringify(weeklyData));
    if (updatedData[dayKey]?.transactions) {
      updatedData[dayKey].transactions = updatedData[dayKey].transactions.filter(t => t.id !== transactionId);
      await updateFirestoreData(updatedData);
    }
  }

  function openEditModal(transactionId) {
    const currentDayIndex = new Date().getDay();
    if (loggedInUser.role === 'barber' && selectedDay < currentDayIndex) return alert("Voc√™ s√≥ pode editar lan√ßamentos do dia atual.");
    const dayKey = weekDays[selectedDay];
    const transaction = weeklyData[dayKey]?.transactions.find(t => t.id === transactionId);
    if (!transaction) return;
    if (loggedInUser.role === 'barber' && loggedInUser.barberId !== selectedBarberId) return alert("Voc√™ n√£o tem permiss√£o para editar lan√ßamentos de outros barbeiros.");
    
    currentEditingTransactionId = transactionId;
    Object.keys(elements.editTransactionForm).forEach(key => {
        const transactionKey = key.replace('edit', '').charAt(0).toLowerCase() + key.slice(5);
        elements.editTransactionForm[key].value = transaction[transactionKey] || '';
    });
    elements.editModal.classList.remove('hidden');
    elements.editModal.classList.add('flex');
  }

  async function saveEditedTransaction() {
    if (!currentEditingTransactionId) return;
    const dayKey = weekDays[selectedDay];
    const updatedData = JSON.parse(JSON.stringify(weeklyData));
    const transactionIndex = updatedData[dayKey]?.transactions.findIndex(t => t.id === currentEditingTransactionId);
    if (transactionIndex > -1) {
      let updatedTransaction = { id: currentEditingTransactionId };
      Object.keys(elements.editTransactionForm).forEach(key => {
        const transactionKey = key.replace('edit', '').charAt(0).toLowerCase() + key.slice(5);
        const value = elements.editTransactionForm[key].value;
        const isNumberField = ['serviceValue', 'productsSold', 'productSaleValue', 'planSaleValue'].includes(transactionKey);
        updatedTransaction[transactionKey] = isNumberField ? parseFloat(value) || 0 : value.trim();
      });
      updatedData[dayKey].transactions[transactionIndex] = updatedTransaction;
      await updateFirestoreData(updatedData);
    }
    elements.editModal.classList.add('hidden');
    elements.editModal.classList.remove('flex');
  }

  async function saveVale() {
    const dayKey = weekDays[selectedDay];
    const vale = parseFloat(elements.vale.value) || 0;
    const updatedData = JSON.parse(JSON.stringify(weeklyData));
    if (!updatedData[dayKey]) updatedData[dayKey] = { transactions: [], vale: 0 };
    updatedData[dayKey].vale = vale;
    await updateFirestoreData(updatedData);
    alert("Vale salvo com sucesso!");
  }

  function listenToWeeklyData() {
    if (!selectedBarberId) return;
    const docRef = doc(db, "barbers", selectedBarberId, "weekly_entries", currentWeekId);
    if (unsubscribeWeeklyData) unsubscribeWeeklyData();
    unsubscribeWeeklyData = onSnapshot(docRef, (docSnap) => {
      weeklyData = docSnap.exists() ? docSnap.data() : {};
      renderDailyLog();
      calculateWeeklySummary();
    }, (error) => console.error("Erro ao ouvir dados semanais:", error));
  }

  function calculateWeeklySummary() {
    let totalBrutoSemana = 0, comissaoServicosSemana = 0, comissaoAssinaturasSemana = 0, comissaoCartaoPresenteSemana = 0, totalValeSemana = 0, comissaoProdutosSemana = 0;
    Object.values(weeklyData).forEach(dayData => {
      let totalProdutosVendidosDia = 0;
      dayData.transactions?.forEach(t => {
        totalProdutosVendidosDia += t.products || 0;
        if (t.value > 0) {
          totalBrutoSemana += t.value; 
          if (t.paymentMethod === 'Assinatura') comissaoAssinaturasSemana += t.value * 0.50;
          else if (t.paymentMethod === 'Cart√£o Presente') comissaoCartaoPresenteSemana += t.value * 0.50;
          else { 
            let commissionableValue = t.value * (t.paymentMethod === 'D√©bito' ? 0.985 : t.paymentMethod === 'Cr√©dito' ? 0.95 : 1);
            comissaoServicosSemana += commissionableValue * 0.50;
          }
        }
      });
      comissaoProdutosSemana += totalProdutosVendidosDia * 5;
      totalValeSemana += dayData.vale || 0;
    });
    // (O resto da l√≥gica de c√°lculo e atualiza√ß√£o da UI)
  }

  function listenToAdminReportData() {
    const weeklyEntriesQuery = query(collectionGroup(db, 'weekly_entries'));
    unsubscribeAdminReport = onSnapshot(weeklyEntriesQuery, (snapshot) => {
        const allEntriesData = snapshot.docs.map(doc => ({ id: doc.id, barberId: doc.ref.parent.parent.id, data: doc.data() }));
        calculateAdminReport(allEntriesData);
    }, (error) => console.error("Erro ao ouvir entradas semanais (admin):", error));
  }
  
  function calculateAdminReport(allEntriesData) {
    // (L√≥gica de c√°lculo do relat√≥rio do admin...)
  }

  async function closeWeek() {
    // (L√≥gica de fechar a semana...)
  }

  function listenToClosingsHistory() {
    if (!selectedBarberId) return;
    const q = query(collection(db, "barbers", selectedBarberId, "weekly_closings"));
    if (unsubscribeHistory) unsubscribeHistory();
    unsubscribeHistory = onSnapshot(q, (snapshot) => {
      elements.historyTableBody.innerHTML = '';
      elements.historyPlaceholder.style.display = snapshot.empty ? 'block' : 'none';
      let docs = snapshot.docs.map(d => d.data()).sort((a,b) => (b.closedAt?.seconds || 0) - (a.closedAt?.seconds || 0));
      docs.forEach(data => {
        const tr = document.createElement('tr');
        tr.className = 'bg-gray-800 border-b border-gray-700 hover:bg-gray-700/80';
        tr.innerHTML = `<td class="px-4 py-3 text-gray-400">${data.periodo || data.weekId}</td><td class="px-4 py-3 text-right font-medium text-cyan-400">${formatCurrency(data.faturamentoBruto)}</td><td class="px-4 py-3 text-right font-medium text-yellow-400">${formatCurrency(data.totalVale)}</td><td class="px-4 py-3 text-right font-bold text-green-400">${formatCurrency(data.comissaoPaga)}</td>`;
        elements.historyTableBody.appendChild(tr);
      });
    }, (error) => console.error("Erro ao ouvir o hist√≥rico:", error));
  }

</script>
</body>
</html>
