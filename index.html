<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Calculadora de Comiss√£o Semanal - Barbearia</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" integrity="sha512-iecdLmaskl7CVkqkXNQ/ZH/XLlvWZOJyj7Yy7tcenmpD1ypASozpmT/E0iPtmFIB46ZmdtAc9eNBvH0H/ZpiBw==" crossorigin="anonymous" referrerpolicy="no-referrer" />
  <style>
    body { font-family: 'Inter', sans-serif; }
    .day-btn.active { background-color: #0891b2; color: white; }
    .transaction-item:hover .action-btn { opacity: 1; }
    .action-btn { opacity: 0; transition: opacity 0.2s ease-in-out; }
    .modal-backdrop {
      background-color: rgba(0,0,0,0.5);
      transition: opacity 0.3s ease;
    }
  </style>
</head>
<body class="bg-gray-900 text-white antialiased">

  <!-- Tela de Login -->
  <div id="login-screen" class="min-h-screen flex items-center justify-center">
    <div class="bg-gray-800 p-8 rounded-xl shadow-lg border border-gray-700 w-full max-w-sm">
      <h2 class="text-3xl font-bold text-center text-cyan-400 mb-6">Barber<span class="text-white">Commission</span></h2>
      <div class="space-y-4">
        <div>
          <label for="email" class="block text-sm font-medium text-gray-300 mb-1">Email</label>
          <input type="email" id="email" class="w-full bg-gray-700 border border-gray-600 rounded-md px-3 py-2 focus:ring-2 focus:ring-cyan-500 transition" placeholder="admin@exemplo.com">
        </div>
        <div>
          <label for="password" class="block text-sm font-medium text-gray-300 mb-1">Senha</label>
          <input type="password" id="password" class="w-full bg-gray-700 border border-gray-600 rounded-md px-3 py-2 focus:ring-2 focus:ring-cyan-500 transition" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢">
        </div>
        <button id="loginBtn" class="w-full bg-cyan-600 hover:bg-cyan-700 text-white font-bold py-2 px-4 rounded-md transition duration-300">Entrar</button>
      </div>
      <p class="text-xs text-gray-500 mt-4 text-center">Use admin@exemplo.com (senha:)</p>
    </div>
  </div>

  <!-- Conte√∫do do Aplicativo -->
  <div id="app-container" class="hidden">
    <div class="container mx-auto p-4 md:p-8 max-w-7xl">

      <header class="text-center mb-6">
        <h1 class="text-4xl font-bold text-cyan-400">Barber<span class="text-white">Commission</span></h1>
        <p class="text-gray-400 mt-2">Fechamento de comiss√£o semanal (Ter√ßa a S√°bado)</p>
        <p id="currentWeek" class="text-cyan-500 font-semibold mt-2"></p>
        <p id="welcomeMessage" class="text-white mt-2"></p>
      </header>

      <!-- Relat√≥rio da Barbearia -->
      <div id="admin-report-section" class="hidden bg-gray-800 p-6 rounded-xl shadow-lg border border-gray-700 mb-8">
        <h2 class="text-2xl font-semibold mb-4 text-center text-cyan-400">üìä Relat√≥rios da Barbearia</h2>

        <div class="bg-gray-700/50 p-4 rounded-lg border border-gray-600 mb-8">
          <h3 class="text-xl font-semibold text-center text-indigo-300 mb-4">Relat√≥rios Personalizados</h3>
          <div class="flex flex-wrap justify-center items-end gap-4">
            <div>
              <label for="customReportType" class="block text-sm font-medium text-gray-300 mb-1">Tipo de Relat√≥rio</label>
              <select id="customReportType" class="bg-gray-600 border border-gray-500 rounded-md px-3 py-2 focus:ring-2 focus:ring-indigo-500 transition">
                <option value="">Selecione...</option>
                <option value="annual_barber">Faturamento Anual por Barbeiro</option>
                <option value="products_period">Vendas de Produtos por Per√≠odo</option>
                <option value="subscriptions_period">Servi√ßos por Assinatura por Per√≠odo</option>
              </select>
            </div>

            <div id="year-selector-container" class="hidden">
              <label for="customReportYear" class="block text-sm font-medium text-gray-300 mb-1">Ano</label>
              <select id="customReportYear" class="bg-gray-600 border border-gray-500 rounded-md px-3 py-2 focus:ring-2 focus:ring-indigo-500 transition"></select>
            </div>

            <div id="date-range-container" class="hidden flex flex-wrap justify-center items-end gap-4">
              <div>
                <label for="startDate" class="block text-sm font-medium text-gray-300 mb-1">Data In√≠cio</label>
                <input type="date" id="startDate" class="bg-gray-600 border border-gray-500 rounded-md px-3 py-2 focus:ring-2 focus:ring-indigo-500 transition">
              </div>
              <div>
                <label for="endDate" class="block text-sm font-medium text-gray-300 mb-1">Data Fim</label>
                <input type="date" id="endDate" class="bg-gray-600 border border-gray-500 rounded-md px-3 py-2 focus:ring-2 focus:ring-indigo-500 transition">
              </div>
            </div>

            <button id="generateCustomReportBtn" class="bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-2 px-4 rounded-md transition duration-300">
              <i class="fa-solid fa-search"></i> Gerar
            </button>
          </div>
          <div id="custom-report-results" class="hidden mt-6">
            <h3 id="customReportTitle" class="text-xl font-semibold text-center text-indigo-300 mb-4"></h3>
            <div id="customReportContent" class="overflow-x-auto"></div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
    import { getAuth, signInAnonymously } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
    import { getFirestore, doc, setDoc, onSnapshot, collection, addDoc, serverTimestamp, query, deleteDoc, getDocs, collectionGroup } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyBCfdVci2RFEearjQzByEysTXtV6D4Tofs",
      authDomain: "comisao-dos-barbeiros.firebaseapp.com",
      projectId: "comisao-dos-barbeiros",
      storageBucket: "comisao-dos-barbeiros.firebasestorage.app",
      messagingSenderId: "571199864529",
      appId: "1:571199864529:web:0ea9584c0c5372192e4ff0",
      measurementId: "G-VW7EZCR5G5"
    };

    const users = {
      "admin@exemplo.com": { password: "753951", role: "admin", name: "Admin" },
      "adrianopessanha@exemplo.com": { password: "123", role: "barber", barberId: "barber-01", name: "Adriano Pessanha" },
      "rodrigo@exemplo.com": { password: "0712", role: "barber", barberId: "barber-02", name: "Rodrigo Azevedo", canViewBarbers: ["barber-03", "barber-06"] },
      "veloso@exemplo.com": { password: "123", role: "barber", barberId: "barber-03", name: "Veloso" },
      "wellington@exemplo.com": { password: "123", role: "barber", barberId: "barber-04", name: "Wellington" },
      "jonata@exemplo.com": { password: "123", role: "barber", barberId: "barber-05", name: "Jonata Silva" },
      "mauro@exemplo.com": { password: "123", role: "barber", barberId: "barber-06", name: "Mauro" },
      "wallace@exemplo.com": { password: "123", role: "barber", barberId: "barber-07", name: "Wallace Dias" }
    };

    const barberStoreMap = {
      "barber-01": "loja02", "barber-02": "loja01", "barber-03": "loja01", "barber-04": "loja02",
      "barber-05": "loja02", "barber-06": "loja01", "barber-07": "loja01"
    };

    let db;
    let selectedBarberId = null;
    let loggedInUser = null;
    let currentWeekId;
    let selectedDay;
    let weeklyData = {};
    let currentEditingTransactionId = null;
    let unsubscribeWeeklyData = () => {};
    let unsubscribeHistory = () => {};
    let unsubscribeWeeklyEntriesAdmin = () => {};
    let unsubscribeWeeklyClosingsAdmin = () => {};

    let latestWeeklyEntriesData = [];
    let latestWeeklyClosingsData = [];

    const weekDays = { 2: 'Ter√ßa', 3: 'Quarta', 4: 'Quinta', 5: 'Sexta', 6: 'S√°bado' };

    // Fun√ß√£o corrigida de ID de semana
    function getWeekId(d = new Date()) {
      const date = new Date(d.valueOf());
      const day = date.getDay(); // 0=Sun, 1=Mon, 2=Tue...
      
      if (day === 0) { 
          date.setDate(date.getDate() - 1); 
      } else if (day === 1) { 
          date.setDate(date.getDate() - 2); 
      }
      
      let dUTC = new Date(Date.UTC(date.getFullYear(), date.getMonth(), date.getDate()));
      dUTC.setUTCDate(dUTC.getUTCDate() + 4 - (dUTC.getUTCDay() || 7));
      const yearStart = new Date(Date.UTC(dUTC.getUTCFullYear(), 0, 1));
      const weekNo = Math.ceil((((dUTC - yearStart) / 86400000) + 1) / 7);
      return `${dUTC.getUTCFullYear()}-W${String(weekNo).padStart(2, '0')}`;
    }

    // Fun√ß√£o para atualizar os dados no Firestore
    async function updateFirestoreData(newData) {
      if (!selectedBarberId) return;
      try {
        const docRef = doc(db, "barbers", selectedBarberId, "weekly_entries", currentWeekId);
        console.log('Salvando dados no Firestore', newData); // Adicionando log para verificar
        await setDoc(docRef, newData);
      } catch (error) {
        console.error("Error updating Firestore:", error);
        alert("ERRO AO SALVAR DADOS: Verifique suas Regras de Seguran√ßa no painel do Firebase. Detalhes: " + error.message);
      }
    }

    // Inicializa o Firebase e faz login an√¥nimo
    async function initializeAppAndAuth() {
      if (firebaseConfig.apiKey.includes("")) {
        alert("");
      }
      try {
        const app = initializeApp(firebaseConfig);
        db = getFirestore(app);
        const auth = getAuth(app);
        await signInAnonymously(auth); // Autentica√ß√£o an√¥nima
        currentWeekId = getWeekId(new Date());
        setupLogin();
      } catch (error) {
        console.error("Firebase Init Error:", error);
        if (error.code === 'auth/configuration-not-found' || error.code === 'auth/operation-not-allowed') {
          alert("ERRO DE CONFIGURA√á√ÉO DO FIREBASE:\n\nPara o aplicativo funcionar, voc√™ precisa ATIVAR o provedor de login 'An√¥nimo'.\n\nCOMO RESOLVER:\n1. V√° ao seu painel do Firebase.\n2. No menu, clique em 'Authentication'.\n3. Clique na aba 'Sign-in method'.\n4. Encontre 'An√¥nimo' na lista e clique no l√°pis para editar.\n5. ATIVE a chave e clique em 'Salvar'.\n\nDepois disso, atualize a p√°gina.");
        } else {
          alert("ERRO CR√çTICO: N√£o foi poss√≠vel inicializar o Firebase. Detalhes: " + error.message);
        }
      }
    }

    // L√≥gica de login
    function handleLogin() {
      const email = emailInput.value.toLowerCase();
      const password = passwordInput.value;
      const user = users[email];

      if (user && user.password === password) {
        loggedInUser = user;
        loginScreen.classList.add('hidden');
        appContainer.classList.remove('hidden');
        setupUIForUser();
      } else {
        alert("Email ou senha inv√°lidos.");
      }
    }

    function setupLogin() {
      loginBtn.addEventListener('click', handleLogin);
    }

    // Fun√ß√£o para ouvir dados semanais do Firestore
    function listenToWeeklyData() {
      if (!selectedBarberId) return;
      const docRef = doc(db, "barbers", selectedBarberId, "weekly_entries", currentWeekId);
      if (unsubscribeWeeklyData) unsubscribeWeeklyData();
      unsubscribeWeeklyData = onSnapshot(docRef, (docSnap) => {
        weeklyData = docSnap.exists() ? docSnap.data() : {};
        console.log('Dados semanais: ', weeklyData); // Adicionando log para verificar os dados
        renderDailyLog();
        calculateWeeklySummary();
      }, (error) => {
        console.error("Erro ao ouvir dados semanais:", error);
        alert("ERRO AO CARREGAR DADOS: Verifique suas Regras de Seguran√ßa no painel do Firebase. O acesso pode estar bloqueado. Detalhes: " + error.message);
      });
    }

    document.addEventListener('DOMContentLoaded', initializeAppAndAuth);
  </script>
</body>
</html>
