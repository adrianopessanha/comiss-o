<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
  import { getAuth, signInWithEmailAndPassword, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
  import { getFirestore, doc, setDoc, onSnapshot, collection, addDoc, serverTimestamp, query, deleteDoc, getDocs, collectionGroup } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

  // *****************************************************************
  // CONFIGURAÇÃO DO FIREBASE
  // *****************************************************************
  const firebaseConfig = {
    apiKey: "AIzaSyBCfdVci2RFEearjQzByEysTXtV6D4Tofs", // Sua chave de API
    authDomain: "comisao-dos-barbeiros.firebaseapp.com",
    projectId: "comisao-dos-barbeiros",
    storageBucket: "comisao-dos-barbeiros.firebasestorage.app",
    messagingSenderId: "571199864529",
    appId: "1:571199864529:web:0ea9584c0c5372192e4ff0",
    measurementId: "G-VW7EZCR5G5"
  };

  // --- DATABASE DE USUÁRIOS (COM UIDs REAIS E SENHAS CORRIGIDAS) ---
  const users = {
    "admin@exemplo.com": { 
        password: "753951", role: "admin", name: "Admin", email: "admin@exemplo.com", 
        barberId: "1DlWcbIq0ANITQiquGcTV5RzY7y2"
    },
    "adrianopessanha@exemplo.com": { 
        password: "123456", role: "barber", name: "Adriano Pessanha", email: "adrianopessanha@exemplo.com",
        barberId: "mZAck0O4a6Ts2VUSSV75OHauzMG3" 
    },
    "rodrigo@exemplo.com": { 
        password: "123456", role: "barber", name: "Rodrigo Azevedo", email: "rodrigo@exemplo.com",
        barberId: "zs99mAYa5eNKoEPh56qINO8w7J22", 
        canViewBarbers: ["hTaN1vL0afbINmeOjdbQJ13sJPg1", "xfk8NmhR9haZwjmagOAeYXCU9PY2"]
    },
    "veloso@exemplo.com": { 
        password: "123456", role: "barber", name: "Veloso", email: "veloso@exemplo.com",
        barberId: "hTaN1vL0afbINmeOjdbQJ13sJPg1" 
    },
    "wellington@exemplo.com": { 
        password: "123456", role: "barber", name: "Wellington", email: "wellington@exemplo.com",
        barberId: "HE7OZUptfdVbN8QmUaGzYgRUWrU2" 
    },
    "jonata@exemplo.com": { 
        password: "123456", role: "barber", name: "Jonata Silva", email: "jonata@exemplo.com",
        barberId: "q0v1NPLF6jVrqWvPgTkiJBLcq242" 
    },
    "mauro@exemplo.com": { 
        password: "123456", role: "barber", name: "Mauro", email: "mauro@exemplo.com",
        barberId: "xfk8NmhR9haZwjmagOAeYXCU9PY2" 
    }
  };

  // *** CORREÇÃO CRÍTICA: MAPA DE LOJAS ATUALIZADO COM UIDs REAIS ***
  const barberStoreMap = {
    "mZAck0O4a6Ts2VUSSV75OHauzMG3": "loja02", // Adriano
    "zs99mAYa5eNKoEPh56qINO8w7J22": "loja01", // Rodrigo
    "hTaN1vL0afbINmeOjdbQJ13sJPg1": "loja01", // Veloso
    "HE7OZUptfdVbN8QmUaGzYgRUWrU2": "loja02", // Wellington
    "q0v1NPLF6jVrqWvPgTkiJBLcq242": "loja02", // Jonata
    "xfk8NmhR9haZwjmagOAeYXCU9PY2": "loja01"  // Mauro
  };

  // --- VARIÁVEIS GLOBAIS ---
  let db;
  let selectedBarberId = null;
  let loggedInUser = null;
  let currentWeekId;
  let selectedDay;
  let weeklyData = {};
  let currentEditingTransactionId = null;
  let unsubscribeWeeklyData = () => {};
  let unsubscribeHistory = () => {};
  let unsubscribeWeeklyEntriesAdmin = () => {};
  const weekDays = { 2: 'Terça', 3: 'Quarta', 4: 'Quinta', 5: 'Sexta', 6: 'Sábado' };
  
  // Variáveis de elementos DOM
  let loginScreen, appContainer, barberSelector, mainContent, historySection, daySelector, addServiceTransactionBtn, addProductTransactionBtn, addPlanTransactionBtn, saveValeBtn, valeInput,
        dailyLog, dailyLogPlaceholder, transactionForm, editModal, closeEditModalBtn, saveEditBtn,
        editTransactionForm, closeWeekBtn, currentWeekSpan, historyTableBody, historyPlaceholder, summarySpans,
        adminSelectorContainer, welcomeMessage, loginBtn, emailInput, passwordInput, adminReportSection, adminReportSpans,
        detalheAssinaturas, detalheCartaoPresente, detalheDinheiro, detalhePix, detalheDebito, detalheCredito, detalheTotalProdutos,
        barberDetailsSection, reportComissaoAssinaturasCartao, barberRankingList,
        loja01DailyDinheiro, loja01DailyPix, loja01DailyDebito, loja01DailyCredito, loja01WeeklyTotal,
        loja02DailyDinheiro, loja02DailyPix, loja02DailyDebito, loja02DailyCredito, loja02WeeklyTotal,
        comissaoAssinaturas, comissaoCartaoPresente, loja01DailyTotal, loja02DailyTotal;
  
  const formatCurrency = (value) => new Intl.NumberFormat('pt-BR', { style: 'currency', currency: 'BRL' }).format(value || 0);

  function getWeekId(d = new Date()) {
    d = new Date(Date.UTC(d.getFullYear(), d.getMonth(), d.getDate()));
    d.setUTCDate(d.getUTCDate() + 4 - (d.getUTCDay()||7));
    const yearStart = new Date(Date.UTC(d.getUTCFullYear(),0,1));
    const weekNo = Math.ceil((((d - yearStart) / 86400000) + 1)/7);
    return `${d.getUTCFullYear()}-W${String(weekNo).padStart(2, '0')}`;
  }
  
  function initializeDOMReferences() {
    loginScreen = document.getElementById('login-screen');
    appContainer = document.getElementById('app-container');
    loginBtn = document.getElementById('loginBtn');
    emailInput = document.getElementById('email');
    passwordInput = document.getElementById('password');
    barberSelector = document.getElementById('barberSelector');
    adminSelectorContainer = document.getElementById('admin-selector-container');
    welcomeMessage = document.getElementById('welcomeMessage');
    mainContent = document.getElementById('main-content');
    historySection = document.getElementById('history-section');
    daySelector = document.getElementById('day-selector');
    addServiceTransactionBtn = document.getElementById('addServiceTransactionBtn');
    addProductTransactionBtn = document.getElementById('addProductTransactionBtn');
    addPlanTransactionBtn = document.getElementById('addPlanTransactionBtn');
    saveValeBtn = document.getElementById('saveValeBtn');
    valeInput = document.getElementById('vale');
    dailyLog = document.getElementById('daily-log');
    dailyLogPlaceholder = document.getElementById('daily-log-placeholder');
    transactionForm = { 
        clientName: document.getElementById('clientName'), serviceDescription: document.getElementById('serviceDescription'), serviceValue: document.getElementById('serviceValue'), paymentMethod: document.getElementById('paymentMethod'), productDescription: document.getElementById('productDescription'), productsSold: document.getElementById('productsSold'), productSaleValue: document.getElementById('productSaleValue'), productPaymentMethod: document.getElementById('productPaymentMethod'), clientNamePlan: document.getElementById('clientNamePlan'), planSaleValue: document.getElementById('planSaleValue'), planSaleType: document.getElementById('planSaleType'), planSalePaymentMethod: document.getElementById('planSalePaymentMethod')  
    };
    editModal = document.getElementById('edit-modal');
    closeEditModalBtn = document.getElementById('close-edit-modal-btn');
    saveEditBtn = document.getElementById('saveEditBtn');
    editTransactionForm = { 
        clientName: document.getElementById('editClientName'), serviceDescription: document.getElementById('editServiceDescription'), serviceValue: document.getElementById('editServiceValue'), paymentMethod: document.getElementById('editPaymentMethod'), productDescription: document.getElementById('editProductDescription'), productsSold: document.getElementById('editProductsSold'), productSaleValue: document.getElementById('editProductSaleValue'), productPaymentMethod: document.getElementById('editProductPaymentMethod'), clientNamePlan: document.getElementById('editClientNamePlan'), planSaleValue: document.getElementById('editPlanSaleValue'), planSaleType: document.getElementById('editPlanSaleType'), planSalePaymentMethod: document.getElementById('editPlanSalePaymentMethod')  
    };
    closeWeekBtn = document.getElementById('closeWeekBtn');
    currentWeekSpan = document.getElementById('currentWeek');
    historyTableBody = document.getElementById('historyTableBody');
    historyPlaceholder = document.getElementById('historyPlaceholder');
    summarySpans = { faturamentoBruto: document.getElementById('faturamentoBruto'), comissaoServicos: document.getElementById('comissaoServicos'), comissaoProdutos: document.getElementById('comissaoProdutos'), subtotalComissao: document.getElementById('subtotalComissao'), descontoVale: document.getElementById('descontoVale'), comissaoFinal: document.getElementById('comissaoFinal') };
    adminReportSection = document.getElementById('admin-report-section');
    adminReportSpans = { faturamentoTotal: document.getElementById('reportFaturamentoTotal'), dinheiro: document.getElementById('reportDinheiro'), pix: document.getElementById('reportPix'), debito: document.getElementById('reportDebito'), credito: document.getElementById('reportCredito'), qtdAssinaturas: document.getElementById('reportQtdAssinaturas'), valorAssinaturas: document.getElementById('reportValorAssinaturas'), qtdCartaoPresente: document.getElementById('reportQtdCartaoPresente'), valorCartaoPresente: document.getElementById('reportValorCartaoPresente'), reportFaturamentoDiarioDinheiro: document.getElementById('reportFaturamentoDiarioDinheiro'), reportFaturamentoDiarioPix: document.getElementById('reportFaturamentoDiarioPix'), reportFaturamentoDiarioDebito: document.getElementById('reportFaturamentoDiarioDebito'), reportFaturamentoDiarioCredito: document.getElementById('reportFaturamentoDiarioCredito'), reportFaturamentoDiarioTotal: document.getElementById('reportFaturamentoDiarioTotal') };
    detalheAssinaturas = document.getElementById('detalheAssinaturas');
    detalheCartaoPresente = document.getElementById('detalheCartaoPresente');
    detalheDinheiro = document.getElementById('detalheDinheiro');
    detalhePix = document.getElementById('detalhePix');
    detalheDebito = document.getElementById('detalheDebito');
    detalheCredito = document.getElementById('detalheCredito');
    detalheTotalProdutos = document.getElementById('detalheTotalProdutos');
    barberDetailsSection = document.getElementById('barberDetailsSection');
    reportComissaoAssinaturasCartao = document.getElementById('reportComissaoAssinaturasCartao');
    barberRankingList = document.getElementById('barberRankingList');
    loja01DailyDinheiro = document.getElementById('loja01DailyDinheiro');
    loja01DailyPix = document.getElementById('loja01DailyPix');
    loja01DailyDebito = document.getElementById('loja01DailyDebito');
    loja01DailyCredito = document.getElementById('loja01DailyCredito');
    loja01WeeklyTotal = document.getElementById('loja01WeeklyTotal');
    loja02DailyDinheiro = document.getElementById('loja02DailyDinheiro');
    loja02DailyPix = document.getElementById('loja02DailyPix');
    loja02DailyDebito = document.getElementById('loja02DailyDebito');
    loja02DailyCredito = document.getElementById('loja02DailyCredito');
    loja02WeeklyTotal = document.getElementById('loja02WeeklyTotal');
    comissaoAssinaturas = document.getElementById('comissaoAssinaturas');
    comissaoCartaoPresente = document.getElementById('comissaoCartaoPresente');
    loja01DailyTotal = document.getElementById('loja01DailyTotal');
    loja02DailyTotal = document.getElementById('loja02DailyTotal');
  }
  
  async function initializeAppAndAuth() {
    try {
      const app = initializeApp(firebaseConfig);
      db = getFirestore(app);
      const auth = getAuth(app);
      
      onAuthStateChanged(auth, (user) => {
        if (user) {
          const userEmail = user.email.toLowerCase();
          const userInfo = users[userEmail];
          if (userInfo) {
              loggedInUser = { ...userInfo, uid: user.uid };
              loginScreen.classList.add('hidden');
              appContainer.classList.remove('hidden');
              setupUIForUser();
          } else {
              console.error("Usuário logado no Firebase, mas não encontrado na lista local:", userEmail);
              auth.signOut();
          }
        } else {
          loggedInUser = null;
          loginScreen.classList.remove('hidden');
          appContainer.classList.add('hidden');
          if (unsubscribeWeeklyData) unsubscribeWeeklyData();
          if (unsubscribeHistory) unsubscribeHistory();
        }
      });
      currentWeekId = getWeekId(new Date());
      initializeDOMReferences();
      setupLogin();
    } catch (error) {
      console.error("Firebase Init Error:", error);
      alert("ERRO CRÍTICO: Não foi possível inicializar o Firebase. Detalhes: " + error.message);
    }
  }
  
  async function handleLogin() {
    const email = emailInput.value.toLowerCase().trim();
    const password = passwordInput.value;
    const auth = getAuth();
    if (!email || !password) {
      alert("Por favor, preencha o e-mail e a senha.");
      return;
    }
    try {
      await signInWithEmailAndPassword(auth, email, password);
    } catch (error) {
      console.error("Login Error:", error.code);
      alert("Email ou senha inválidos. Verifique os dados.");
    }
  }

  function setupLogin() {
    loginBtn.addEventListener('click', handleLogin);
    passwordInput.addEventListener('keyup', (event) => {
      if (event.key === 'Enter') {
        handleLogin();
      }
    });
  }
  
  function setupUIForUser() {
    welcomeMessage.textContent = `Bem-vindo(a), ${loggedInUser.name}!`;
    if (loggedInUser.role === 'admin') {
      adminSelectorContainer.classList.remove('hidden');
      adminReportSection.classList.remove('hidden');
      listenToAdminReportData();
      barberDetailsSection.classList.add('hidden');
      setupAdminBarberSelector();
    } else { 
      adminReportSection.classList.add('hidden'); 
      if (loggedInUser.canViewBarbers && loggedInUser.canViewBarbers.length > 0) {
        adminSelectorContainer.classList.remove('hidden');
        barberDetailsSection.classList.remove('hidden');
        setupLeaderBarberSelector();
      } else {
        adminSelectorContainer.classList.add('hidden');
        barberDetailsSection.classList.remove('hidden');
        selectedBarberId = loggedInUser.barberId;
        mainContent.classList.remove('hidden');
        historySection.classList.remove('hidden');
        startListeners();
      }
    }
    setupCommonUI();
  }

  function setupAdminBarberSelector() {
    barberSelector.innerHTML = '<option value="">-- Visão Geral / Selecione um funcionário --</option>';
    const sortedBarbers = Object.values(users)
        .filter(u => u.role === 'barber')
        .sort((a, b) => a.name.localeCompare(b.name));
    
    sortedBarbers.forEach(barber => {
        barberSelector.innerHTML += `<option value="${barber.barberId}">${barber.name}</option>`;
    });

    barberSelector.addEventListener('change', () => {
      selectedBarberId = barberSelector.value;
      if (selectedBarberId) {
        mainContent.classList.remove('hidden');
        historySection.classList.remove('hidden');
        barberDetailsSection.classList.remove('hidden'); 
        startListeners();
      } else {
        mainContent.classList.add('hidden');
        historySection.classList.add('hidden');
        barberDetailsSection.classList.add('hidden'); 
        if (unsubscribeWeeklyData) unsubscribeWeeklyData();
        if (unsubscribeHistory) unsubscribeHistory();
      }
    });
  }

  function setupLeaderBarberSelector() {
    barberSelector.innerHTML = `<option value="${loggedInUser.barberId}">Minha Visão (${loggedInUser.name})</option>`;
    loggedInUser.canViewBarbers.forEach(barberIdToView => {
        const barberInfo = Object.values(users).find(u => u.barberId === barberIdToView);
        if (barberInfo) {
            barberSelector.innerHTML += `<option value="${barberInfo.barberId}">${barberInfo.name}</option>`;
        }
    });
    selectedBarberId = loggedInUser.barberId;
    mainContent.classList.remove('hidden');
    historySection.classList.remove('hidden');
    startListeners();
    barberSelector.addEventListener('change', () => {
      selectedBarberId = barberSelector.value;
      startListeners();
    });
  }

  function setupCommonUI() {
    daySelector.innerHTML = Object.entries(weekDays).map(([dayIndex, dayName]) =>
      `<button class="day-btn p-2 rounded-md bg-gray-700 hover:bg-gray-600 transition" data-day-index="${dayIndex}">${dayName}</button>`
    ).join('');

    const todayIndex = new Date().getDay();
    selectedDay = (todayIndex >= 2 && todayIndex <= 6) ? todayIndex : 2; 
    updateDaySelection(); 
    daySelector.querySelectorAll('.day-btn').forEach(btn => {
      btn.addEventListener('click', () => {
        selectedDay = parseInt(btn.dataset.dayIndex);
        updateDaySelection();
      });
    });
    const weekStartDate = new Date();
    weekStartDate.setDate(weekStartDate.getDate() - (weekStartDate.getDay() - 2 + 7) % 7);
    const weekEndDate = new Date(weekStartDate);
    weekEndDate.setDate(weekEndDate.getDate() + 4);
    currentWeekSpan.textContent = `Semana: ${weekStartDate.toLocaleDateString('pt-BR')} - ${weekEndDate.toLocaleDateString('pt-BR')}`;
    addServiceTransactionBtn.addEventListener('click', () => addTransaction('service'));
    addProductTransactionBtn.addEventListener('click', () => addTransaction('product'));
    addPlanTransactionBtn.addEventListener('click', () => addTransaction('plan'));
    saveValeBtn.addEventListener('click', saveVale);
    closeWeekBtn.addEventListener('click', closeWeek);
    closeEditModalBtn.addEventListener('click', () => { editModal.classList.add('hidden'); editModal.classList.remove('flex'); });
    saveEditBtn.addEventListener('click', saveEditedTransaction);
  }

  function startListeners() {
    if (unsubscribeWeeklyData) unsubscribeWeeklyData();
    if (unsubscribeHistory) unsubscribeHistory();
    listenToWeeklyData();
    listenToClosingsHistory();
  }

  function updateInputState() {
      const currentDayIndex = new Date().getDay();
      const isTodayOrFuture = selectedDay >= currentDayIndex;
      const isAdmin = loggedInUser.role === 'admin';
      const canEdit = isAdmin || isTodayOrFuture;
      const inputs = document.querySelectorAll('#transaction-form input, #transaction-form select, #vale');
      const buttons = document.querySelectorAll('#addServiceTransactionBtn, #addProductTransactionBtn, #addPlanTransactionBtn, #saveValeBtn');
      inputs.forEach(el => el.disabled = !canEdit);
      buttons.forEach(el => el.disabled = !canEdit);
  }

  function updateDaySelection() {
    daySelector.querySelectorAll('.day-btn').forEach(btn => {
      btn.classList.toggle('active', parseInt(btn.dataset.dayIndex) === selectedDay);
    });
    calculateWeeklySummary(); 
    renderDailyLog();
    updateInputState();
  }

  function renderDailyLog() {
    const dayKey = weekDays[selectedDay];
    const dayData = weeklyData[dayKey] || { transactions: [], vale: 0 };
    const transactions = dayData.transactions || [];
    const currentDayIndex = new Date().getDay();
    const isTodayOrFuture = selectedDay >= currentDayIndex;
    const canEdit = loggedInUser.role === 'admin' || isTodayOrFuture;
    dailyLog.innerHTML = '';
    if (transactions.length === 0) {
      dailyLog.appendChild(dailyLogPlaceholder);
      dailyLogPlaceholder.style.display = 'block';
    } else {
      dailyLogPlaceholder.style.display = 'none';
      transactions.forEach(t => {
        const item = document.createElement('div');
        item.className = 'transaction-item bg-gray-600/50 p-3 rounded-md flex justify-between items-center';
        let descriptionHtml = '';
        if (t.serviceDescription && t.value > 0) { descriptionHtml += `<p class="font-semibold">${t.serviceDescription} <span class="text-cyan-400">${formatCurrency(t.value)}</span> <span class="text-gray-400">(${t.paymentMethod})</span></p>`; }
        if (t.productDescription && t.products > 0) {
            let prefix = (t.serviceDescription && t.value > 0) ? `<p class="text-sm text-gray-400 mt-1">` : `<p class="font-semibold">`;
            descriptionHtml += `${prefix}Produto: ${t.productDescription} <span class="text-cyan-400">(${t.products} unid.)</span>`;
            if (t.productSaleValue > 0) descriptionHtml += ` <span class="text-cyan-400">${formatCurrency(t.productSaleValue)}</span>`;
            if (t.productPaymentMethod) descriptionHtml += ` <span class="text-gray-400">(${t.productPaymentMethod})</span>`;
            descriptionHtml += `</p>`;
        }
        if (t.planSaleType && t.planSaleValue > 0) {
            let planSaleText = `Venda de ${t.planSaleType}`;
            if (t.clientNamePlan) planSaleText += ` para ${t.clientNamePlan}`; 
            let prefix = ((t.serviceDescription && t.value > 0) || (t.productDescription && t.products > 0)) ? `<p class="text-sm text-purple-400 mt-1">` : `<p class="font-semibold text-purple-400">`;
            descriptionHtml += `${prefix}${planSaleText} <span class="text-cyan-400">${formatCurrency(t.planSaleValue)}</span> <span class="text-gray-400">(${t.planSalePaymentMethod})</span></p>`;
        }
        if (t.clientName && !t.clientNamePlan) { descriptionHtml += `<p class="text-xs text-gray-500">Cliente: ${t.clientName}</p>`; }
        item.innerHTML = `<div>${descriptionHtml}</div><div class="flex items-center gap-3 ${canEdit ? '' : 'hidden'}"><button class="action-btn edit-btn text-blue-400 hover:text-blue-300" data-id="${t.id}"><i class="fa-solid fa-pencil"></i></button><button class="action-btn delete-btn text-red-500 hover:text-red-400" data-id="${t.id}" data-transaction-day-index="${selectedDay}"><i class="fa-solid fa-trash"></i></button></div>`;
        dailyLog.appendChild(item);
      });
    }
    dailyLog.querySelectorAll('.delete-btn').forEach(btn => btn.addEventListener('click', (event) => deleteTransaction(event.currentTarget.dataset.id, parseInt(event.currentTarget.dataset.transactionDayIndex))));
    dailyLog.querySelectorAll('.edit-btn').forEach(btn => btn.addEventListener('click', () => openEditModal(btn.dataset.id)));
    valeInput.value = dayData.vale || '';
  }

  async function updateFirestoreData(newData) {
    if (!selectedBarberId) return;
    try {
      const docRef = doc(db, "barbers", selectedBarberId, "weekly_entries", currentWeekId);
      await setDoc(docRef, newData, { merge: true });
    } catch (error) {
      console.error("Error updating Firestore:", error);
      alert("ERRO AO SALVAR DADOS: " + error.message);
    }
  }

  async function addTransaction(type) {
    // ... (lógica de validação)
    let newTransaction = { id: crypto.randomUUID() };
    // ... (lógica para preencher newTransaction)
    const dayKey = weekDays[selectedDay];
    const updatedData = JSON.parse(JSON.stringify(weeklyData));
    if (!updatedData[dayKey]) updatedData[dayKey] = { transactions: [], vale: 0 };
    updatedData[dayKey].transactions.push(newTransaction);
    await updateFirestoreData(updatedData);
  }

  async function deleteTransaction(transactionId, transactionDayIndex) {
    // ... (lógica de validação)
    if (!confirm("Tem certeza que deseja apagar este lançamento?")) return;
    const dayKey = weekDays[transactionDayIndex];
    const updatedData = JSON.parse(JSON.stringify(weeklyData));
    if (updatedData[dayKey]?.transactions) {
      updatedData[dayKey].transactions = updatedData[dayKey].transactions.filter(t => t.id !== transactionId);
      await updateFirestoreData(updatedData);
    }
  }

  function openEditModal(transactionId) {
    // ... (lógica de validação)
    currentEditingTransactionId = transactionId;
    // ... (lógica para preencher o formulário)
    editModal.classList.remove('hidden');
    editModal.classList.add('flex');
  }

  async function saveEditedTransaction() {
    // ... (lógica de validação)
    const dayKey = weekDays[selectedDay];
    const updatedData = JSON.parse(JSON.stringify(weeklyData));
    const transactionIndex = updatedData[dayKey]?.transactions.findIndex(t => t.id === currentEditingTransactionId);
    if (transactionIndex > -1) {
      // ... (lógica para criar o updatedTransaction)
      updatedData[dayKey].transactions[transactionIndex] = updatedTransaction;
      await updateFirestoreData(updatedData);
    }
    editModal.classList.add('hidden');
    editModal.classList.remove('flex');
  }

  async function saveVale() {
    // ... (lógica de validação)
    const dayKey = weekDays[selectedDay];
    const vale = parseFloat(valeInput.value) || 0;
    const updatedData = JSON.parse(JSON.stringify(weeklyData));
    if (!updatedData[dayKey]) updatedData[dayKey] = { transactions: [], vale: 0 };
    updatedData[dayKey].vale = vale;
    await updateFirestoreData(updatedData);
    alert("Vale salvo com sucesso!");
  }

  function listenToWeeklyData() {
    if (!selectedBarberId) return;
    const docRef = doc(db, "barbers", selectedBarberId, "weekly_entries", currentWeekId);
    if (unsubscribeWeeklyData) unsubscribeWeeklyData();
    unsubscribeWeeklyData = onSnapshot(docRef, (docSnap) => {
      weeklyData = docSnap.exists() ? docSnap.data() : {};
      renderDailyLog();
      calculateWeeklySummary();
    }, (error) => {
      console.error("Erro ao ouvir dados semanais:", error);
    });
  }

  function calculateWeeklySummary() {
    // ... (sua lógica de cálculo aqui, que parece correta)
  }

  function listenToAdminReportData() {
    const weeklyEntriesQuery = query(collectionGroup(db, 'weekly_entries'));
    unsubscribeWeeklyEntriesAdmin = onSnapshot(weeklyEntriesQuery, (snapshot) => {
        const allEntriesData = snapshot.docs.map(doc => ({ id: doc.id, barberId: doc.ref.parent.parent.id, data: doc.data() }));
        calculateAdminReport(allEntriesData);
    }, (error) => { console.error("Erro ao ouvir entradas semanais (admin):", error); });
  }

  function calculateAdminReport(allEntriesData) {
    const totals = { faturamentoTotalCurrentWeek: 0, dinheiro: 0, pix: 0, debito: 0, credito: 0, qtdAssinaturas: 0, valorAssinaturas: 0, qtdCartaoPresente: 0, valorCartaoPresente: 0, comissaoAssinaturasCartao: 0, faturamentoDiarioDinheiro: 0, faturamentoDiarioPix: 0, faturamentoDiarioDebito: 0, faturamentoDiarioCredito: 0, loja01DailyDinheiro: 0, loja01DailyPix: 0, loja01DailyDebito: 0, loja01DailyCredito: 0, loja01WeeklyTotal: 0, loja02DailyDinheiro: 0, loja02DailyPix: 0, loja02DailyDebito: 0, loja02DailyCredito: 0, loja02WeeklyTotal: 0 };
    const barberWeeklyRevenue = {};
    const today = new Date();
    const currentDayOfWeek = today.getDay();
    const currentDayKey = weekDays[currentDayOfWeek];
    const currentWeekIdCalculated = getWeekId(today);
    const barberNames = Object.fromEntries(Object.values(users).map(u => [u.barberId, u.name]));

    allEntriesData.filter(item => item.id === currentWeekIdCalculated).forEach(item => {
        const { barberId, data: weeklyTransactionsByDay } = item;
        const barberStore = barberStoreMap[barberId];
        if (!barberStore) return; // Pula se o barbeiro não estiver no mapa de lojas
        if (!barberWeeklyRevenue[barberId]) barberWeeklyRevenue[barberId] = 0;
        
        Object.entries(weeklyTransactionsByDay).forEach(([dayKey, dayData]) => {
            const isToday = dayKey === currentDayKey;
            dayData.transactions?.forEach(t => {
                let revenue = 0;
                let isFaturamentoReal = false;
                let paymentMethod = '';

                if (t.value > 0) {
                    revenue += t.value;
                    if(t.paymentMethod !== 'Assinatura' && t.paymentMethod !== 'Cartão Presente') isFaturamentoReal = true;
                    paymentMethod = t.paymentMethod;
                }
                if (t.productSaleValue > 0) { revenue += t.productSaleValue; isFaturamentoReal = true; paymentMethod = t.productPaymentMethod; }
                if (t.planSaleValue > 0) { revenue += t.planSaleValue; isFaturamentoReal = true; paymentMethod = t.planSalePaymentMethod; }
                
                barberWeeklyRevenue[barberId] += revenue;
                if (isFaturamentoReal) totals.faturamentoTotalCurrentWeek += revenue;
                
                if (barberStore === 'loja01') totals.loja01WeeklyTotal += revenue;
                else if (barberStore === 'loja02') totals.loja02WeeklyTotal += revenue;
                
                if (isToday) {
                    if (paymentMethod === 'Dinheiro') { totals.faturamentoDiarioDinheiro += revenue; if(barberStore === 'loja01') totals.loja01DailyDinheiro += revenue; else totals.loja02DailyDinheiro += revenue; }
                    if (paymentMethod === 'Pix') { totals.faturamentoDiarioPix += revenue; if(barberStore === 'loja01') totals.loja01DailyPix += revenue; else totals.loja02DailyPix += revenue; }
                    if (paymentMethod === 'Débito') { totals.faturamentoDiarioDebito += revenue; if(barberStore === 'loja01') totals.loja01DailyDebito += revenue; else totals.loja02DailyDebito += revenue; }
                    if (paymentMethod === 'Crédito') { totals.faturamentoDiarioCredito += revenue; if(barberStore === 'loja01') totals.loja01DailyCredito += revenue; else totals.loja02DailyCredito += revenue; }
                }
            });
        });
    });

    adminReportSpans.faturamentoTotal.textContent = formatCurrency(totals.faturamentoTotalCurrentWeek);
    loja01WeeklyTotal.textContent = formatCurrency(totals.loja01WeeklyTotal);
    loja02WeeklyTotal.textContent = formatCurrency(totals.loja02WeeklyTotal);

    loja01DailyDinheiro.textContent = formatCurrency(totals.loja01DailyDinheiro);
    loja01DailyPix.textContent = formatCurrency(totals.loja01DailyPix);
    loja01DailyDebito.textContent = formatCurrency(totals.loja01DailyDebito);
    loja01DailyCredito.textContent = formatCurrency(totals.loja01DailyCredito);
    loja01DailyTotal.textContent = formatCurrency(totals.loja01DailyDinheiro + totals.loja01DailyPix + totals.loja01DailyDebito + totals.loja01DailyCredito);

    loja02DailyDinheiro.textContent = formatCurrency(totals.loja02DailyDinheiro);
    loja02DailyPix.textContent = formatCurrency(totals.loja02DailyPix);
    loja02DailyDebito.textContent = formatCurrency(totals.loja02DailyDebito);
    loja02DailyCredito.textContent = formatCurrency(totals.loja02DailyCredito);
    loja02DailyTotal.textContent = formatCurrency(totals.loja02DailyDinheiro + totals.loja02DailyPix + totals.loja02DailyDebito + totals.loja02DailyCredito);

    const rankedBarbersWeekly = Object.entries(barberWeeklyRevenue).map(([barberId, revenue]) => ({ name: barberNames[barberId] || 'Desconhecido', revenue })).sort((a, b) => b.revenue - a.revenue);
    barberRankingList.innerHTML = rankedBarbersWeekly.length ? rankedBarbersWeekly.map((b, i) => `<div class="flex justify-between items-center bg-gray-700/50 p-3 rounded-md"><span>${i+1}. ${b.name}</span><span class="font-bold text-lg text-green-400">${formatCurrency(b.revenue)}</span></div>`).join('') : '<p class="text-gray-500 text-center">Nenhum faturamento.</p>';
  }

  async function closeWeek() {
    // ...
  }

  function listenToClosingsHistory() {
    // ...
  }

  document.addEventListener('DOMContentLoaded', initializeAppAndAuth);
</script>
</body>
</html>
