<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Calculadora de Comiss√£o Semanal - Barbearia</title>
<script src="https://cdn.tailwindcss.com"></script>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" integrity="sha512-iecdLmaskl7CVkqkXNQ/ZH/XLlvWZOJyj7Yy7tcenmpD1ypASozpmT/E0iPtmFIB46ZmdtAc9eNBvH0H/ZpiBw==" crossorigin="anonymous" referrerpolicy="no-referrer" />
<style>
  body { font-family: 'Inter', sans-serif; }
  .day-btn.active { background-color: #0891b2; color: white; }
  .transaction-item:hover .action-btn { opacity: 1; }
  .action-btn { opacity: 0; transition: opacity 0.2s ease-in-out; }
  .modal-backdrop { background-color: rgba(0,0,0,0.5); transition: opacity 0.3s ease; }
  input:disabled, select:disabled, button:disabled { background-color: #4a5568 !important; cursor: not-allowed; opacity: 0.6; }
</style>
</head>
<body class="bg-gray-900 text-white antialiased">

<!-- Tela de Login -->
<div id="login-screen" class="min-h-screen flex items-center justify-center">
  <div class="bg-gray-800 p-8 rounded-xl shadow-lg border border-gray-700 w-full max-w-sm">
    <h2 class="text-3xl font-bold text-center text-cyan-400 mb-6">Barber<span class="text-white">Commission</span></h2>
    <div class="space-y-4">
      <div>
        <label for="email" class="block text-sm font-medium text-gray-300 mb-1">Email</label>
        <input type="email" id="email" class="w-full bg-gray-700 border border-gray-600 rounded-md px-3 py-2 focus:ring-2 focus:ring-cyan-500 transition" placeholder="seu@email.com">
      </div>
      <div>
        <label for="password" class="block text-sm font-medium text-gray-300 mb-1">Senha</label>
        <input type="password" id="password" class="w-full bg-gray-700 border border-gray-600 rounded-md px-3 py-2 focus:ring-2 focus:ring-cyan-500 transition" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢">
      </div>
      <button id="loginBtn" class="w-full bg-cyan-600 hover:bg-cyan-700 text-white font-bold py-2 px-4 rounded-md transition duration-300">Entrar</button>
    </div>
  </div>
</div>

<!-- Container Principal do App -->
<div id="app-container" class="hidden">
  <div class="container mx-auto p-4 md:p-8 max-w-7xl">
    <header class="text-center mb-6">
      <h1 class="text-4xl font-bold text-cyan-400">Barber<span class="text-white">Commission</span></h1>
      <p class="text-gray-400 mt-2">Fechamento de comiss√£o semanal (Ter√ßa a S√°bado)</p>
      <p id="currentWeek" class="text-cyan-500 font-semibold mt-2"></p>
      <p id="welcomeMessage" class="text-white mt-2"></p>
    </header>

    <div id="admin-report-section" class="hidden bg-gray-800 p-6 rounded-xl shadow-lg border border-gray-700 mb-8">
        <h2 class="text-2xl font-semibold mb-4 text-center text-cyan-400">üìä Relat√≥rio Geral da Barbearia</h2>
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 text-center">
            <div class="lg:col-span-2 bg-gray-700 p-4 rounded-lg">
                <h3 class="text-lg font-medium text-gray-300 mt-4 mb-2">Faturamento Semanal - Loja 01</h3>
                <p id="loja01WeeklyTotal" class="text-2xl font-bold text-blue-400">R$ 0,00</p>
            </div>
            <div class="lg:col-span-2 bg-gray-700 p-4 rounded-lg">
                <h3 class="text-lg font-medium text-gray-300 mt-4 mb-2">Faturamento Semanal - Loja 02</h3>
                <p id="loja02WeeklyTotal" class="text-2xl font-bold text-yellow-400">R$ 0,00</p>
            </div>
            <div class="lg:col-span-2 bg-gray-700 p-4 rounded-lg">
                <h3 class="text-lg font-medium text-gray-300 mb-2">Faturamento Di√°rio - Loja 01 (Hoje)</h3>
                <p id="loja01DailyTotal" class="text-xl font-bold text-blue-400">R$ 0,00</p>
            </div>
            <div class="lg:col-span-2 bg-gray-700 p-4 rounded-lg">
                <h3 class="text-lg font-medium text-gray-300 mb-2">Faturamento Di√°rio - Loja 02 (Hoje)</h3>
                <p id="loja02DailyTotal" class="text-xl font-bold text-yellow-400">R$ 0,00</p>
            </div>
            <div class="lg:col-span-4 bg-gray-700 p-4 rounded-lg flex flex-col">
                <h3 class="text-lg font-medium text-gray-300 mb-2">Ranking de Faturamento (Semanal)</h3>
                <div id="barberRankingList" class="space-y-2 flex-grow overflow-y-auto"></div>
            </div>
        </div>
    </div>

    <div id="admin-selector-container" class="max-w-md mx-auto mb-8 hidden">
        <label for="barberSelector" class="block text-center text-lg font-medium text-gray-300 mb-2">Selecione o Funcion√°rio</label>
        <select id="barberSelector" class="w-full bg-gray-700 border border-gray-600 rounded-md px-3 py-3 text-lg focus:ring-2 focus:ring-cyan-500 transition"></select>
    </div>

    <div id="main-content" class="grid grid-cols-1 lg:grid-cols-5 gap-8 hidden">
        <div class="lg:col-span-3 flex flex-col gap-6">
            <div class="bg-gray-800 p-6 rounded-xl shadow-lg border border-gray-700">
                <h2 class="text-2xl font-semibold mb-4">Lan√ßamentos da Semana</h2>
                <div id="day-selector" class="grid grid-cols-3 sm:grid-cols-5 gap-2 mb-6"></div>
                <div id="transaction-form" class="bg-gray-700/50 p-4 rounded-lg space-y-4">
                    <h3 class="font-semibold text-lg mb-3">Adicionar Lan√ßamento</h3>
                    <div class="bg-gray-700/70 p-4 rounded-lg space-y-3 border border-gray-600">
                        <h4 class="font-semibold text-md text-cyan-300">Venda de Servi√ßo</h4>
                        <input type="text" id="clientName" placeholder="Nome do Cliente (opcional)" class="entry-input w-full bg-gray-600 border border-gray-500 rounded-md px-3 py-2">
                        <input type="text" id="serviceDescription" placeholder="Descri√ß√£o do Servi√ßo" class="entry-input w-full bg-gray-600 border border-gray-500 rounded-md px-3 py-2">
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <input type="number" id="serviceValue" placeholder="Valor do Servi√ßo (R$)" class="entry-input w-full bg-gray-600 border border-gray-500 rounded-md px-3 py-2">
                            <select id="paymentMethod" class="entry-input w-full bg-gray-600 border border-gray-500 rounded-md px-3 py-2">
                                <option value="Dinheiro">Dinheiro</option>
                                <option value="Pix">Pix</option>
                                <option value="D√©bito">D√©bito</option>
                                <option value="Cr√©dito">Cr√©dito</option>
                                <option value="Assinatura">Assinatura</option>
                                <option value="Cart√£o Presente">Cart√£o Presente</option>
                            </select>
                        </div>
                        <button id="addServiceTransactionBtn" class="w-full bg-cyan-600 hover:bg-cyan-700 text-white font-bold py-2 px-4 rounded-md transition duration-300 flex items-center justify-center gap-2">
                            <i class="fa-solid fa-plus"></i> Adicionar Servi√ßo
                        </button>
                    </div>
                </div>
                <div class="mt-6">
                    <h3 class="font-semibold text-lg mb-2">Atividade do Dia</h3>
                    <div id="daily-log" class="space-y-2 max-h-96 overflow-y-auto pr-2">
                        <p id="daily-log-placeholder" class="text-gray-500 text-center p-4">Nenhum lan√ßamento para este dia.</p>
                    </div>
                    <div class="relative mt-4">
                        <label for="vale" class="block text-sm font-medium text-yellow-400 mb-1">Registrar Vale para o Dia</label>
                        <div class="flex gap-2">
                            <input type="number" id="vale" placeholder="Valor do Vale (R$)" class="entry-input w-full bg-gray-700 border border-gray-600 rounded-md px-3 py-2">
                            <button id="saveValeBtn" class="bg-yellow-600 hover:bg-yellow-700 text-white font-bold py-2 px-4 rounded-md transition">Salvar</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="lg:col-span-2">
            <div class="bg-gray-800 p-6 rounded-xl shadow-lg border border-gray-700 sticky top-8">
                <h2 class="text-2xl font-semibold mb-4">Resumo da Semana</h2>
                <div class="space-y-3">
                    <div class="flex justify-between items-center bg-gray-900 p-3 rounded-lg">
                        <span class="font-medium text-gray-300">Faturamento Bruto:</span>
                        <span id="faturamentoBruto" class="text-xl font-bold text-cyan-400">R$ 0,00</span>
                    </div>
                    <div class="flex justify-between items-center p-2">
                        <span class="text-gray-400">Comiss√£o Servi√ßos:</span>
                        <span id="comissaoServicos">R$ 0,00</span>
                    </div>
                    <div class="flex justify-between items-center p-2">
                        <span class="text-gray-400">Comiss√£o Assinaturas:</span>
                        <span id="comissaoAssinaturas">R$ 0,00</span>
                    </div>
                    <div class="flex justify-between items-center p-2">
                        <span class="text-gray-400">Comiss√£o Cart√£o Presente:</span>
                        <span id="comissaoCartaoPresente">R$ 0,00</span>
                    </div>
                    <div class="flex justify-between items-center p-2 font-medium">
                        <span class="text-gray-300">Subtotal Comiss√£o:</span>
                        <span id="subtotalComissao">R$ 0,00</span>
                    </div>
                    <div class="flex justify-between items-center p-2">
                        <span class="text-yellow-400">Total de Vales:</span>
                        <span id="descontoVale" class="text-yellow-400">- R$ 0,00</span>
                    </div>
                    <hr class="border-gray-600"/>
                    <div class="flex justify-between items-center bg-green-900/50 p-4 rounded-lg mt-2">
                        <span class="text-lg font-medium text-white">Comiss√£o a Pagar:</span>
                        <span id="comissaoFinal" class="text-2xl font-bold text-green-400">R$ 0,00</span>
                    </div>
                </div>
                <button id="closeWeekBtn" class="mt-6 w-full bg-green-600 hover:bg-green-700 text-white font-bold py-3 px-4 rounded-md transition duration-300 flex items-center justify-center gap-2">
                    <i class="fa-solid fa-lock"></i> Encerrar e Pagar Semana
                </button>
            </div>
        </div>
    </div>
  </div>
</div>

<!-- =================== C√ìDIGO JAVASCRIPT ================== -->
<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
  import { getAuth, signInWithEmailAndPassword, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
  import { getFirestore, doc, setDoc, onSnapshot, collection, addDoc, serverTimestamp, query, deleteDoc, getDocs, collectionGroup } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

  // --- CONFIGURA√á√ÉO E DADOS GLOBAIS ---
  const firebaseConfig = { apiKey: "AIzaSyBCfdVci2RFEearjQzByEysTXtV6D4Tofs", authDomain: "comisao-dos-barbeiros.firebaseapp.com", projectId: "comisao-dos-barbeiros", storageBucket: "comisao-dos-barbeiros.firebasestorage.app", messagingSenderId: "571199864529", appId: "1:571199864529:web:0ea9584c0c5372192e4ff0" };
  const users = {
    "admin@exemplo.com": { password: "753951", role: "admin", name: "Admin", email: "admin@exemplo.com", barberId: "1DlWcbIq0ANITQiquGcTV5RzY7y2" },
    "adrianopessanha@exemplo.com": { password: "123456", role: "barber", name: "Adriano Pessanha", email: "adrianopessanha@exemplo.com", barberId: "mZAck0O4a6Ts2VUSSV75OHauzMG3" },
    "rodrigo@exemplo.com": { password: "123456", role: "barber", name: "Rodrigo Azevedo", email: "rodrigo@exemplo.com", barberId: "zs99mAYa5eNKoEPh56qINO8w7J22", canViewBarbers: ["hTaN1vL0afbINmeOjdbQJ13sJPg1", "xfk8NmhR9haZwjmagOAeYXCU9PY2"] },
    "veloso@exemplo.com": { password: "123456", role: "barber", name: "Veloso", email: "veloso@exemplo.com", barberId: "hTaN1vL0afbINmeOjdbQJ13sJPg1" },
    "wellington@exemplo.com": { password: "123456", role: "barber", name: "Wellington", email: "wellington@exemplo.com", barberId: "HE7OZUptfdVbN8QmUaGzYgRUWrU2" },
    "jonata@exemplo.com": { password: "123456", role: "barber", name: "Jonata Silva", email: "jonata@exemplo.com", barberId: "q0v1NPLF6jVrqWvPgTkiJBLcq242" },
    "mauro@exemplo.com": { password: "123456", role: "barber", name: "Mauro", email: "mauro@exemplo.com", barberId: "xfk8NmhR9haZwjmagOAeYXCU9PY2" }
  };
  const barberStoreMap = { "mZAck0O4a6Ts2VUSSV75OHauzMG3": "loja02", "zs99mAYa5eNKoEPh56qINO8w7J22": "loja01", "hTaN1vL0afbINmeOjdbQJ13sJPg1": "loja01", "HE7OZUptfdVbN8QmUaGzYgRUWrU2": "loja02", "q0v1NPLF6jVrqWvPgTkiJBLcq242": "loja02", "xfk8NmhR9haZwjmagOAeYXCU9PY2": "loja01" };
  
  // --- VARI√ÅVEIS GLOBAIS ---
  let db, auth, loggedInUser, selectedBarberId, currentWeekId, selectedDay;
  let weeklyData = {};
  let unsubscribeWeeklyData = () => {}, unsubscribeHistory = () => {}, unsubscribeAdminReport = () => {};
  let elements = {};
  const weekDays = { 2: 'Ter√ßa', 3: 'Quarta', 4: 'Quinta', 5: 'Sexta', 6: 'S√°bado' };
  const formatCurrency = (value) => new Intl.NumberFormat('pt-BR', { style: 'currency', currency: 'BRL' }).format(value || 0);
  const getWeekId = (d=new Date()) => { d=new Date(Date.UTC(d.getFullYear(),d.getMonth(),d.getDate()));d.setUTCDate(d.getUTCDate()+4-(d.getUTCDay()||7));const y=new Date(Date.UTC(d.getUTCFullYear(),0,1));return `${d.getUTCFullYear()}-W${String(Math.ceil((((d-y)/864e5)+1)/7)).padStart(2,"0")}`};

  // --- PONTO DE ENTRADA ---
  document.addEventListener('DOMContentLoaded', main);

  function main() {
    try {
      const app = initializeApp(firebaseConfig);
      db = getFirestore(app);
      auth = getAuth(app);
      initializeDOMElements();
      setupLoginListeners();
      setupAuthListener();
      currentWeekId = getWeekId();
    } catch (error) {
      console.error("ERRO CR√çTICO:", error);
      alert("ERRO CR√çTICO: " + error.message);
    }
  }

  // --- FUN√á√ïES DE SETUP ---
  function initializeDOMElements() {
    const allIds = [ 'login-screen','app-container','loginBtn','email','password','barberSelector','admin-selector-container','welcomeMessage','main-content','history-section','day-selector','addServiceTransactionBtn','saveValeBtn','vale','daily-log','daily-log-placeholder','closeWeekBtn','currentWeek','historyTableBody','historyPlaceholder','admin-report-section','faturamentoBruto','comissaoServicos','comissaoAssinaturas','comissaoCartaoPresente','subtotalComissao','descontoVale','comissaoFinal', 'loja01WeeklyTotal', 'loja02WeeklyTotal', 'loja01DailyTotal', 'loja02DailyTotal', 'barberRankingList'];
    allIds.forEach(id => elements[id] = document.getElementById(id));
  }
  
  function setupLoginListeners() {
    elements.loginBtn.addEventListener('click', handleLogin);
    elements.password.addEventListener('keyup', (e) => e.key === 'Enter' && handleLogin());
  }

  // SUBSTITUA A SUA FUN√á√ÉO ANTIGA POR ESTA

function setupAuthListener() {
    onAuthStateChanged(auth, (user) => {
      if (user) {
        // Usu√°rio est√° logado no Firebase. Vamos encontrar suas informa√ß√µes.
        const loggedInEmail = user.email.toLowerCase();
        
        // *** ESTA √â A L√ìGICA DE BUSCA CORRIGIDA E MAIS ROBUSTA ***
        const userInfo = Object.values(users).find(u => u.email.toLowerCase() === loggedInEmail);

        if (userInfo) {
            // SUCESSO! Encontramos o usu√°rio na nossa lista.
            loggedInUser = { ...userInfo, uid: user.uid };
            elements.loginScreen.classList.add('hidden');
            elements.appContainer.classList.remove('hidden');
            setupUIForUser(); // Prepara a tela principal
        } else {
            // ERRO: O Firebase autenticou, mas n√£o achamos o email na nossa lista 'users'.
            console.error("FALHA NA BUSCA LOCAL: Usu√°rio logado com sucesso no Firebase, mas o e-mail '" + loggedInEmail + "' n√£o foi encontrado na sua lista 'const users'. Verifique se o e-mail est√° escrito exatamente igual nos dois lugares.");
            auth.signOut(); // Desloga por seguran√ßa
            alert("Erro de configura√ß√£o: Seu usu√°rio √© v√°lido, mas n√£o foi reconhecido pelo sistema. Contate o administrador.");
        }
      } else {
        // Usu√°rio est√° deslogado.
        loggedInUser = null;
        elements.loginScreen.classList.remove('hidden');
        elements.appContainer.classList.add('hidden');
        if (unsubscribeWeeklyData) unsubscribeWeeklyData();
        if (unsubscribeHistory) unsubscribeHistory();
      }
    });
}

  // --- L√ìGICA PRINCIPAL ---
  async function handleLogin() {
    const email = elements.email.value.toLowerCase().trim();
    const password = elements.password.value;
    if (!email || !password) return alert("Preencha e-mail e senha.");
    try {
      await signInWithEmailAndPassword(auth, email, password);
    } catch (error) {
      alert("Email ou senha inv√°lidos.");
    }
  }

  function setupUIForUser() {
    elements.welcomeMessage.textContent = `Bem-vindo(a), ${loggedInUser.name}!`;
    if (loggedInUser.role === 'admin') {
      elements.adminSelectorContainer.classList.remove('hidden');
      elements.adminReportSection.classList.remove('hidden');
      listenToAdminReportData();
      setupAdminBarberSelector();
    } else { 
      elements.adminSelectorContainer.classList.add('hidden');
      selectedBarberId = loggedInUser.barberId;
      elements.mainContent.classList.remove('hidden');
      startListeners();
    }
    setupCommonUI();
  }
  
  function setupAdminBarberSelector() {
    elements.barberSelector.innerHTML = '<option value="">-- Selecione um funcion√°rio --</option>';
    Object.values(users).filter(u => u.role === 'barber').sort((a, b) => a.name.localeCompare(b.name))
      .forEach(b => elements.barberSelector.innerHTML += `<option value="${b.barberId}">${b.name}</option>`);
    
    elements.barberSelector.addEventListener('change', () => {
      selectedBarberId = elements.barberSelector.value;
      if (selectedBarberId) {
        elements.mainContent.classList.remove('hidden');
        startListeners();
      } else {
        elements.mainContent.classList.add('hidden');
        if(unsubscribeWeeklyData) unsubscribeWeeklyData();
        if(unsubscribeHistory) unsubscribeHistory();
      }
    });
  }

  function setupCommonUI() {
    elements.daySelector.innerHTML = Object.entries(weekDays).map(([dayIndex, dayName]) =>
      `<button class="day-btn p-2 rounded-md bg-gray-700 hover:bg-gray-600 transition" data-day-index="${dayIndex}">${dayName}</button>`
    ).join('');

    const todayIndex = new Date().getDay();
    selectedDay = (todayIndex >= 2 && todayIndex <= 6) ? todayIndex : 2; 
    updateDaySelection(); 

    elements.daySelector.querySelectorAll('.day-btn').forEach(btn => {
      btn.addEventListener('click', () => {
        selectedDay = parseInt(btn.dataset.dayIndex);
        updateDaySelection();
      });
    });

    const weekStartDate = new Date();
    weekStartDate.setDate(weekStartDate.getDate() - (weekStartDate.getDay() - 2 + 7) % 7);
    const weekEndDate = new Date(weekStartDate);
    weekEndDate.setDate(weekEndDate.getDate() + 4);
    elements.currentWeek.textContent = `Semana: ${weekStartDate.toLocaleDateString('pt-BR')} - ${weekEndDate.toLocaleDateString('pt-BR')}`;

    elements.addServiceTransactionBtn.addEventListener('click', () => addTransaction('service'));
    elements.saveValeBtn.addEventListener('click', saveVale);
    elements.closeWeekBtn.addEventListener('click', closeWeek);
  }

  function startListeners() {
    if (unsubscribeWeeklyData) unsubscribeWeeklyData();
    if (unsubscribeHistory) unsubscribeHistory();
    listenToWeeklyData();
    listenToClosingsHistory();
  }

  function updateDaySelection() {
    elements.daySelector.querySelectorAll('.day-btn').forEach(btn => {
      btn.classList.toggle('active', parseInt(btn.dataset.dayIndex) === selectedDay);
    });
    calculateWeeklySummary(); 
    renderDailyLog();
  }
  
  function renderDailyLog() {
    const dayKey = weekDays[selectedDay];
    const dayData = weeklyData[dayKey] || { transactions: [], vale: 0 };
    const transactions = dayData.transactions || [];
    elements.dailyLog.innerHTML = '';
    if (transactions.length === 0) {
      elements.dailyLog.innerHTML = `<p id="daily-log-placeholder" class="text-gray-500 text-center p-4">Nenhum lan√ßamento para este dia.</p>`;
    } else {
      transactions.forEach(t => {
        const item = document.createElement('div');
        item.className = 'transaction-item bg-gray-600/50 p-3 rounded-md flex justify-between items-center';
        let descriptionHtml = `<p class="font-semibold">${t.serviceDescription} <span class="text-cyan-400">${formatCurrency(t.value)}</span> <span class="text-gray-400">(${t.paymentMethod})</span></p>`;
        item.innerHTML = `<div>${descriptionHtml}</div>`;
        elements.dailyLog.appendChild(item);
      });
    }
    elements.vale.value = dayData.vale || '';
  }

  async function updateFirestoreData(newData) {
    if (!selectedBarberId) return;
    try {
      const docRef = doc(db, "barbers", selectedBarberId, "weekly_entries", currentWeekId);
      await setDoc(docRef, newData, { merge: true });
    } catch (error) {
      console.error("Erro ao salvar dados:", error);
    }
  }

  async function addTransaction(type) {
    const serviceDescription = document.getElementById('serviceDescription').value.trim();
    const serviceValue = parseFloat(document.getElementById('serviceValue').value) || 0;
    if (!serviceDescription || serviceValue <= 0) return alert("Preencha descri√ß√£o e valor do servi√ßo.");
    
    const newTransaction = {
      id: crypto.randomUUID(),
      serviceDescription,
      value: serviceValue,
      paymentMethod: document.getElementById('paymentMethod').value
    };

    const dayKey = weekDays[selectedDay];
    const updatedData = JSON.parse(JSON.stringify(weeklyData));
    if (!updatedData[dayKey]) updatedData[dayKey] = { transactions: [], vale: 0 };
    updatedData[dayKey].transactions.push(newTransaction);
    await updateFirestoreData(updatedData);
    document.getElementById('serviceDescription').value = '';
    document.getElementById('serviceValue').value = '';
  }
  
  async function saveVale() {
    const dayKey = weekDays[selectedDay];
    const vale = parseFloat(elements.vale.value) || 0;
    const updatedData = JSON.parse(JSON.stringify(weeklyData));
    if (!updatedData[dayKey]) updatedData[dayKey] = { transactions: [], vale: 0 };
    updatedData[dayKey].vale = vale;
    await updateFirestoreData(updatedData);
    alert("Vale salvo!");
  }

  function listenToWeeklyData() {
    if (!selectedBarberId) return;
    const docRef = doc(db, "barbers", selectedBarberId, "weekly_entries", currentWeekId);
    unsubscribeWeeklyData = onSnapshot(docRef, (docSnap) => {
      weeklyData = docSnap.exists() ? docSnap.data() : {};
      renderDailyLog();
      calculateWeeklySummary();
    });
  }

  function calculateWeeklySummary() {
    let totalBruto = 0, comissaoServicos = 0, comissaoAssinaturas = 0, comissaoCartaoPresente = 0, totalVale = 0;
    Object.values(weeklyData).forEach(dayData => {
      dayData.transactions?.forEach(t => {
        if (t.value > 0) {
          totalBruto += t.value;
          let commissionableValue = t.value;
          if (t.paymentMethod === 'D√©bito') commissionableValue *= (1 - 0.015);
          else if (t.paymentMethod === 'Cr√©dito') commissionableValue *= (1 - 0.05);

          if (t.paymentMethod === 'Assinatura') comissaoAssinaturas += commissionableValue * 0.5;
          else if (t.paymentMethod === 'Cart√£o Presente') comissaoCartaoPresente += commissionableValue * 0.5;
          else comissaoServicos += commissionableValue * 0.5;
        }
      });
      totalVale += dayData.vale || 0;
    });
    const subtotal = comissaoServicos + comissaoAssinaturas + comissaoCartaoPresente;
    elements.faturamentoBruto.textContent = formatCurrency(totalBruto);
    elements.comissaoServicos.textContent = formatCurrency(comissaoServicos);
    elements.comissaoAssinaturas.textContent = formatCurrency(comissaoAssinaturas);
    elements.comissaoCartaoPresente.textContent = formatCurrency(comissaoCartaoPresente);
    elements.subtotalComissao.textContent = formatCurrency(subtotal);
    elements.descontoVale.textContent = `- ${formatCurrency(totalVale)}`;
    elements.comissaoFinal.textContent = formatCurrency(subtotal - totalVale);
  }

  function listenToAdminReportData() {
    const weeklyEntriesQuery = query(collectionGroup(db, 'weekly_entries'));
    unsubscribeAdminReport = onSnapshot(weeklyEntriesQuery, (snapshot) => {
        const allEntries = snapshot.docs.map(doc => ({ barberId: doc.ref.parent.parent.id, data: doc.data() }));
        calculateAdminReport(allEntries);
    });
  }
  
  function calculateAdminReport(allEntries) {
    let loja1Weekly = 0, loja2Weekly = 0, loja1Daily = 0, loja2Daily = 0;
    const barberRevenue = {};
    const todayKey = weekDays[new Date().getDay()];

    allEntries.forEach(entry => {
        const store = barberStoreMap[entry.barberId];
        if (!store) return;
        if (!barberRevenue[entry.barberId]) barberRevenue[entry.barberId] = 0;

        Object.entries(entry.data).forEach(([dayKey, dayData]) => {
            const dayTotal = dayData.transactions?.reduce((sum, t) => sum + (t.value || 0), 0) || 0;
            barberRevenue[entry.barberId] += dayTotal;
            if (store === 'loja01') {
                loja1Weekly += dayTotal;
                if (dayKey === todayKey) loja1Daily += dayTotal;
            } else if (store === 'loja02') {
                loja2Weekly += dayTotal;
                if (dayKey === todayKey) loja2Daily += dayTotal;
            }
        });
    });

    elements.loja01WeeklyTotal.textContent = formatCurrency(loja1Weekly);
    elements.loja02WeeklyTotal.textContent = formatCurrency(loja2Weekly);
    elements.loja01DailyTotal.textContent = formatCurrency(loja1Daily);
    elements.loja02DailyTotal.textContent = formatCurrency(loja2Daily);

    const rankedBarbers = Object.entries(barberRevenue)
        .map(([id, revenue]) => ({ name: users[Object.keys(users).find(email => users[email].barberId === id)].name, revenue }))
        .sort((a,b) => b.revenue - a.revenue);
    
    elements.barberRankingList.innerHTML = rankedBarbers.map((b, i) => 
        `<div class="flex justify-between items-center bg-gray-700/50 p-3 rounded-md"><span>${i+1}. ${b.name}</span><span class="font-bold text-lg text-green-400">${formatCurrency(b.revenue)}</span></div>`
    ).join('') || '<p class="text-gray-500 text-center">Nenhum faturamento.</p>';
  }

  async function closeWeek() {
    if (Object.keys(weeklyData).length === 0) return alert("N√£o h√° dados para fechar.");
    if (!confirm("Tem certeza? Esta a√ß√£o n√£o pode ser desfeita.")) return;
    
    let faturamentoBruto = 0, comissaoPaga = 0, totalVale = 0;
    // Recalcular para garantir
    let comissaoServicos=0, comissaoAssinaturas=0, comissaoCartaoPresente=0;
    Object.values(weeklyData).forEach(dayData=>{
      dayData.transactions?.forEach(t=>{faturamentoBruto+=t.value||0;let v=t.value*(t.paymentMethod==='D√©bito'?0.985:t.paymentMethod==='Cr√©dito'?0.95:1);if(t.paymentMethod==='Assinatura')comissaoAssinaturas+=v*0.5;else if(t.paymentMethod==='Cart√£o Presente')comissaoCartaoPresente+=v*0.5;else comissaoServicos+=v*0.5});
      totalVale+=dayData.vale||0
    });
    comissaoPaga=comissaoServicos+comissaoAssinaturas+comissaoCartaoPresente-totalVale;
    
    const weekStartDate=new Date();weekStartDate.setDate(weekStartDate.getDate()-(weekStartDate.getDay()-2+7)%7);const weekEndDate=new Date(weekStartDate);weekEndDate.setDate(weekEndDate.getDate()+4);const periodo=`${weekStartDate.toLocaleDateString('pt-BR')} - ${weekEndDate.toLocaleDateString('pt-BR')}`;
    
    try {
      await addDoc(collection(db, "barbers", selectedBarberId, "weekly_closings"), { weekId: currentWeekId, periodo, faturamentoBruto, totalVale, comissaoPaga, closedAt: serverTimestamp(), details: weeklyData });
      await deleteDoc(doc(db, "barbers", selectedBarberId, "weekly_entries", currentWeekId));
      alert(`Semana fechada com sucesso! Comiss√£o final: ${formatCurrency(comissaoPaga)}.`);
    } catch (error) {
      console.error("Erro ao fechar semana:", error);
    }
  }

  function listenToClosingsHistory() {
    if (!selectedBarberId) return;
    const q = query(collection(db, "barbers", selectedBarberId, "weekly_closings"));
    unsubscribeHistory = onSnapshot(q, (snapshot) => {
      elements.historyTableBody.innerHTML = '';
      if(snapshot.empty) {
        elements.historyTableBody.innerHTML = `<tr><td colspan="4" class="text-center py-10 text-gray-500">Nenhum fechamento semanal registrado.</td></tr>`;
        return;
      }
      snapshot.docs.map(d=>d.data()).sort((a,b)=>(b.closedAt?.seconds||0)-(a.closedAt?.seconds||0)).forEach(data=>{
        const tr=document.createElement('tr');tr.className='bg-gray-800 border-b border-gray-700 hover:bg-gray-700/80';
        tr.innerHTML=`<td class="px-4 py-3">${data.periodo}</td><td class="px-4 py-3 text-right">${formatCurrency(data.faturamentoBruto)}</td><td class="px-4 py-3 text-right text-yellow-400">${formatCurrency(data.totalVale)}</td><td class="px-4 py-3 text-right font-bold text-green-400">${formatCurrency(data.comissaoPaga)}</td>`;
        elements.historyTableBody.appendChild(tr);
      });
    });
  }

</script>
</body>
</html>
