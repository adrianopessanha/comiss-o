<!DOCTYPE html>
<html lang="pt-BR">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BarberCommission - Gestão Inteligente</title>

    <!-- Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;500;600;700&display=swap" rel="stylesheet">

    <!-- Icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />

    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Outfit', 'sans-serif'],
                    },
                    colors: {
                        cyan: { 400: '#22d3ee', 500: '#06b6d4', 600: '#0891b2' },
                        slate: { 800: '#1e293b', 900: '#0f172a' }
                    }
                }
            }
        }
    </script>

    <!-- Custom CSS -->
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;500;600;700&display=swap');

        :root {
            --primary-color: #06b6d4;
            /* Cyan 500 */
            --secondary-color: #6366f1;
            /* Indigo 500 */
            --bg-dark: #0f172a;
            /* Slate 900 */
            --card-bg: rgba(30, 41, 59, 0.7);
            /* Slate 800 with opacity */
            --glass-border: rgba(255, 255, 255, 0.1);
        }

        body {
            font-family: 'Outfit', sans-serif;
            background-color: var(--bg-dark);
            background-image:
                radial-gradient(at 0% 0%, rgba(6, 182, 212, 0.15) 0px, transparent 50%),
                radial-gradient(at 100% 0%, rgba(99, 102, 241, 0.15) 0px, transparent 50%);
            background-attachment: fixed;
            color: #f8fafc;
            -webkit-font-smoothing: antialiased;
        }

        /* Glassmorphism Utilities */
        .glass-panel {
            background: var(--card-bg);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            border: 1px solid var(--glass-border);
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
        }

        .glass-input {
            background: rgba(15, 23, 42, 0.6);
            border: 1px solid rgba(255, 255, 255, 0.1);
            color: white;
            transition: all 0.3s ease;
        }

        .glass-input:focus {
            border-color: var(--primary-color);
            box-shadow: 0 0 0 2px rgba(6, 182, 212, 0.2);
            outline: none;
        }

        /* Custom Scrollbar */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }

        ::-webkit-scrollbar-track {
            background: rgba(15, 23, 42, 0.5);
        }

        ::-webkit-scrollbar-thumb {
            background: rgba(100, 116, 139, 0.5);
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: rgba(148, 163, 184, 0.8);
        }

        /* Day Selector */
        .day-btn {
            background: rgba(30, 41, 59, 0.5);
            border: 1px solid rgba(255, 255, 255, 0.05);
            color: #94a3b8;
        }

        .day-btn:hover {
            background: rgba(51, 65, 85, 0.8);
            color: white;
        }

        .day-btn.active {
            background: var(--primary-color);
            color: white;
            border-color: var(--primary-color);
            box-shadow: 0 0 15px rgba(6, 182, 212, 0.4);
        }

        /* Animations */
        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .animate-fade-in {
            animation: fadeIn 0.4s ease-out forwards;
        }

        /* Transaction Item */
        .transaction-item {
            transition: all 0.2s ease;
        }

        .transaction-item:hover {
            transform: translateX(4px);
            background: rgba(51, 65, 85, 0.6);
        }

        /* Inputs Placeholder */
        ::placeholder {
            color: #64748b;
        }

        /* Select Arrow */
        select {
            appearance: none;
            background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 20 20'%3e%3cpath stroke='%2394a3b8' stroke-linecap='round' stroke-linejoin='round' stroke-width='1.5' d='M6 8l4 4 4-4'/%3e%3c/svg%3e");
            background-position: right 0.5rem center;
            background-repeat: no-repeat;
            background-size: 1.5em 1.5em;
            padding-right: 2.5rem;
        }
    </style>
</head>

<body class="antialiased min-h-screen flex flex-col">

    <!-- Login Screen -->
    <div id="login-screen" class="fixed inset-0 z-50 flex items-center justify-center p-4">
        <div class="glass-panel p-8 rounded-2xl shadow-2xl w-full max-w-sm animate-fade-in relative overflow-hidden">
            <div class="absolute top-0 left-0 w-full h-1 bg-gradient-to-r from-cyan-500 to-indigo-500"></div>

            <div class="text-center mb-8">
                <div class="inline-flex items-center justify-center w-16 h-16 rounded-full bg-cyan-500/10 mb-4">
                    <i class="fa-solid fa-scissors text-2xl text-cyan-400"></i>
                </div>
                <h2 class="text-3xl font-bold text-white tracking-tight">Barber<span
                        class="text-cyan-400">Commission</span></h2>
                <p class="text-gray-400 text-sm mt-2">Acesse sua conta para continuar</p>
            </div>

            <div class="space-y-5">
                <div>
                    <label for="email"
                        class="block text-xs font-medium text-gray-400 uppercase tracking-wider mb-1.5">Email</label>
                    <div class="relative">
                        <span class="absolute left-3 top-3 text-gray-500"><i class="fa-regular fa-envelope"></i></span>
                        <input type="email" id="email"
                            class="glass-input w-full rounded-lg pl-10 pr-4 py-2.5 text-sm placeholder-gray-600"
                            placeholder="seu@email.com">
                    </div>
                </div>
                <div>
                    <label for="password"
                        class="block text-xs font-medium text-gray-400 uppercase tracking-wider mb-1.5">Senha</label>
                    <div class="relative">
                        <span class="absolute left-3 top-3 text-gray-500"><i class="fa-solid fa-lock"></i></span>
                        <input type="password" id="password"
                            class="glass-input w-full rounded-lg pl-10 pr-4 py-2.5 text-sm placeholder-gray-600"
                            placeholder="••••••••">
                    </div>
                </div>
                <button id="loginBtn"
                    class="w-full bg-gradient-to-r from-cyan-600 to-cyan-500 hover:from-cyan-500 hover:to-cyan-400 text-white font-semibold py-3 px-4 rounded-lg shadow-lg shadow-cyan-500/20 transition-all duration-300 transform hover:-translate-y-0.5">
                    Entrar na Plataforma
                </button>
            </div>

            <p class="text-xs text-gray-600 mt-6 text-center">
                Sistema exclusivo para gestão interna.
            </p>
        </div>
    </div>

    <!-- App Container -->
    <div id="app-container" class="hidden flex-grow flex flex-col">

        <!-- Header -->
        <header class="glass-panel border-b border-gray-800 sticky top-0 z-40">
            <div class="container mx-auto px-4 py-4 flex flex-col md:flex-row justify-between items-center gap-4">
                <div class="flex items-center gap-3">
                    <div
                        class="w-10 h-10 rounded-lg bg-gradient-to-br from-cyan-500 to-blue-600 flex items-center justify-center shadow-lg shadow-cyan-500/20">
                        <i class="fa-solid fa-cut text-white"></i>
                    </div>
                    <div>
                        <h1 class="text-xl font-bold text-white leading-none">Barber<span
                                class="text-cyan-400">Commission</span></h1>
                        <p id="currentWeek" class="text-xs text-gray-400 mt-1 font-medium"></p>
                    </div>
                </div>

                <div class="flex items-center gap-4">
                    <p id="welcomeMessage" class="text-sm text-gray-300 hidden md:block"></p>
                    <div id="admin-selector-container" class="hidden min-w-[200px]">
                        <select id="barberSelector"
                            class="glass-input w-full rounded-lg px-3 py-2 text-sm bg-slate-800 border-slate-700 focus:ring-cyan-500"></select>
                    </div>
                </div>
            </div>
        </header>

        <main class="container mx-auto p-4 md:p-6 max-w-7xl flex-grow space-y-8">

            <!-- Admin Reports Section -->
            <div id="admin-report-section" class="hidden space-y-8 animate-fade-in">
                <!-- Stats Grid -->
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
                    <!-- Total Revenue -->
                    <div class="glass-panel p-5 rounded-xl relative overflow-hidden group">
                        <div
                            class="absolute -right-4 -top-4 w-24 h-24 bg-cyan-500/10 rounded-full group-hover:bg-cyan-500/20 transition-colors">
                        </div>
                        <p class="text-gray-400 text-sm font-medium mb-1">Faturamento Semanal</p>
                        <h3 id="reportFaturamentoTotal" class="text-3xl font-bold text-white">R$ 0,00</h3>
                        <div class="mt-4 flex gap-2 text-xs text-gray-400">
                            <span class="bg-slate-800/50 px-2 py-1 rounded">Din: <span id="reportDinheiro"
                                    class="text-green-400">0</span></span>
                            <span class="bg-slate-800/50 px-2 py-1 rounded">Pix: <span id="reportPix"
                                    class="text-green-400">0</span></span>
                        </div>
                    </div>

                    <!-- Subscriptions -->
                    <div class="glass-panel p-5 rounded-xl relative overflow-hidden group">
                        <div
                            class="absolute -right-4 -top-4 w-24 h-24 bg-purple-500/10 rounded-full group-hover:bg-purple-500/20 transition-colors">
                        </div>
                        <p class="text-gray-400 text-sm font-medium mb-1">Assinaturas</p>
                        <div class="flex items-baseline gap-2">
                            <h3 id="reportQtdAssinaturas" class="text-3xl font-bold text-white">0</h3>
                            <span class="text-sm text-gray-500">serviços</span>
                        </div>
                        <p id="reportValorAssinaturas" class="text-cyan-400 font-semibold mt-1">R$ 0,00</p>
                    </div>

                    <!-- Gift Cards -->
                    <div class="glass-panel p-5 rounded-xl relative overflow-hidden group">
                        <div
                            class="absolute -right-4 -top-4 w-24 h-24 bg-yellow-500/10 rounded-full group-hover:bg-yellow-500/20 transition-colors">
                        </div>
                        <p class="text-gray-400 text-sm font-medium mb-1">Cartão Presente</p>
                        <div class="flex items-baseline gap-2">
                            <h3 id="reportQtdCartaoPresente" class="text-3xl font-bold text-white">0</h3>
                            <span class="text-sm text-gray-500">serviços</span>
                        </div>
                        <p id="reportValorCartaoPresente" class="text-cyan-400 font-semibold mt-1">R$ 0,00</p>
                    </div>

                    <!-- Commission -->
                    <div class="glass-panel p-5 rounded-xl relative overflow-hidden group">
                        <div
                            class="absolute -right-4 -top-4 w-24 h-24 bg-green-500/10 rounded-full group-hover:bg-green-500/20 transition-colors">
                        </div>
                        <p class="text-gray-400 text-sm font-medium mb-1">Comissão (Assin/Vale)</p>
                        <h3 id="reportComissaoAssinaturasCartao" class="text-3xl font-bold text-green-400">R$ 0,00</h3>
                    </div>
                </div>

                <!-- Daily & Store Reports Grid -->
                <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                    <!-- Daily Report -->
                    <div class="glass-panel p-6 rounded-xl">
                        <h3 class="text-lg font-semibold text-white mb-4 flex items-center gap-2">
                            <i class="fa-regular fa-calendar-check text-cyan-400"></i> Faturamento Hoje
                        </h3>
                        <div class="space-y-3">
                            <div class="flex justify-between text-sm"><span class="text-gray-400">Dinheiro</span> <span
                                    id="reportFaturamentoDiarioDinheiro" class="text-white font-medium">R$ 0,00</span>
                            </div>
                            <div class="flex justify-between text-sm"><span class="text-gray-400">Pix</span> <span
                                    id="reportFaturamentoDiarioPix" class="text-white font-medium">R$ 0,00</span></div>
                            <div class="flex justify-between text-sm"><span class="text-gray-400">Débito</span> <span
                                    id="reportFaturamentoDiarioDebito" class="text-white font-medium">R$ 0,00</span>
                            </div>
                            <div class="flex justify-between text-sm"><span class="text-gray-400">Crédito</span> <span
                                    id="reportFaturamentoDiarioCredito" class="text-white font-medium">R$ 0,00</span>
                            </div>
                            <div class="h-px bg-gray-700 my-2"></div>
                            <div class="flex justify-between items-center">
                                <span class="text-gray-300 font-medium">Total</span>
                                <span id="reportFaturamentoDiarioTotal" class="text-xl font-bold text-cyan-400">R$
                                    0,00</span>
                            </div>
                            <p id="dailyReportStatus" class="text-xs text-center text-gray-500 mt-2"></p>
                        </div>
                    </div>

                    <!-- Store 01 -->
                    <div class="glass-panel p-6 rounded-xl border-l-4 border-blue-500">
                        <h3 class="text-lg font-semibold text-white mb-4">Loja 01</h3>
                        <div class="space-y-3">
                            <div class="flex justify-between text-sm"><span class="text-gray-400">Hoje (Total)</span>
                                <span id="loja01DailyTotal" class="text-blue-400 font-bold">R$ 0,00</span></div>
                            <div class="grid grid-cols-2 gap-2 text-xs text-gray-500 mt-2">
                                <div>D: <span id="loja01DailyDinheiro">0</span></div>
                                <div>P: <span id="loja01DailyPix">0</span></div>
                                <div>Db: <span id="loja01DailyDebito">0</span></div>
                                <div>Cr: <span id="loja01DailyCredito">0</span></div>
                            </div>
                            <div class="h-px bg-gray-700 my-2"></div>
                            <div class="flex justify-between items-center">
                                <span class="text-gray-300 font-medium">Semanal</span>
                                <span id="loja01WeeklyTotal" class="text-xl font-bold text-blue-400">R$ 0,00</span>
                            </div>
                        </div>
                    </div>

                    <!-- Store 02 -->
                    <div class="glass-panel p-6 rounded-xl border-l-4 border-yellow-500">
                        <h3 class="text-lg font-semibold text-white mb-4">Loja 02</h3>
                        <div class="space-y-3">
                            <div class="flex justify-between text-sm"><span class="text-gray-400">Hoje (Total)</span>
                                <span id="loja02DailyTotal" class="text-yellow-400 font-bold">R$ 0,00</span></div>
                            <div class="grid grid-cols-2 gap-2 text-xs text-gray-500 mt-2">
                                <div>D: <span id="loja02DailyDinheiro">0</span></div>
                                <div>P: <span id="loja02DailyPix">0</span></div>
                                <div>Db: <span id="loja02DailyDebito">0</span></div>
                                <div>Cr: <span id="loja02DailyCredito">0</span></div>
                            </div>
                            <div class="h-px bg-gray-700 my-2"></div>
                            <div class="flex justify-between items-center">
                                <span class="text-gray-300 font-medium">Semanal</span>
                                <span id="loja02WeeklyTotal" class="text-xl font-bold text-yellow-400">R$ 0,00</span>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Ranking -->
                <div class="glass-panel p-6 rounded-xl">
                    <h3 class="text-lg font-semibold text-white mb-4">Ranking Semanal</h3>
                    <div id="barberRankingList" class="space-y-2 max-h-60 overflow-y-auto pr-2 custom-scrollbar"></div>
                </div>
            </div>

            <!-- Main Content (Barber View) -->
            <div id="main-content" class="hidden grid grid-cols-1 lg:grid-cols-3 gap-8 animate-fade-in">

                <!-- Left Column: Input & Log -->
                <div class="lg:col-span-2 space-y-6">

                    <!-- Day Selector -->
                    <div class="glass-panel p-2 rounded-xl flex justify-between gap-2 overflow-x-auto"
                        id="day-selector">
                        <!-- Populated by JS -->
                    </div>

                    <!-- Add Transaction Forms -->
                    <div class="glass-panel p-6 rounded-xl space-y-6">
                        <h3 class="text-lg font-semibold text-white flex items-center gap-2">
                            <i class="fa-solid fa-plus-circle text-cyan-400"></i> Novo Lançamento
                        </h3>

                        <!-- Tabs or Sections? Let's use clean sections for now -->
                        <div class="space-y-6">

                            <!-- Service -->
                            <div class="bg-slate-800/50 p-4 rounded-lg border border-slate-700/50">
                                <h4 class="text-sm font-medium text-cyan-400 mb-3 uppercase tracking-wide">Serviço</h4>
                                <div class="grid grid-cols-1 md:grid-cols-2 gap-3 mb-3">
                                    <input type="text" id="clientName" placeholder="Cliente (opcional)"
                                        class="glass-input w-full rounded-lg px-3 py-2 text-sm">
                                    <input type="text" id="serviceDescription" placeholder="Descrição do Serviço"
                                        class="glass-input w-full rounded-lg px-3 py-2 text-sm">
                                </div>
                                <div class="grid grid-cols-1 md:grid-cols-3 gap-3">
                                    <input type="number" id="serviceValue" placeholder="Valor (R$)"
                                        class="glass-input w-full rounded-lg px-3 py-2 text-sm">
                                    <select id="paymentMethod" class="glass-input w-full rounded-lg px-3 py-2 text-sm">
                                        <option value="Dinheiro">Dinheiro</option>
                                        <option value="Pix">Pix</option>
                                        <option value="Débito">Débito</option>
                                        <option value="Crédito">Crédito</option>
                                        <option value="Assinatura">Assinatura</option>
                                        <option value="Cartão Presente">Cartão Presente</option>
                                    </select>
                                    <button id="addServiceTransactionBtn"
                                        class="bg-cyan-600 hover:bg-cyan-500 text-white rounded-lg px-4 py-2 text-sm font-medium transition-colors">Adicionar</button>
                                </div>
                            </div>

                            <!-- Product -->
                            <div class="bg-slate-800/50 p-4 rounded-lg border border-slate-700/50">
                                <h4 class="text-sm font-medium text-indigo-400 mb-3 uppercase tracking-wide">Produto
                                </h4>
                                <div class="grid grid-cols-1 gap-3 mb-3">
                                    <input type="text" id="productDescription" placeholder="Descrição do Produto"
                                        class="glass-input w-full rounded-lg px-3 py-2 text-sm">
                                </div>
                                <div class="grid grid-cols-1 md:grid-cols-4 gap-3">
                                    <input type="number" id="productsSold" placeholder="Qtd"
                                        class="glass-input w-full rounded-lg px-3 py-2 text-sm">
                                    <input type="number" id="productSaleValue" placeholder="Total (R$)"
                                        class="glass-input w-full rounded-lg px-3 py-2 text-sm">
                                    <select id="productPaymentMethod"
                                        class="glass-input w-full rounded-lg px-3 py-2 text-sm">
                                        <option value="">Pagamento</option>
                                        <option value="Dinheiro">Dinheiro</option>
                                        <option value="Pix">Pix</option>
                                        <option value="Débito">Débito</option>
                                        <option value="Crédito">Crédito</option>
                                    </select>
                                    <button id="addProductTransactionBtn"
                                        class="bg-indigo-600 hover:bg-indigo-500 text-white rounded-lg px-4 py-2 text-sm font-medium transition-colors">Adicionar</button>
                                </div>
                            </div>

                            <!-- Plan/Vale -->
                            <div class="bg-slate-800/50 p-4 rounded-lg border border-slate-700/50">
                                <h4 class="text-sm font-medium text-purple-400 mb-3 uppercase tracking-wide">Plano /
                                    Vale</h4>
                                <div class="grid grid-cols-1 md:grid-cols-2 gap-3 mb-3">
                                    <input type="text" id="clientNamePlan" placeholder="Cliente (Obrigatório)"
                                        class="glass-input w-full rounded-lg px-3 py-2 text-sm">
                                    <input type="number" id="planSaleValue" placeholder="Valor (R$)"
                                        class="glass-input w-full rounded-lg px-3 py-2 text-sm">
                                </div>
                                <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
                                    <select id="planSaleType" class="glass-input w-full rounded-lg px-3 py-2 text-sm">
                                        <option value="">Tipo</option>
                                        <option value="Assinatura">Assinatura</option>
                                        <option value="Cartão Presente">Cartão Presente</option>
                                    </select>
                                    <div class="flex gap-2">
                                        <select id="planSalePaymentMethod"
                                            class="glass-input w-full rounded-lg px-3 py-2 text-sm">
                                            <option value="">Pagamento</option>
                                            <option value="Dinheiro">Dinheiro</option>
                                            <option value="Pix">Pix</option>
                                            <option value="Débito">Débito</option>
                                            <option value="Crédito">Crédito</option>
                                        </select>
                                        <button id="addPlanTransactionBtn"
                                            class="bg-purple-600 hover:bg-purple-500 text-white rounded-lg px-4 py-2 text-sm font-medium transition-colors">Add</button>
                                    </div>
                                </div>
                            </div>

                        </div>
                    </div>

                    <!-- Daily Log -->
                    <div class="glass-panel p-6 rounded-xl">
                        <div class="flex justify-between items-center mb-4">
                            <h3 class="text-lg font-semibold text-white">Atividade do Dia</h3>
                            <div class="flex gap-2 items-center">
                                <input type="number" id="vale" placeholder="Vale (R$)"
                                    class="glass-input w-24 rounded-lg px-2 py-1 text-sm text-right border-yellow-500/30 focus:border-yellow-500">
                                <button id="saveValeBtn"
                                    class="text-xs bg-yellow-600 hover:bg-yellow-500 text-white px-3 py-1.5 rounded-lg transition-colors">Salvar
                                    Vale</button>
                            </div>
                        </div>
                        <div id="daily-log" class="space-y-3 max-h-[500px] overflow-y-auto pr-2 custom-scrollbar">
                            <!-- Populated by JS -->
                        </div>
                    </div>
                </div>

                <!-- Right Column: Summary -->
                <div class="space-y-6">
                    <div class="glass-panel p-6 rounded-xl sticky top-24">
                        <h2 class="text-xl font-semibold text-white mb-6 flex items-center gap-2">
                            <i class="fa-solid fa-chart-pie text-cyan-400"></i> Resumo Semanal
                        </h2>

                        <div class="space-y-4">
                            <div
                                class="flex justify-between items-center bg-slate-800/80 p-4 rounded-lg border border-slate-700">
                                <span class="text-gray-300 font-medium">Faturamento Bruto</span>
                                <span id="faturamentoBruto" class="text-xl font-bold text-cyan-400">R$ 0,00</span>
                            </div>

                            <div class="space-y-2 text-sm text-gray-400 px-2">
                                <div class="flex justify-between"><span>Comissão Serviços</span><span
                                        id="comissaoServicos" class="text-gray-200">R$ 0,00</span></div>
                                <div class="flex justify-between"><span>Comissão Assinaturas</span><span
                                        id="comissaoAssinaturas" class="text-gray-200">R$ 0,00</span></div>
                                <div class="flex justify-between"><span>Comissão Cartão Presente</span><span
                                        id="comissaoCartaoPresente" class="text-gray-200">R$ 0,00</span></div>
                                <div class="flex justify-between"><span>Comissão Produtos</span><span
                                        id="comissaoProdutos" class="text-gray-200">R$ 0,00</span></div>
                                <div class="h-px bg-gray-700 my-2"></div>
                                <div class="flex justify-between font-medium text-gray-300"><span>Subtotal</span><span
                                        id="subtotalComissao">R$ 0,00</span></div>
                                <div class="flex justify-between text-yellow-500"><span>Vales</span><span
                                        id="descontoVale">- R$ 0,00</span></div>
                            </div>

                            <div
                                class="bg-gradient-to-r from-green-900/40 to-emerald-900/40 p-4 rounded-lg border border-green-500/20 mt-4">
                                <div class="flex justify-between items-center">
                                    <span class="text-green-100 font-medium">A Receber</span>
                                    <span id="comissaoFinal" class="text-2xl font-bold text-green-400">R$ 0,00</span>
                                </div>
                            </div>
                        </div>

                        <!-- Daily Details Collapsible/Section -->
                        <div class="mt-8 pt-6 border-t border-gray-700">
                            <h3 class="text-sm font-semibold text-gray-400 uppercase tracking-wider mb-4">Detalhes do
                                Dia</h3>
                            <div class="space-y-2 text-sm text-gray-500">
                                <div class="flex justify-between"><span>Dinheiro</span><span id="detalheDinheiro"
                                        class="text-gray-300">R$ 0,00</span></div>
                                <div class="flex justify-between"><span>Pix</span><span id="detalhePix"
                                        class="text-gray-300">R$ 0,00</span></div>
                                <div class="flex justify-between"><span>Débito</span><span id="detalheDebito"
                                        class="text-gray-300">R$ 0,00</span></div>
                                <div class="flex justify-between"><span>Crédito</span><span id="detalheCredito"
                                        class="text-gray-300">R$ 0,00</span></div>
                                <div class="flex justify-between"><span>Assinaturas</span><span id="detalheAssinaturas"
                                        class="text-gray-300">R$ 0,00</span></div>
                                <div class="flex justify-between"><span>Cartão Presente</span><span
                                        id="detalheCartaoPresente" class="text-gray-300">R$ 0,00</span></div>
                                <div class="flex justify-between pt-2 border-t border-gray-700 mt-2"><span>Prod.
                                        Vendidos</span><span id="detalheTotalProdutos" class="text-gray-300">0</span>
                                </div>
                            </div>
                        </div>

                        <button id="closeWeekBtn"
                            class="mt-6 w-full bg-red-600/80 hover:bg-red-600 text-white font-bold py-3 px-4 rounded-lg transition duration-300 flex items-center justify-center gap-2 hidden">
                            <i class="fa-solid fa-lock"></i> Encerrar Semana
                        </button>
                    </div>
                </div>
            </div>

            <!-- History Section -->
            <div id="history-section" class="hidden glass-panel p-6 rounded-xl animate-fade-in">
                <h2 class="text-xl font-semibold text-white mb-6">Histórico de Fechamentos</h2>
                <div class="overflow-x-auto">
                    <table class="w-full text-sm text-left text-gray-400">
                        <thead class="text-xs text-cyan-400 uppercase bg-slate-800/50">
                            <tr>
                                <th scope="col" class="px-4 py-3 rounded-l-lg">Período</th>
                                <th scope="col" class="px-4 py-3 text-right">Faturamento</th>
                                <th scope="col" class="px-4 py-3 text-right">Vales</th>
                                <th scope="col" class="px-4 py-3 text-right rounded-r-lg">Comissão Paga</th>
                            </tr>
                        </thead>
                        <tbody id="historyTableBody" class="divide-y divide-gray-800"></tbody>
                    </table>
                    <div id="historyPlaceholder" class="text-center py-10 text-gray-600">
                        <i class="fa-regular fa-folder-open text-4xl mb-3 opacity-50"></i>
                        <p>Nenhum fechamento registrado.</p>
                    </div>
                </div>
            </div>

        </main>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, onSnapshot, collection, addDoc, serverTimestamp, query, deleteDoc, getDocs, collectionGroup } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- Firebase Config ---
        const firebaseConfig = {
            apiKey: "AIzaSyBCfdVci2RFEearjQzByEysTXtV6D4Tofs",
            authDomain: "comisao-dos-barbeiros.firebaseapp.com",
            projectId: "comisao-dos-barbeiros",
            storageBucket: "comisao-dos-barbeiros.firebasestorage.app",
            messagingSenderId: "571199864529",
            appId: "1:571199864529:web:0ea9584c0c5372192e4ff0",
            measurementId: "G-VW7EZCR5G5"
        };

        let app, db, auth;
        try {
            app = initializeApp(firebaseConfig);
            db = getFirestore(app);
            auth = getAuth(app);
        } catch (error) {
            console.error("Firebase Initialization Error:", error);
        }

        // --- Auth Logic ---
        const users = {
            "admin@exemplo.com": { password: "753951", role: "admin", name: "Admin" },
            "Adrianopessanha@exemplo.com": { password: "123", role: "barber", barberId: "barber-01", name: "Adriano Pessanha" },
            "rodrigo@exemplo.com": { password: "0712", role: "barber", barberId: "barber-02", name: "Rodrigo Azevedo", canViewBarbers: ["barber-03", "barber-06"] },
            "veloso@exemplo.com": { password: "123", role: "barber", barberId: "barber-03", name: "Veloso" },
            "wellington@exemplo.com": { password: "123", role: "barber", barberId: "barber-04", name: "Wellington" },
            "matheus@exemplo.com": { password: "123", role: "barber", barberId: "barber-06", name: "Matheus" },
            "jonata@exemplo.com": { password: "123456", role: "barber", barberId: "barber-07", name: "Jonata Silva" }
        };

        const barberStoreMap = {
            "barber-01": "loja02", "barber-02": "loja01", "barber-03": "loja01", "barber-04": "loja02",
            "barber-06": "loja02", "barber-07": "loja02"
        };

        function loginUser(email, password) {
            const user = users[email.toLowerCase()];
            if (user && user.password === password) {
                return user;
            }
            return null;
        }

        // --- DB Logic ---
        function getWeekId(d = new Date()) {
            const date = new Date(d);
            const day = date.getDay();
            const dayOfWeek = day === 0 ? 6 : day - 1;
            date.setDate(date.getDate() - dayOfWeek + 1);
            const firstDayOfYear = new Date(date.getFullYear(), 0, 1);
            const pastDaysOfYear = (date - firstDayOfYear) / 86400000;
            const weekNo = Math.ceil((pastDaysOfYear + firstDayOfYear.getDay() + 1) / 7);
            return `${date.getFullYear()}-W${String(weekNo).padStart(2, '0')}`;
        }

        function getDateForDayOfWeek(weekId, dayIndex) {
            const [year, week] = weekId.split('-W').map(Number);
            const firstDayOfYear = new Date(year, 0, 1);
            const days = (week - 1) * 7;
            const date = new Date(firstDayOfYear.valueOf());
            date.setDate(date.getDate() + days);
            const dayOfWeek = date.getDay();
            const diff = dayIndex - (dayOfWeek === 0 ? 7 : dayOfWeek);
            date.setDate(date.getDate() + diff);
            return date.toISOString().split('T')[0];
        }

        function subscribeToWeeklyData(barberId, weekId, callback, errorCallback) {
            if (!barberId) return () => { };
            const docRef = doc(db, "barbers", barberId, "weekly_entries", weekId);
            return onSnapshot(docRef, (docSnap) => {
                const data = docSnap.exists() ? docSnap.data() : {};
                callback(data);
            }, errorCallback);
        }

        async function updateWeeklyData(barberId, weekId, newData) {
            if (!barberId) throw new Error("No barber ID provided");
            const docRef = doc(db, "barbers", barberId, "weekly_entries", weekId);
            await setDoc(docRef, newData);
        }

        function subscribeToHistory(barberId, callback, errorCallback) {
            if (!barberId) return () => { };
            const historyCollectionRef = collection(db, "barbers", barberId, "weekly_closings");
            const q = query(historyCollectionRef);
            return onSnapshot(q, (snapshot) => {
                let docs = snapshot.docs.map(d => d.data());
                docs.sort((a, b) => (b.closedAt?.seconds || 0) - (a.closedAt?.seconds || 0));
                callback(docs);
            }, errorCallback);
        }

        async function closeWeekInDb(barberId, weekId, closingData) {
            const historyCollectionRef = collection(db, "barbers", barberId, "weekly_closings");
            await addDoc(historyCollectionRef, {
                ...closingData,
                closedAt: serverTimestamp()
            });
            const weekDocRef = doc(db, "barbers", barberId, "weekly_entries", weekId);
            await deleteDoc(weekDocRef);
        }

        // --- UI Logic ---
        const weekDays = { 2: 'Terça', 3: 'Quarta', 4: 'Quinta', 5: 'Sexta', 6: 'Sábado' };
        const formatCurrency = (value) => new Intl.NumberFormat('pt-BR', { style: 'currency', currency: 'BRL' }).format(value);

        function renderDailyLog(container, transactions, onDelete, onEdit, dayIndex) {
            container.innerHTML = '';
            if (!transactions || transactions.length === 0) {
                container.innerHTML = '<p class="text-gray-500 text-center p-4">Nenhum lançamento para este dia.</p>';
                return;
            }

            transactions.forEach(t => {
                const item = document.createElement('div');
                item.className = 'transaction-item bg-gray-800/40 p-4 rounded-xl border border-gray-700/50 hover:border-cyan-500/30 transition-all duration-300 flex justify-between items-center group';

                let descriptionHtml = '';
                if (t.serviceDescription && t.value > 0) {
                    descriptionHtml += `<div class="mb-1"><span class="font-semibold text-white">${t.serviceDescription}</span> <span class="text-cyan-400 font-bold">${formatCurrency(t.value)}</span> <span class="text-xs text-gray-400 bg-gray-700 px-2 py-0.5 rounded-full">${t.paymentMethod}</span></div>`;
                }
                if (t.productDescription && t.products > 0) {
                    descriptionHtml += `<div class="text-sm text-gray-300"><span class="text-indigo-300">Produto:</span> ${t.productDescription} <span class="text-cyan-400">(${t.products}x)</span>`;
                    if (t.productSaleValue > 0) descriptionHtml += ` <span class="text-green-400 font-medium">${formatCurrency(t.productSaleValue)}</span>`;
                    if (t.productPaymentMethod) descriptionHtml += ` <span class="text-xs text-gray-500">(${t.productPaymentMethod})</span>`;
                    descriptionHtml += `</div>`;
                }
                if (t.planSaleType && t.planSaleValue > 0) {
                    let planSaleText = `Venda de ${t.planSaleType}`;
                    if (t.clientNamePlan) planSaleText += ` para ${t.clientNamePlan}`;
                    descriptionHtml += `<div class="text-sm text-purple-300 font-medium mt-1">${planSaleText} <span class="text-green-400">${formatCurrency(t.planSaleValue)}</span> <span class="text-xs text-gray-500">(${t.planSalePaymentMethod})</span></div>`;
                }
                if (t.clientName && !t.clientNamePlan) {
                    descriptionHtml += `<div class="text-xs text-gray-500 mt-1"><i class="fa-regular fa-user mr-1"></i>${t.clientName}</div>`;
                }

                item.innerHTML = `
                  <div class="flex-grow">
                    ${descriptionHtml}
                  </div>
                  <div class="flex items-center gap-3 opacity-0 group-hover:opacity-100 transition-opacity duration-200">
                    <button class="action-btn text-blue-400 hover:text-blue-300 p-2 hover:bg-blue-400/10 rounded-lg transition-colors edit-btn"><i class="fa-solid fa-pencil"></i></button>
                    <button class="action-btn text-red-500 hover:text-red-400 p-2 hover:bg-red-500/10 rounded-lg transition-colors delete-btn"><i class="fa-solid fa-trash"></i></button>
                  </div>
                `;

                item.querySelector('.edit-btn').addEventListener('click', () => onEdit(t.id));
                item.querySelector('.delete-btn').addEventListener('click', () => onDelete(t.id, dayIndex));
                container.appendChild(item);
            });
        }

        function updateSummaryDisplay(elements, data) {
            elements.faturamentoBruto.textContent = formatCurrency(data.totalBrutoSemana);
            elements.comissaoServicos.textContent = formatCurrency(data.comissaoServicosSemana);
            elements.comissaoProdutos.textContent = formatCurrency(data.comissaoProdutosSemana);
            elements.comissaoAssinaturas.textContent = formatCurrency(data.comissaoAssinaturasSemana);
            elements.comissaoCartaoPresente.textContent = formatCurrency(data.comissaoCartaoPresenteSemana);
            elements.subtotalComissao.textContent = formatCurrency(data.subtotalComissaoSemana);
            elements.descontoVale.textContent = `- ${formatCurrency(data.totalValeSemana)}`;
            elements.comissaoFinal.textContent = formatCurrency(data.comissaoFinalSemana);

            elements.detalheAssinaturas.textContent = formatCurrency(data.detalheAssinaturasDia);
            elements.detalheCartaoPresente.textContent = formatCurrency(data.detalheCartaoPresenteDia);
            elements.detalheDinheiro.textContent = formatCurrency(data.detalheDinheiroDia);
            elements.detalhePix.textContent = formatCurrency(data.detalhePixDia);
            elements.detalheDebito.textContent = formatCurrency(data.detalheDebitoDia);
            elements.detalheCredito.textContent = formatCurrency(data.detalheCreditoDia);
            elements.detalheTotalProdutos.textContent = data.detalheTotalProdutosDia;
        }

        function renderHistoryTable(tbody, placeholder, historyData) {
            tbody.innerHTML = '';
            if (!historyData || historyData.length === 0) {
                placeholder.style.display = 'block';
                return;
            }
            placeholder.style.display = 'none';

            historyData.forEach(data => {
                const tr = document.createElement('tr');
                tr.className = 'bg-gray-800/40 border-b border-gray-700 hover:bg-gray-700/50 transition-colors';
                tr.innerHTML = `
                  <td class="px-4 py-3 text-gray-400 font-medium">${data.periodo || data.weekId}</td>
                  <td class="px-4 py-3 text-right font-medium text-cyan-400">${formatCurrency(data.faturamentoBruto || 0)}</td>
                  <td class="px-4 py-3 text-right font-medium text-yellow-400">${formatCurrency(data.totalVale || 0)}</td>
                  <td class="px-4 py-3 text-right font-bold text-green-400">${formatCurrency(data.comissaoPaga || 0)}</td>
                `;
                tbody.appendChild(tr);
            });
        }

        function toggleElement(element, show) {
            if (show) element.classList.remove('hidden');
            else element.classList.add('hidden');
        }

        // --- App Logic ---
        let loggedInUser = null;
        let selectedBarberId = null;
        let currentWeekId = null;
        let selectedDay = null;
        let weeklyData = {};
        let unsubscribeWeeklyData = null;
        let unsubscribeHistory = null;

        const elements = {
            loginScreen: document.getElementById('login-screen'),
            appContainer: document.getElementById('app-container'),
            loginBtn: document.getElementById('loginBtn'),
            emailInput: document.getElementById('email'),
            passwordInput: document.getElementById('password'),
            welcomeMessage: document.getElementById('welcomeMessage'),
            currentWeekSpan: document.getElementById('currentWeek'),
            adminSection: document.getElementById('admin-report-section'),
            barberSelector: document.getElementById('barberSelector'),
            mainContent: document.getElementById('main-content'),
            historySection: document.getElementById('history-section'),
            daySelector: document.getElementById('day-selector'),
            dailyLog: document.getElementById('daily-log'),
            clientName: document.getElementById('clientName'),
            serviceDescription: document.getElementById('serviceDescription'),
            serviceValue: document.getElementById('serviceValue'),
            paymentMethod: document.getElementById('paymentMethod'),
            productDescription: document.getElementById('productDescription'),
            productsSold: document.getElementById('productsSold'),
            productSaleValue: document.getElementById('productSaleValue'),
            productPaymentMethod: document.getElementById('productPaymentMethod'),
            clientNamePlan: document.getElementById('clientNamePlan'),
            planSaleValue: document.getElementById('planSaleValue'),
            planSaleType: document.getElementById('planSaleType'),
            planSalePaymentMethod: document.getElementById('planSalePaymentMethod'),
            addServiceBtn: document.getElementById('addServiceTransactionBtn'),
            addProductBtn: document.getElementById('addProductTransactionBtn'),
            addPlanBtn: document.getElementById('addPlanTransactionBtn'),
            saveValeBtn: document.getElementById('saveValeBtn'),
            valeInput: document.getElementById('vale'),
            closeWeekBtn: document.getElementById('closeWeekBtn'),
            faturamentoBruto: document.getElementById('faturamentoBruto'),
            comissaoServicos: document.getElementById('comissaoServicos'),
            comissaoProdutos: document.getElementById('comissaoProdutos'),
            comissaoAssinaturas: document.getElementById('comissaoAssinaturas'),
            comissaoCartaoPresente: document.getElementById('comissaoCartaoPresente'),
            subtotalComissao: document.getElementById('subtotalComissao'),
            descontoVale: document.getElementById('descontoVale'),
            comissaoFinal: document.getElementById('comissaoFinal'),
            detalheAssinaturas: document.getElementById('detalheAssinaturas'),
            detalheCartaoPresente: document.getElementById('detalheCartaoPresente'),
            detalheDinheiro: document.getElementById('detalheDinheiro'),
            detalhePix: document.getElementById('detalhePix'),
            detalheDebito: document.getElementById('detalheDebito'),
            detalheCredito: document.getElementById('detalheCredito'),
            detalheTotalProdutos: document.getElementById('detalheTotalProdutos'),
            historyTableBody: document.getElementById('historyTableBody'),
            historyPlaceholder: document.getElementById('historyPlaceholder'),
        };

        async function init() {
            setupEventListeners();
            try {
                await signInAnonymously(auth);
                currentWeekId = getWeekId();

                const todayIndex = new Date().getDay();
                selectedDay = (todayIndex >= 2 && todayIndex <= 6) ? todayIndex : 2;
                renderDaySelector();

                const weekStartDate = new Date();
                weekStartDate.setDate(weekStartDate.getDate() - (weekStartDate.getDay() - 2 + 7) % 7);
                const weekEndDate = new Date(weekStartDate);
                weekEndDate.setDate(weekEndDate.getDate() + 4);
                elements.currentWeekSpan.textContent = `Semana: ${weekStartDate.toLocaleDateString('pt-BR')} - ${weekEndDate.toLocaleDateString('pt-BR')}`;
            } catch (error) {
                console.error("Init error:", error);
            }
        }

        function setupEventListeners() {
            if (elements.loginBtn) elements.loginBtn.addEventListener('click', handleLogin);
            if (elements.addServiceBtn) elements.addServiceBtn.addEventListener('click', () => addTransaction('service'));
            if (elements.addProductBtn) elements.addProductBtn.addEventListener('click', () => addTransaction('product'));
            if (elements.addPlanBtn) elements.addPlanBtn.addEventListener('click', () => addTransaction('plan'));
            if (elements.saveValeBtn) elements.saveValeBtn.addEventListener('click', saveVale);
            if (elements.closeWeekBtn) elements.closeWeekBtn.addEventListener('click', closeWeek);
        }

        function handleLogin() {
            const email = elements.emailInput.value.trim();
            const password = elements.passwordInput.value.trim();
            if (!email || !password) {
                alert("Por favor, preencha email e senha.");
                return;
            }
            const user = loginUser(email, password);
            if (user) {
                loggedInUser = user;
                toggleElement(elements.loginScreen, false);
                toggleElement(elements.appContainer, true);
                elements.welcomeMessage.textContent = `Bem-vindo(a), ${user.name}!`;
                setupUserView();
            } else {
                alert("Email ou senha inválidos.");
            }
        }

        function setupUserView() {
            if (loggedInUser.role === 'admin') {
                toggleElement(elements.adminSection, true);
                toggleElement(elements.closeWeekBtn, true);
                setupBarberSelector(true);
            } else {
                toggleElement(elements.adminSection, false);
                toggleElement(elements.closeWeekBtn, false);
                if (loggedInUser.canViewBarbers) {
                    setupBarberSelector(false);
                } else {
                    selectedBarberId = loggedInUser.barberId;
                    toggleElement(elements.mainContent, true);
                    toggleElement(elements.historySection, true);
                    startBarberListeners();
                }
            }
        }

        function setupBarberSelector(isAdmin) {
            elements.barberSelector.innerHTML = isAdmin
                ? '<option value="">-- Visão Geral / Selecione um funcionário --</option>'
                : `<option value="${loggedInUser.barberId}">Minha Visão (${loggedInUser.name})</option>`;

            const availableBarbers = isAdmin
                ? Object.values(users).filter(u => u.role === 'barber')
                : loggedInUser.canViewBarbers.map(id => Object.values(users).find(u => u.barberId === id)).filter(Boolean);

            availableBarbers.sort((a, b) => a.name.localeCompare(b.name));
            availableBarbers.forEach(b => {
                elements.barberSelector.innerHTML += `<option value="${b.barberId}">${b.name}</option>`;
            });

            toggleElement(document.getElementById('admin-selector-container'), true);

            elements.barberSelector.addEventListener('change', () => {
                selectedBarberId = elements.barberSelector.value;
                if (selectedBarberId) {
                    toggleElement(elements.mainContent, true);
                    toggleElement(elements.historySection, true);
                    startBarberListeners();
                } else {
                    toggleElement(elements.mainContent, false);
                    toggleElement(elements.historySection, false);
                }
            });
        }

        function startBarberListeners() {
            if (unsubscribeWeeklyData) unsubscribeWeeklyData();
            if (unsubscribeHistory) unsubscribeHistory();

            unsubscribeWeeklyData = subscribeToWeeklyData(selectedBarberId, currentWeekId, (data) => {
                weeklyData = data;
                updateUI();
            }, (error) => console.error(error));

            unsubscribeHistory = subscribeToHistory(selectedBarberId, (data) => {
                renderHistoryTable(elements.historyTableBody, elements.historyPlaceholder, data);
            }, (error) => console.error(error));
        }

        function renderDaySelector() {
            elements.daySelector.innerHTML = Object.entries(weekDays).map(([index, name]) => `
                <button class="day-btn ${parseInt(index) === selectedDay ? 'active' : ''} p-2 rounded-lg transition-all duration-200 font-medium text-sm" data-day="${index}">
                    ${name}
                </button>
            `).join('');

            elements.daySelector.querySelectorAll('.day-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    selectedDay = parseInt(btn.dataset.day);
                    renderDaySelector();
                    updateUI();
                });
            });
        }

        function updateUI() {
            const dayKey = weekDays[selectedDay];
            const dayData = weeklyData[dayKey] || { transactions: [], vale: 0 };
            renderDailyLog(elements.dailyLog, dayData.transactions, handleDeleteTransaction, handleEditTransaction, selectedDay);
            elements.valeInput.value = dayData.vale || '';
            const summary = calculateWeeklySummary(weeklyData);
            updateSummaryDisplay(elements, summary);
        }

        function calculateWeeklySummary(data) {
            let totals = {
                totalBrutoSemana: 0, comissaoServicosSemana: 0, comissaoAssinaturasSemana: 0,
                comissaoCartaoPresenteSemana: 0, totalValeSemana: 0, totalProdutosVendidosSemana: 0,
                detalheAssinaturasDia: 0, detalheCartaoPresenteDia: 0, detalheDinheiroDia: 0,
                detalhePixDia: 0, detalheDebitoDia: 0, detalheCreditoDia: 0, detalheTotalProdutosDia: 0
            };

            const dayKey = weekDays[selectedDay];
            const dayData = data[dayKey] || { transactions: [] };

            dayData.transactions?.forEach(t => {
                totals.detalheTotalProdutosDia += t.products || 0;
                let val = 0;
                let method = '';
                if (t.serviceDescription && t.value > 0) { val = t.value; method = t.paymentMethod; }
                else if (t.productDescription && t.products > 0) { val = t.productSaleValue; method = t.productPaymentMethod; }
                else if (t.planSaleType && t.planSaleValue > 0) { val = t.planSaleValue; method = t.planSalePaymentMethod; }

                if (val > 0) {
                    switch (method) {
                        case 'Dinheiro': totals.detalheDinheiroDia += val; break;
                        case 'Pix': totals.detalhePixDia += val; break;
                        case 'Débito': totals.detalheDebitoDia += val; break;
                        case 'Crédito': totals.detalheCreditoDia += val; break;
                        case 'Assinatura': totals.detalheAssinaturasDia += val; break;
                        case 'Cartão Presente': totals.detalheCartaoPresenteDia += val; break;
                    }
                }
            });

            Object.values(data).forEach(day => {
                totals.totalValeSemana += day.vale || 0;
                day.transactions?.forEach(t => {
                    totals.totalProdutosVendidosSemana += t.products || 0;
                    if (t.serviceDescription && t.value > 0) {
                        totals.totalBrutoSemana += t.value;
                        if (t.paymentMethod === 'Assinatura') totals.comissaoAssinaturasSemana += t.value * 0.5;
                        else if (t.paymentMethod === 'Cartão Presente') totals.comissaoCartaoPresenteSemana += t.value * 0.5;
                        else {
                            let commissionable = t.value;
                            if (t.paymentMethod === 'Débito') commissionable *= 0.985;
                            else if (t.paymentMethod === 'Crédito') commissionable *= 0.95;
                            totals.comissaoServicosSemana += commissionable * 0.5;
                        }
                    }
                });
            });

            totals.comissaoProdutosSemana = totals.totalProdutosVendidosSemana * 5;
            totals.subtotalComissaoSemana = totals.comissaoServicosSemana + totals.comissaoAssinaturasSemana + totals.comissaoCartaoPresenteSemana + totals.comissaoProdutosSemana;
            totals.comissaoFinalSemana = totals.subtotalComissaoSemana - totals.totalValeSemana;
            return totals;
        }

        async function addTransaction(type) {
            if (!selectedBarberId) return;
            const date = getDateForDayOfWeek(currentWeekId, selectedDay);
            let newTransaction = { id: crypto.randomUUID(), date };

            if (type === 'service') {
                const desc = elements.serviceDescription.value.trim();
                const val = parseFloat(elements.serviceValue.value);
                const method = elements.paymentMethod.value;
                if (!desc || !val || !method) return alert("Preencha todos os campos");
                Object.assign(newTransaction, { clientName: elements.clientName.value.trim(), serviceDescription: desc, value: val, paymentMethod: method });
                elements.serviceDescription.value = ''; elements.serviceValue.value = ''; elements.clientName.value = '';
            } else if (type === 'product') {
                const desc = elements.productDescription.value.trim();
                const qtd = parseInt(elements.productsSold.value);
                const val = parseFloat(elements.productSaleValue.value);
                const method = elements.productPaymentMethod.value;
                if (!desc || !qtd || !val || !method) return alert("Preencha todos os campos");
                Object.assign(newTransaction, { productDescription: desc, products: qtd, productSaleValue: val, productPaymentMethod: method });
                elements.productDescription.value = ''; elements.productsSold.value = ''; elements.productSaleValue.value = '';
            } else if (type === 'plan') {
                const client = elements.clientNamePlan.value.trim();
                const val = parseFloat(elements.planSaleValue.value);
                const typeSale = elements.planSaleType.value;
                const method = elements.planSalePaymentMethod.value;
                if (!client || !val || !typeSale || !method) return alert("Preencha todos os campos");
                Object.assign(newTransaction, { clientNamePlan: client, planSaleValue: val, planSaleType: typeSale, planSalePaymentMethod: method });
                elements.clientNamePlan.value = ''; elements.planSaleValue.value = '';
            }

            const dayKey = weekDays[selectedDay];
            const updatedData = { ...weeklyData };
            if (!updatedData[dayKey]) updatedData[dayKey] = { transactions: [], vale: 0 };
            if (!updatedData[dayKey].transactions) updatedData[dayKey].transactions = [];
            updatedData[dayKey].transactions.push(newTransaction);
            await updateWeeklyData(selectedBarberId, currentWeekId, updatedData);
        }

        async function handleDeleteTransaction(id, dayIndex) {
            if (!confirm("Tem certeza?")) return;
            const dayKey = weekDays[dayIndex];
            const updatedData = { ...weeklyData };
            updatedData[dayKey].transactions = updatedData[dayKey].transactions.filter(t => t.id !== id);
            await updateWeeklyData(selectedBarberId, currentWeekId, updatedData);
        }

        function handleEditTransaction(id) {
            alert("Funcionalidade de edição em desenvolvimento (migração).");
        }

        async function saveVale() {
            const val = parseFloat(elements.valeInput.value) || 0;
            const dayKey = weekDays[selectedDay];
            const updatedData = { ...weeklyData };
            if (!updatedData[dayKey]) updatedData[dayKey] = { transactions: [], vale: 0 };
            updatedData[dayKey].vale = val;
            await updateWeeklyData(selectedBarberId, currentWeekId, updatedData);
            alert("Vale salvo!");
        }

        async function closeWeek() {
            if (loggedInUser.role !== 'admin') return;
            if (!confirm("Encerrar semana?")) return;
            const summary = calculateWeeklySummary(weeklyData);
            const weekStartDate = new Date();
            weekStartDate.setDate(weekStartDate.getDate() - (weekStartDate.getDay() - 2 + 7) % 7);
            const weekEndDate = new Date(weekStartDate);
            weekEndDate.setDate(weekEndDate.getDate() + 4);
            const periodo = `${weekStartDate.toLocaleDateString('pt-BR')} - ${weekEndDate.toLocaleDateString('pt-BR')}`;
            await closeWeekInDb(selectedBarberId, currentWeekId, {
                weekId: currentWeekId, periodo, faturamentoBruto: summary.totalBrutoSemana,
                totalVale: summary.totalValeSemana, comissaoPaga: summary.comissaoFinalSemana, details: weeklyData
            });
            alert("Semana encerrada!");
        }

        document.addEventListener('DOMContentLoaded', init);
    </script>
</body>

</html>
