<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Calculadora de Comissﾃ｣o Semanal - Barbearia</title>
<script src="https://cdn.tailwindcss.com"></script>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" xintegrity="sha512-iecdLmaskl7CVkqkXNQ/ZH/XLlvWZOJyj7Yy7tcenmpD1ypASozpmT/E0iPtmFIB46ZmdtAc9eNBvH0H/ZpiBw==" crossorigin="anonymous" referrerpolicy="no-referrer" />
<style>
  body { font-family: 'Inter', sans-serif; }
  .day-btn.active { background-color: #0891b2; color: white; }
  .transaction-item:hover .action-btn { opacity: 1; }
  .action-btn { opacity: 0; transition: opacity 0.2s ease-in-out; }
  .modal-backdrop {
    background-color: rgba(0,0,0,0.5);
    transition: opacity 0.3s ease;
  }
</style>
</head>
<body class="bg-gray-900 text-white antialiased">

<div id="login-screen" class="min-h-screen flex items-center justify-center">
  <div class="bg-gray-800 p-8 rounded-xl shadow-lg border border-gray-700 w-full max-w-sm">
    <h2 class="text-3xl font-bold text-center text-cyan-400 mb-6">Barber<span class="text-white">Commission</span></h2>
    <div class="space-y-4">
      <div>
        <label for="email" class="block text-sm font-medium text-gray-300 mb-1">Email</label>
        <input type="email" id="email" class="w-full bg-gray-700 border border-gray-600 rounded-md px-3 py-2 focus:ring-2 focus:ring-cyan-500 transition" placeholder="admin@exemplo.com">
      </div>
      <div>
        <label for="password" class="block text-sm font-medium text-gray-300 mb-1">Senha</label>
        <input type="password" id="password" class="w-full bg-gray-700 border border-gray-600 rounded-md px-3 py-2 focus:ring-2 focus:ring-cyan-500 transition" placeholder="窶｢窶｢窶｢窶｢窶｢窶｢窶｢窶｢">
      </div>
      <button id="loginBtn" class="w-full bg-cyan-600 hover:bg-cyan-700 text-white font-bold py-2 px-4 rounded-md transition duration-300">Entrar</button>
    </div>
    <p class="text-xs text-gray-500 mt-4 text-center">Use admin@exemplo.com (senha: )</p>
  </div>
</div>

<div id="app-container" class="hidden">
  <div class="container mx-auto p-4 md:p-8 max-w-7xl">

    <header class="text-center mb-6">
      <h1 class="text-4xl font-bold text-cyan-400">Barber<span class="text-white">Commission</span></h1>
      <p class="text-gray-400 mt-2">Fechamento de comissﾃ｣o semanal (Terﾃｧa a Sﾃ｡bado)</p>
      <p id="currentWeek" class="text-cyan-500 font-semibold mt-2"></p>
      <p id="welcomeMessage" class="text-white mt-2"></p>
    </header>

    <div id="admin-report-section" class="hidden bg-gray-800 p-6 rounded-xl shadow-lg border border-gray-700 mb-8">
      <h2 class="text-2xl font-semibold mb-4 text-center text-cyan-400">投 Relatﾃｳrio Geral da Barbearia</h2>
      <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 text-center">
        <div class="bg-gray-700 p-4 rounded-lg">
          <h3 class="text-lg font-medium text-gray-300 mb-2">Faturamento Real (Semana Atual)</h3>
          <div class="space-y-2 text-left">
            <p class="flex justify-between"><span>Dinheiro:</span> <span id="reportDinheiro" class="font-semibold text-green-400">R$ 0,00</span></p>
            <p class="flex justify-between"><span>Pix:</span> <span id="reportPix" class="font-semibold text-green-400">R$ 0,00</span></p>
            <p class="flex justify-between"><span>Dﾃｩbito:</span> <span id="reportDebito" class="font-semibold text-green-400">R$ 0,00</span></p>
            <p class="flex justify-between"><span>Crﾃｩdito:</span> <span id="reportCredito" class="font-semibold text-green-400">R$ 0,00</span></p>
          </div>
        </div>
        <div class="bg-gray-700 p-4 rounded-lg flex flex-col justify-center items-center">
          <h3 class="text-lg font-medium text-gray-300">Faturamento Bruto Total (Semana Atual)</h3>
          <p id="reportFaturamentoTotal" class="text-3xl font-bold text-cyan-400 mt-2">R$ 0,00</p>
        </div>
        <div class="bg-gray-700 p-4 rounded-lg">
          <h3 class="text-lg font-medium text-gray-300 mb-2">Assinaturas (Semana Atual)</h3>
          <p class="text-3xl font-bold" id="reportQtdAssinaturas">0</p>
          <p class="text-gray-400">serviﾃｧos</p>
          <p class="text-lg font-semibold text-cyan-400 mt-1" id="reportValorAssinaturas">R$ 0,00</p>
        </div>
        <div class="bg-gray-700 p-4 rounded-lg">
          <h3 class="text-lg font-medium text-gray-300 mb-2">Cartﾃ｣o Presente (Semana Atual)</h3>
          <p class="text-3xl font-bold" id="reportQtdCartaoPresente">0</p>
          <p class="text-gray-400">serviﾃｧos</p>
          <p class="text-lg font-semibold text-cyan-400 mt-1" id="reportValorCartaoPresente">R$ 0,00</p>
        </div>
        <!-- Commission from Subscriptions/Gift Cards -->
        <div class="bg-gray-700 p-4 rounded-lg md:col-span-2 lg:col-span-4 flex flex-col justify-center items-center">
          <h3 class="text-lg font-medium text-gray-300">Comissﾃ｣o de Assinaturas/Cartﾃ｣o Presente (Semana Atual)</h3>
          <p id="reportComissaoAssinaturasCartao" class="text-3xl font-bold text-green-400 mt-2">R$ 0,00</p>
        </div>

        <!-- NEW: Daily Summary by Payment Method -->
        <div class="lg:col-span-2 bg-gray-700 p-4 rounded-lg">
          <h3 class="text-lg font-medium text-gray-300 mb-2">Faturamento Diﾃ｡rio (Hoje)</h3>
          <div class="space-y-2 text-left">
            <p class="flex justify-between"><span>Dinheiro:</span> <span id="reportFaturamentoDiarioDinheiro" class="font-semibold text-teal-400">R$ 0,00</span></p>
            <p class="flex justify-between"><span>Pix:</span> <span id="reportFaturamentoDiarioPix" class="font-semibold text-teal-400">R$ 0,00</span></p>
            <p class="flex justify-between"><span>Dﾃｩbito:</span> <span id="reportFaturamentoDiarioDebito" class="font-semibold text-teal-400">R$ 0,00</span></p>
            <p class="flex justify-between"><span>Crﾃｩdito:</span> <span id="reportFaturamentoDiarioCredito" class="font-semibold text-teal-400">R$ 0,00</span></p>
          </div>
        </div>

        <!-- NEW: Barber Ranking (Weekly) -->
        <div class="lg:col-span-2 bg-gray-700 p-4 rounded-lg flex flex-col">
          <h3 class="text-lg font-medium text-gray-300 mb-2">Ranking de Faturamento (Semanal)</h3>
          <div id="barberRankingList" class="space-y-2 flex-grow overflow-y-auto">
            <!-- Ranking items will be inserted here by JS -->
          </div>
        </div>

        <!-- NEW: Store 01 Daily and Weekly Summary -->
        <div class="lg:col-span-2 bg-gray-700 p-4 rounded-lg">
            <h3 class="text-lg font-medium text-gray-300 mb-2">Faturamento Diﾃ｡rio - Loja 01 (Hoje)</h3>
            <div class="space-y-2 text-left">
                <p class="flex justify-between"><span>Dinheiro:</span> <span id="loja01DailyDinheiro" class="font-semibold text-blue-400">R$ 0,00</span></p>
                <p class="flex justify-between"><span>Pix:</span> <span id="loja01DailyPix" class="font-semibold text-blue-400">R$ 0,00</span></p>
                <p class="flex justify-between"><span>Dﾃｩbito:</span> <span id="loja01DailyDebito" class="font-semibold text-blue-400">R$ 0,00</span></p>
                <p class="flex justify-between"><span>Crﾃｩdito:</span> <span id="loja01DailyCredito" class="font-semibold text-blue-400">R$ 0,00</span></p>
            </div>
            <h3 class="text-lg font-medium text-gray-300 mt-4 mb-2">Faturamento Semanal - Loja 01</h3>
            <p id="loja01WeeklyTotal" class="text-2xl font-bold text-blue-400">R$ 0,00</p>
        </div>

        <!-- NEW: Store 02 Daily and Weekly Summary -->
        <div class="lg:col-span-2 bg-gray-700 p-4 rounded-lg">
            <h3 class="text-lg font-medium text-gray-300 mb-2">Faturamento Diﾃ｡rio - Loja 02 (Hoje)</h3>
            <div class="space-y-2 text-left">
                <p class="flex justify-between"><span>Dinheiro:</span> <span id="loja02DailyDinheiro" class="font-semibold text-yellow-400">R$ 0,00</span></p>
                <p class="flex justify-between"><span>Pix:</span> <span id="loja02DailyPix" class="font-semibold text-yellow-400">R$ 0,00</span></p>
                <p class="flex justify-between"><span>Dﾃｩbito:</span> <span id="loja02DailyDebito" class="font-semibold text-yellow-400">R$ 0,00</span></p>
                <p class="flex justify-between"><span>Crﾃｩdito:</span> <span id="loja02DailyCredito" class="font-semibold text-yellow-400">R$ 0,00</span></p>
            </div>
            <h3 class="text-lg font-medium text-gray-300 mt-4 mb-2">Faturamento Semanal - Loja 02</h3>
            <p id="loja02WeeklyTotal" class="text-2xl font-bold text-yellow-400">R$ 0,00</p>
        </div>
      </div>
    </div>

    <div id="admin-selector-container" class="max-w-md mx-auto mb-8 hidden">
      <label for="barberSelector" class="block text-center text-lg font-medium text-gray-300 mb-2">Selecione o Funcionﾃ｡rio (Visﾃ｣o do Administrador)</label>
      <select id="barberSelector" class="w-full bg-gray-700 border border-gray-600 rounded-md px-3 py-3 text-lg focus:ring-2 focus:ring-cyan-500 transition">
        <option value="">-- Visﾃ｣o Geral / Selecione um funcionﾃ｡rio --</option>
        <option value="barber-01">Adriano Pessanha</option>
        <option value="barber-02">Rodrigo</option>
        <option value="barber-03">Veloso</option>
        <option value="barber-04">wellithon</option>
        <option value="barber-05">Jonata</option>
        <option value="barber-06">Mauro</option>
      </select>
    </div>


    <div id="main-content" class="grid grid-cols-1 lg:grid-cols-5 gap-8 hidden">

      <div class="lg:col-span-3 flex flex-col gap-6">
        <div class="bg-gray-800 p-6 rounded-xl shadow-lg border border-gray-700">
          <h2 class="text-2xl font-semibold mb-4">Lanﾃｧamentos da Semana</h2>
          <div id="day-selector" class="grid grid-cols-3 sm:grid-cols-5 gap-2 mb-6"></div>

          <div id="transaction-form" class="bg-gray-700/50 p-4 rounded-lg space-y-4">
            <h3 class="font-semibold text-lg mb-3">Adicionar Lanﾃｧamento</h3>
            
            <!-- Service Details -->
            <div class="bg-gray-700/70 p-4 rounded-lg space-y-3 border border-gray-600">
                <h4 class="font-semibold text-md text-cyan-300">Detalhes do Serviﾃｧo</h4>
                <input type="text" id="clientName" placeholder="Nome do Cliente (opcional)" class="entry-input w-full bg-gray-600 border border-gray-500 rounded-md px-3 py-2">
                <input type="text" id="serviceDescription" placeholder="Descriﾃｧﾃ｣o do Serviﾃｧo" class="entry-input w-full bg-gray-600 border border-gray-500 rounded-md px-3 py-2">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <input type="number" id="serviceValue" placeholder="Valor do Serviﾃｧo (R$)" class="entry-input w-full bg-gray-600 border border-gray-500 rounded-md px-3 py-2">
                    <select id="paymentMethod" class="entry-input w-full bg-gray-600 border border-gray-500 rounded-md px-3 py-2">
                        <option value="Dinheiro">Dinheiro</option>
                        <option value="Pix">Pix</option>
                        <option value="Dﾃｩbito">Dﾃｩbito</option>
                        <option value="Crﾃｩdito">Crﾃｩdito</option>
                        <option value="Assinatura">Assinatura</option>
                        <option value="Cartﾃ｣o Presente">Cartﾃ｣o Presente</option>
                    </select>
                </div>
            </div>

            <!-- Product Details -->
            <div class="bg-gray-700/70 p-4 rounded-lg space-y-3 border border-gray-600">
                <h4 class="font-semibold text-md text-cyan-300">Detalhes do Produto</h4>
                <input type="text" id="productDescription" placeholder="Descriﾃｧﾃ｣o do Produto (opcional)" class="entry-input w-full bg-gray-600 border border-gray-500 rounded-md px-3 py-2">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <input type="number" id="productsSold" placeholder="Qtd. Produtos Vendidos" class="entry-input w-full bg-gray-600 border border-gray-500 rounded-md px-3 py-2">
                    <input type="number" id="productSaleValue" placeholder="Valor Total dos Produtos (R$)" class="entry-input w-full bg-gray-600 border border-gray-500 rounded-md px-3 py-2">
                </div>
                <select id="productPaymentMethod" class="entry-input w-full bg-gray-600 border border-gray-500 rounded-md px-3 py-2">
                    <option value="">Forma de Pagamento Produto</option>
                    <option value="Dinheiro">Dinheiro</option>
                    <option value="Pix">Pix</option>
                    <option value="Dﾃｩbito">Dﾃｩbito</option>
                    <option value="Crﾃｩdito">Crﾃｩdito</option>
                </select>
            </div>

            <!-- NEW: Plan/Gift Card Sale Details -->
            <div class="bg-gray-700/70 p-4 rounded-lg space-y-3 border border-gray-600">
                <h4 class="font-semibold text-md text-purple-300">Venda de Plano / Vale Presente</h4>
                <input type="text" id="clientNamePlan" placeholder="Nome do Cliente (Obrigatﾃｳrio)" class="entry-input w-full bg-gray-600 border border-gray-500 rounded-md px-3 py-2" required>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <input type="number" id="planSaleValue" placeholder="Valor do Plano/Vale (R$)" class="entry-input w-full bg-gray-600 border border-gray-500 rounded-md px-3 py-2">
                    <select id="planSaleType" class="entry-input w-full bg-gray-600 border border-gray-500 rounded-md px-3 py-2">
                        <option value="">Tipo de Venda</option>
                        <option value="Assinatura">Assinatura</option>
                        <option value="Cartﾃ｣o Presente">Cartﾃ｣o Presente</option>
                    </select>
                </div>
                <select id="planSalePaymentMethod" class="entry-input w-full bg-gray-600 border border-gray-500 rounded-md px-3 py-2">
                    <option value="">Forma de Pagamento Plano/Vale</option>
                    <option value="Dinheiro">Dinheiro</option>
                    <option value="Pix">Pix</option>
                    <option value="Dﾃｩbito">Dﾃｩbito</option>
                    <option value="Crﾃｩdito">Crﾃｩdito</option>
                </select>
            </div>

            <button id="addTransactionBtn" class="w-full bg-cyan-600 hover:bg-cyan-700 text-white font-bold py-2 px-4 rounded-md transition duration-300 flex items-center justify-center gap-2">
              <i class="fa-solid fa-plus"></i> Adicionar Lanﾃｧamento
            </button>
          </div>

          <div class="mt-6">
            <h3 class="font-semibold text-lg mb-2">Atividade do Dia</h3>
            <div id="daily-log" class="space-y-2 max-h-96 overflow-y-auto pr-2">
              <p id="daily-log-placeholder" class="text-gray-500 text-center p-4">Nenhum lanﾃｧamento para este dia.</p>
            </div>
            <div class="relative mt-4">
              <label for="vale" class="block text-sm font-medium text-yellow-400 mb-1">Registrar Vale para o Dia</label>
              <div class="flex gap-2">
                <input type="number" id="vale" placeholder="Valor do Vale (R$)" class="entry-input w-full bg-gray-700 border border-gray-600 rounded-md px-3 py-2">
                <button id="saveValeBtn" class="bg-yellow-600 hover:bg-yellow-700 text-white font-bold py-2 px-4 rounded-md transition">Salvar</button>
              </div>
            </div>
          </div>
        </div>
      </div>

      <div class="lg:col-span-2">
        <div class="bg-gray-800 p-6 rounded-xl shadow-lg border border-gray-700 sticky top-8">
          <h2 class="text-2xl font-semibold mb-4">Resumo da Semana</h2>
          <div class="space-y-3">
            <div class="flex justify-between items-center bg-gray-900 p-3 rounded-lg">
              <span class="font-medium text-gray-300">Faturamento Bruto:</span>
              <span id="faturamentoBruto" class="text-xl font-bold text-cyan-400">R$ 0,00</span>
            </div>
            <div class="flex justify-between items-center p-2">
              <span class="text-gray-400">Comissﾃ｣o Serviﾃｧos:</span>
              <span id="comissaoServicos">R$ 0,00</span>
            </div>
            <!-- NEW: Comissﾃ｣o de Assinaturas -->
            <div class="flex justify-between items-center p-2">
              <span class="text-gray-400">Comissﾃ｣o Assinaturas:</span>
              <span id="comissaoAssinaturas">R$ 0,00</span>
            </div>
            <!-- NEW: Comissﾃ｣o de Cartﾃ｣o Presente -->
            <div class="flex justify-between items-center p-2">
              <span class="text-gray-400">Comissﾃ｣o Cartﾃ｣o Presente:</span>
              <span id="comissaoCartaoPresente">R$ 0,00</span>
            </div>
            <div class="flex justify-between items-center p-2">
              <span class="text-gray-400">Comissﾃ｣o Produtos:</span>
              <span id="comissaoProdutos">R$ 0,00</span>
            </div>
            <div class="flex justify-between items-center p-2 font-medium">
              <span class="text-gray-300">Subtotal Comissﾃ｣o:</span>
              <span id="subtotalComissao">R$ 0,00</span>
            </div>
            <div class="flex justify-between items-center p-2">
              <span class="text-yellow-400">Total de Vales:</span>
              <span id="descontoVale" class="text-yellow-400">- R$ 0,00</span>
            </div>
            <hr class="border-gray-600"/>
            <div class="flex justify-between items-center bg-green-900/50 p-4 rounded-lg mt-2">
              <span class="text-lg font-medium text-white">Comissﾃ｣o a Pagar:</span>
              <span id="comissaoFinal" class="text-2xl font-bold text-green-400">R$ 0,00</span>
            </div>
          </div>

          <!-- Detalhes do Faturamento por Barbeiro -->
          <div id="barberDetailsSection" class="mt-8 bg-gray-700 p-6 rounded-xl shadow-lg border border-gray-600 hidden">
            <h3 class="text-xl font-semibold mb-4 text-cyan-400">Detalhes do Faturamento Diﾃ｡rio</h3>
            <div class="space-y-3">
              <div class="flex justify-between items-center">
                <span class="text-gray-300">Assinaturas:</span>
                <span id="detalheAssinaturas" class="font-semibold text-green-400">R$ 0,00</span>
              </div>
              <div class="flex justify-between items-center">
                <span class="text-gray-300">Cartﾃ｣o Presente:</span>
                <span id="detalheCartaoPresente" class="font-semibold text-green-400">R$ 0,00</span>
              </div>
              <div class="flex justify-between items-center">
                <span class="text-gray-300">Dinheiro:</span>
                <span id="detalheDinheiro" class="font-semibold text-green-400">R$ 0,00</span>
              </div>
              <div class="flex justify-between items-center">
                <span class="text-gray-300">Pix:</span>
                <span id="detalhePix" class="font-semibold text-green-400">R$ 0,00</span>
              </div>
              <div class="flex justify-between items-center">
                <span class="text-gray-300">Dﾃｩbito:</span>
                <span id="detalheDebito" class="font-semibold text-green-400">R$ 0,00</span>
              </div>
              <div class="flex justify-between items-center">
                <span class="text-gray-300">Crﾃｩdito:</span>
                <span id="detalheCredito" class="font-semibold text-green-400">R$ 0,00</span>
              </div>
              <div class="flex justify-between items-center pt-2 border-t border-gray-600">
                <span class="text-gray-300">Total Produtos Vendidos:</span>
                <span id="detalheTotalProdutos" class="font-semibold text-green-400">0</span>
              </div>
            </div>
          </div>
          <!-- Fim Detalhes do Faturamento -->

          <button id="closeWeekBtn" class="mt-6 w-full bg-green-600 hover:bg-green-700 text-white font-bold py-3 px-4 rounded-md transition duration-300 flex items-center justify-center gap-2">
            <i class="fa-solid fa-lock"></i>
            Encerrar e Pagar Semana
          </button>
        </div>
      </div>
    </div>

    <div id="history-section" class="mt-12 hidden lg:col-span-5">
      <div class="bg-gray-800 p-6 rounded-xl shadow-lg border border-gray-700">
        <h2 class="text-2xl font-semibold mb-4">Histﾃｳrico de Fechamentos Semanais</h2>
        <div class="overflow-x-auto">
          <table class="w-full text-sm text-left text-gray-300">
            <thead class="text-xs text-cyan-400 uppercase bg-gray-700">
              <tr>
                <th scope="col" class="px-4 py-3">Perﾃｭodo da Semana</th>
                <th scope="col" class="px-4 py-3 text-right">Faturamento Bruto</th>
                <th scope="col" class="px-4 py-3 text-right">Total Vales</th>
                <th scope="col" class="px-4 py-3 text-right">Comissﾃ｣o Paga</th>
              </tr>
            </thead>
            <tbody id="historyTableBody"></tbody>
          </table>
          <div id="historyPlaceholder" class="text-center py-10 text-gray-500">
            <p>Nenhum fechamento semanal registrado.</p>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<div id="edit-modal" class="fixed inset-0 z-50 items-center justify-center hidden modal-backdrop">
  <div class="bg-gray-800 rounded-lg shadow-xl p-6 w-full max-w-lg mx-4 border border-gray-600">
    <div class="flex justify-between items-center mb-4">
      <h3 class="font-semibold text-lg">Editar Lanﾃｧamento</h3>
      <button id="close-edit-modal-btn" class="text-gray-400 hover:text-white">&times;</button>
    </div>
    <div id="edit-transaction-form" class="space-y-4">
        <!-- Edit Service Details -->
        <div class="bg-gray-700/70 p-4 rounded-lg space-y-3 border border-gray-600">
            <h4 class="font-semibold text-md text-cyan-300">Detalhes do Serviﾃｧo</h4>
            <input type="text" id="editClientName" placeholder="Nome do Cliente (opcional)" class="entry-input w-full bg-gray-700 border border-gray-500 rounded-md px-3 py-2">
            <input type="text" id="editServiceDescription" placeholder="Descriﾃｧﾃ｣o do Serviﾃｧo" class="entry-input w-full bg-gray-700 border border-gray-500 rounded-md px-3 py-2">
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <input type="number" id="editServiceValue" placeholder="Valor do Serviﾃｧo (R$)" class="entry-input w-full bg-gray-700 border border-gray-500 rounded-md px-3 py-2">
                <select id="editPaymentMethod" class="entry-input w-full bg-gray-700 border border-gray-500 rounded-md px-3 py-2">
                    <option value="Dinheiro">Dinheiro</option>
                    <option value="Pix">Pix</option>
                    <option value="Dﾃｩbito">Dﾃｩbito</option>
                    <option value="Crﾃｩdito">Crﾃｩdito</option>
                    <option value="Assinatura">Assinatura</option>
                    <option value="Cartﾃ｣o Presente">Cartﾃ｣o Presente</option>
                </select>
            </div>
        </div>

        <!-- Edit Product Details -->
        <div class="bg-gray-700/70 p-4 rounded-lg space-y-3 border border-gray-600">
            <h4 class="font-semibold text-md text-cyan-300">Detalhes do Produto</h4>
            <input type="text" id="editProductDescription" placeholder="Descriﾃｧﾃ｣o do Produto (opcional)" class="entry-input w-full bg-gray-700 border border-gray-500 rounded-md px-3 py-2">
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <input type="number" id="editProductsSold" placeholder="Qtd. Produtos Vendidos" class="entry-input w-full bg-gray-600 border border-gray-500 rounded-md px-3 py-2">
                <input type="number" id="editProductSaleValue" placeholder="Valor Total dos Produtos (R$)" class="entry-input w-full bg-gray-600 border border-gray-500 rounded-md px-3 py-2">
            </div>
            <select id="editProductPaymentMethod" class="entry-input w-full bg-gray-600 border border-gray-500 rounded-md px-3 py-2">
                <option value="">Forma de Pagamento Produto</option>
                <option value="Dinheiro">Dinheiro</option>
                <option value="Pix">Pix</option>
                <option value="Dﾃｩbito">Dﾃｩbito</option>
                <option value="Crﾃｩdito">Crﾃｩdito</option>
            </select>
        </div>

        <!-- NEW: Edit Plan/Gift Card Sale Details -->
        <div class="bg-gray-700/70 p-4 rounded-lg space-y-3 border border-gray-600">
            <h4 class="font-semibold text-md text-purple-300">Venda de Plano / Vale Presente</h4>
            <input type="text" id="editClientNamePlan" placeholder="Nome do Cliente (Obrigatﾃｳrio)" class="entry-input w-full bg-gray-600 border border-gray-500 rounded-md px-3 py-2" required>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <input type="number" id="editPlanSaleValue" placeholder="Valor do Plano/Vale (R$)" class="entry-input w-full bg-gray-600 border border-gray-500 rounded-md px-3 py-2">
                <select id="editPlanSaleType" class="entry-input w-full bg-gray-600 border border-gray-500 rounded-md px-3 py-2">
                    <option value="">Tipo de Venda</option>
                    <option value="Assinatura">Assinatura</option>
                    <option value="Cartﾃ｣o Presente">Cartﾃ｣o Presente</option>
                </select>
            </div>
            <select id="editPlanSalePaymentMethod" class="entry-input w-full bg-gray-600 border border-gray-500 rounded-md px-3 py-2">
                <option value="">Forma de Pagamento Plano/Vale</option>
                <option value="Dinheiro">Dinheiro</option>
                <option value="Pix">Pix</option>
                <option value="Dﾃｩbito">Dﾃｩbito</option>
                <option value="Crﾃｩdito">Crﾃｩdito</option>
            </select>
        </div>

      <button id="saveEditBtn" class="w-full bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded-md transition duration-300 flex items-center justify-center gap-2">
        <i class="fa-solid fa-save"></i> Salvar Alteraﾃｧﾃｵes
      </button>
    </div>
  </div>
</div>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
  import { getAuth, signInAnonymously } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
  import { getFirestore, doc, setDoc, onSnapshot, collection, addDoc, serverTimestamp, query, deleteDoc, getDocs, collectionGroup } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

  // *****************************************************************
  // ATENﾃﾃグ: COLE AQUI A CONFIGURAﾃﾃグ DO SEU PROJETO FIREBASE!
  // *****************************************************************
  const firebaseConfig = {
    apiKey: "AIzaSyAOrTcxD_3nnFGytaaNN-xa087Hel00IRU",
    authDomain: "comisao-dos-barbeiros.firebaseapp.com",
    projectId: "comisao-dos-barbeiros",
    storageBucket: "comisao-dos-barbeiros.firebasestorage.app",
    messagingSenderId: "571199864529",
    appId: "1:571199864529:web:0ea9584c0c5372192e4ff0",
    measurementId: "G-VW7EZCR5G5"
  };

  // --- SIMULATED USER DATABASE ---
  const users = {
    "admin@exemplo.com": { password: "753951", role: "admin", name: "Admin" },
    "adrianopessanha@exemplo.com": { password: "123", role: "barber", barberId: "barber-01", name: "Adriano Pessanha" },
    "rodrigo@exemplo.com": { password: "123", role: "barber", barberId: "barber-02", name: "Rodrigo Azevedo" },
    "veloso@exemplo.com": { password: "123", role: "barber", barberId: "barber-03", name: "Veloso" },
    "wellithon@exemplo.com": { password: "123", role: "barber", barberId: "barber-04", name: "Wellithon" },
    "jonata@exemplo.com": { password: "123", role: "barber", barberId: "barber-05", name: "Jonata Silva" },
    "Mauro@exemplo.com": { password: "123", role: "barber", barberId: "barber-06", name: "Mauro" }
  };

  // Map barbers to stores
  const barberStoreMap = {
    "barber-01": "loja02", // Adriano
    "barber-02": "loja01", // Rodrigo
    "barber-03": "loja01", // Veloso
    "barber-04": "loja02", // Wellithon
    "barber-05": "loja02", // Jonata
    "barber-06": "loja01"  // Mauro
  };

  let db;
  let selectedBarberId = null;
  let loggedInUser = null;
  let currentWeekId;
  let selectedDay;
  let weeklyData = {};
  let currentEditingTransactionId = null;
  let unsubscribeWeeklyData = () => {};
  let unsubscribeHistory = () => {};
  let unsubscribeWeeklyEntriesAdmin = () => {};
  let unsubscribeWeeklyClosingsAdmin = () => {};

  let latestWeeklyEntriesData = [];
  let latestWeeklyClosingsData = [];

  const weekDays = { 2: 'Terﾃｧa', 3: 'Quarta', 4: 'Quinta', 5: 'Sexta', 6: 'Sﾃ｡bado' };

  let loginScreen, appContainer, barberSelector, mainContent, historySection, daySelector, addTransactionBtn, saveValeBtn, valeInput,
      dailyLog, dailyLogPlaceholder, transactionForm, editModal, closeEditModalBtn, saveEditBtn,
      editTransactionForm, closeWeekBtn, currentWeekSpan, historyTableBody, historyPlaceholder, summarySpans,
      adminSelectorContainer, welcomeMessage, loginBtn, emailInput, passwordInput, adminReportSection, adminReportSpans,
      detalheAssinaturas, detalheCartaoPresente, detalheDinheiro, detalhePix, detalheDebito, detalheCredito, detalheTotalProdutos,
      barberDetailsSection, reportComissaoAssinaturasCartao, barberRankingList,
      loja01DailyDinheiro, loja01DailyPix, loja01DailyDebito, loja01DailyCredito, loja01WeeklyTotal,
      loja02DailyDinheiro, loja02DailyPix, loja02DailyDebito, loja02DailyCredito, loja02WeeklyTotal; // New store-specific DOM references

  let comissaoAssinaturas, comissaoCartaoPresente; // Commission elements for barber summary

  const formatCurrency = (value) => new Intl.NumberFormat('pt-BR', { style: 'currency', currency: 'BRL' }).format(value);

  function getWeekId(d = new Date()) {
    d = new Date(Date.UTC(d.getFullYear(), d.getMonth(), d.getDate()));
    d.setUTCDate(d.getUTCDate() + 4 - (d.getUTCDay()||7));
    const yearStart = new Date(Date.UTC(d.getUTCFullYear(),0,1));
    const weekNo = Math.ceil((((d - yearStart) / 86400000) + 1)/7);
    return `${d.getUTCFullYear()}-W${String(weekNo).padStart(2, '0')}`;
  }

  function initializeDOMReferences() {
    loginScreen = document.getElementById('login-screen');
    appContainer = document.getElementById('app-container');
    loginBtn = document.getElementById('loginBtn');
    emailInput = document.getElementById('email');
    passwordInput = document.getElementById('password');
    barberSelector = document.getElementById('barberSelector');
    adminSelectorContainer = document.getElementById('admin-selector-container');
    welcomeMessage = document.getElementById('welcomeMessage');
    mainContent = document.getElementById('main-content');
    historySection = document.getElementById('history-section');
    daySelector = document.getElementById('day-selector');
    addTransactionBtn = document.getElementById('addTransactionBtn');
    saveValeBtn = document.getElementById('saveValeBtn');
    valeInput = document.getElementById('vale');
    dailyLog = document.getElementById('daily-log');
    dailyLogPlaceholder = document.getElementById('daily-log-placeholder');
    // Updated transactionForm to include productDescription, productSaleValue, and productPaymentMethod, and new plan fields
    transactionForm = { 
        clientName: document.getElementById('clientName'), 
        serviceDescription: document.getElementById('serviceDescription'), 
        serviceValue: document.getElementById('serviceValue'), 
        paymentMethod: document.getElementById('paymentMethod'), 
        productDescription: document.getElementById('productDescription'),
        productsSold: document.getElementById('productsSold'),
        productSaleValue: document.getElementById('productSaleValue'),
        productPaymentMethod: document.getElementById('productPaymentMethod'),
        clientNamePlan: document.getElementById('clientNamePlan'), // NEW: Renamed from planDescription
        planSaleValue: document.getElementById('planSaleValue'),     
        planSaleType: document.getElementById('planSaleType'),       
        planSalePaymentMethod: document.getElementById('planSalePaymentMethod') 
    };
    editModal = document.getElementById('edit-modal');
    closeEditModalBtn = document.getElementById('close-edit-modal-btn');
    saveEditBtn = document.getElementById('saveEditBtn');
    // Updated editTransactionForm to include editProductDescription, editProductSaleValue, editProductPaymentMethod, and new plan fields
    editTransactionForm = { 
        clientName: document.getElementById('editClientName'), 
        serviceDescription: document.getElementById('editServiceDescription'), 
        serviceValue: document.getElementById('editServiceValue'), 
        paymentMethod: document.getElementById('editPaymentMethod'), 
        productDescription: document.getElementById('editProductDescription'),
        productsSold: document.getElementById('editProductsSold'),
        productSaleValue: document.getElementById('editProductSaleValue'),
        productPaymentMethod: document.getElementById('editProductPaymentMethod'),
        clientNamePlan: document.getElementById('editClientNamePlan'), // NEW: Renamed from editPlanDescription
        planSaleValue: document.getElementById('editPlanSaleValue'),     
        planSaleType: document.getElementById('editPlanSaleType'),       
        planSalePaymentMethod: document.getElementById('editPlanSalePaymentMethod') 
    };
    closeWeekBtn = document.getElementById('closeWeekBtn');
    currentWeekSpan = document.getElementById('currentWeek');
    historyTableBody = document.getElementById('historyTableBody');
    historyPlaceholder = document.getElementById('historyPlaceholder');
    summarySpans = { faturamentoBruto: document.getElementById('faturamentoBruto'), comissaoServicos: document.getElementById('comissaoServicos'), comissaoProdutos: document.getElementById('comissaoProdutos'), subtotalComissao: document.getElementById('subtotalComissao'), descontoVale: document.getElementById('descontoVale'), comissaoFinal: document.getElementById('comissaoFinal') };
    adminReportSection = document.getElementById('admin-report-section');
    adminReportSpans = {
      faturamentoTotal: document.getElementById('reportFaturamentoTotal'),
      dinheiro: document.getElementById('reportDinheiro'),
      pix: document.getElementById('reportPix'),
      debito: document.getElementById('reportDebito'),
      credito: document.getElementById('reportCredito'),
      qtdAssinaturas: document.getElementById('reportQtdAssinaturas'),
      valorAssinaturas: document.getElementById('reportValorAssinaturas'),
      qtdCartaoPresente: document.getElementById('reportQtdCartaoPresente'),
      valorCartaoPresente: document.getElementById('reportValorCartaoPresente'),
      reportFaturamentoDiarioDinheiro: document.getElementById('reportFaturamentoDiarioDinheiro'),
      reportFaturamentoDiarioPix: document.getElementById('reportFaturamentoDiarioPix'),
      reportFaturamentoDiarioDebito: document.getElementById('reportFaturamentoDiarioDebito'),
      reportFaturamentoDiarioCredito: document.getElementById('reportFaturamentoDiarioCredito'),
    };
    detalheAssinaturas = document.getElementById('detalheAssinaturas');
    detalheCartaoPresente = document.getElementById('detalheCartaoPresente');
    detalheDinheiro = document.getElementById('detalheDinheiro');
    detalhePix = document.getElementById('detalhePix');
    detalheDebito = document.getElementById('detalheDebito');
    detalheCredito = document.getElementById('detalheCredito');
    detalheTotalProdutos = document.getElementById('detalheTotalProdutos');
    barberDetailsSection = document.getElementById('barberDetailsSection');
    reportComissaoAssinaturasCartao = document.getElementById('reportComissaoAssinaturasCartao');
    barberRankingList = document.getElementById('barberRankingList');
    loja01DailyDinheiro = document.getElementById('loja01DailyDinheiro');
    loja01DailyPix = document.getElementById('loja01DailyPix');
    loja01DailyDebito = document.getElementById('loja01DailyDebito');
    loja01DailyCredito = document.getElementById('loja01DailyCredito');
    loja01WeeklyTotal = document.getElementById('loja01WeeklyTotal');
    loja02DailyDinheiro = document.getElementById('loja02DailyDinheiro');
    loja02DailyPix = document.getElementById('loja02DailyPix');
    loja02DailyDebito = document.getElementById('loja02DailyDebito');
    loja02DailyCredito = document.getElementById('loja02DailyCredito');
    loja02WeeklyTotal = document.getElementById('loja02WeeklyTotal');

    comissaoAssinaturas = document.getElementById('comissaoAssinaturas');
    comissaoCartaoPresente = document.getElementById('comissaoCartaoPresente');
  }

  async function initializeAppAndAuth() {
    if (firebaseConfig.apiKey.includes("AIzaSyAOrTcxD_3nnFGytaaNN-xa087Hel00IRU")) {
      alert("ATENﾃﾃグ: A configuraﾃｧﾃ｣o do Firebase parece ser um placeholder. Por favor, substitua com as suas chaves de API reais.");
    }
    try {
      const app = initializeApp(firebaseConfig);
      db = getFirestore(app);
      const auth = getAuth(app);
      await signInAnonymously(auth);
      currentWeekId = getWeekId(new Date());
      initializeDOMReferences();
      setupLogin();
    } catch (error) {
      console.error("Firebase Init Error:", error);
      if (error.code === 'auth/configuration-not-found' || error.code === 'auth/operation-not-allowed') {
        alert("ERRO DE CONFIGURAﾃﾃグ DO FIREBASE:\n\nPara o aplicativo funcionar, vocﾃｪ precisa ATIVAR o provedor de login 'Anﾃｴnimo'.\n\nCOMO RESOLVER:\n1. Vﾃ｡ ao seu painel do Firebase.\n2. No menu, clique em 'Authentication'.\n3. Clique na aba 'Sign-in method'.\n4. Encontre 'Anﾃｴnimo' na lista e clique no lﾃ｡pis para editar.\n5. ATIVE a chave e clique em 'Salvar'.\n\nDepois disso, atualize a pﾃ｡gina.");
      } else {
        alert("ERRO CRﾃ控ICO: Nﾃ｣o foi possﾃｭvel inicializar o Firebase. Detalhes: " + error.message);
      }
    }
  }

  function handleLogin() {
    const email = emailInput.value;
    const password = passwordInput.value;
    const user = users[email];

    if (user && user.password === password) {
      loggedInUser = user;
      loginScreen.classList.add('hidden');
      appContainer.classList.remove('hidden');
      setupUIForUser();
    } else {
      alert("Email ou senha invﾃ｡lidos.");
    }
  }

  function setupLogin() {
    loginBtn.addEventListener('click', handleLogin);
  }

  function setupUIForUser() {
    welcomeMessage.textContent = `Bem-vindo(a), ${loggedInUser.name}!`;

    if (loggedInUser.role === 'admin') {
      adminSelectorContainer.classList.remove('hidden');
      adminReportSection.classList.remove('hidden');
      listenToAdminReportData();
      barberDetailsSection.classList.add('hidden');

      barberSelector.addEventListener('change', () => {
        selectedBarberId = barberSelector.value;
        if (selectedBarberId) {
          mainContent.classList.remove('hidden');
          historySection.classList.remove('hidden');
          startListeners();
        } else {
          mainContent.classList.add('hidden');
          historySection.classList.add('hidden');
          if (unsubscribeWeeklyData) unsubscribeWeeklyData();
          if (unsubscribeHistory) unsubscribeHistory();
        }
      });
    } else {
      adminSelectorContainer.classList.add('hidden');
      adminReportSection.classList.add('hidden');
      selectedBarberId = loggedInUser.barberId;
      mainContent.classList.remove('hidden');
      historySection.classList.remove('hidden');
      barberDetailsSection.classList.remove('hidden');
      startListeners();
    }
    setupCommonUI();
  }

  function setupCommonUI() {
    daySelector.innerHTML = Object.entries(weekDays).map(([dayIndex, dayName]) =>
      `<button class="day-btn p-2 rounded-md bg-gray-700 hover:bg-gray-600 transition" data-day-index="${dayIndex}">${dayName}</button>`
    ).join('');

    const todayIndex = new Date().getDay();
    selectedDay = (todayIndex >= 2 && todayIndex <= 6) ? todayIndex : 2;
    updateDaySelection();

    daySelector.querySelectorAll('.day-btn').forEach(btn => {
      btn.addEventListener('click', () => {
        selectedDay = parseInt(btn.dataset.dayIndex);
        updateDaySelection();
      });
    });

    const weekStartDate = new Date();
    weekStartDate.setDate(weekStartDate.getDate() - (weekStartDate.getDay() - 2 + 7) % 7);
    const weekEndDate = new Date(weekStartDate);
    weekEndDate.setDate(weekEndDate.getDate() + 4);

    currentWeekSpan.textContent = `Semana: ${weekStartDate.toLocaleDateString('pt-BR')} - ${weekEndDate.toLocaleDateString('pt-BR')}`;

    addTransactionBtn.addEventListener('click', addTransaction);
    saveValeBtn.addEventListener('click', saveVale);
    closeWeekBtn.addEventListener('click', closeWeek);
    closeEditModalBtn.addEventListener('click', () => {
      editModal.classList.add('hidden');
      editModal.classList.remove('flex');
    });
    saveEditBtn.addEventListener('click', saveEditedTransaction);
  }

  function startListeners() {
    if (unsubscribeWeeklyData) unsubscribeWeeklyData();
    if (unsubscribeHistory) unsubscribeHistory();
    listenToWeeklyData();
    listenToClosingsHistory();
  }

  function updateDaySelection() {
    daySelector.querySelectorAll('.day-btn').forEach(btn => {
      btn.classList.toggle('active', parseInt(btn.dataset.dayIndex) === selectedDay);
    });
    calculateWeeklySummary(); // Recalculate daily details when day changes
    renderDailyLog();
  }

  function renderDailyLog() {
    const dayKey = weekDays[selectedDay];
    const dayData = weeklyData[dayKey] || { transactions: [], vale: 0 };
    const transactions = dayData.transactions || [];

    dailyLog.innerHTML = '';

    if (transactions.length === 0) {
      dailyLog.appendChild(dailyLogPlaceholder);
      dailyLogPlaceholder.style.display = 'block';
    } else {
      dailyLogPlaceholder.style.display = 'none';
      transactions.forEach(t => {
        const item = document.createElement('div');
        item.className = 'transaction-item bg-gray-600/50 p-3 rounded-md flex justify-between items-center';
        
        let descriptionHtml = '';
        // Display service details if available
        if (t.serviceDescription && t.value > 0) {
            descriptionHtml += `<p class="font-semibold">${t.serviceDescription} <span class="text-cyan-400">${formatCurrency(t.value)}</span> <span class="text-gray-400">(${t.paymentMethod})</span></p>`;
        }
        // Display product details if available
        if (t.productDescription && t.products > 0) {
            // If there's also a service, put product on a new line for clarity
            if (t.serviceDescription && t.value > 0) {
                descriptionHtml += `<p class="text-sm text-gray-400 mt-1">Produto: ${t.productDescription} <span class="text-cyan-400">(${t.products} unid.)</span>`;
                if (t.productSaleValue > 0) descriptionHtml += ` <span class="text-cyan-400">${formatCurrency(t.productSaleValue)}</span>`;
                if (t.productPaymentMethod) descriptionHtml += ` <span class="text-gray-400">(${t.productPaymentMethod})</span>`;
                descriptionHtml += `</p>`;
            } else {
                // If only product, make it the primary line
                descriptionHtml += `<p class="font-semibold">Produto: ${t.productDescription} <span class="text-cyan-400">(${t.products} unid.)</span>`;
                if (t.productSaleValue > 0) descriptionHtml += ` <span class="text-cyan-400">${formatCurrency(t.productSaleValue)}</span>`;
                if (t.productPaymentMethod) descriptionHtml += ` <span class="text-gray-400">(${t.productPaymentMethod})</span>`;
                descriptionHtml += `</p>`;
            }
        }
        // Display plan/gift card sale details if available
        if (t.planSaleType && t.planSaleValue > 0) {
            let planSaleText = `Venda de ${t.planSaleType}`;
            if (t.clientNamePlan) planSaleText += ` para ${t.clientNamePlan}`; // Use clientNamePlan here
            
            // If there's also a service or product, put plan sale on a new line
            if ((t.serviceDescription && t.value > 0) || (t.productDescription && t.products > 0)) {
                descriptionHtml += `<p class="text-sm text-purple-400 mt-1">${planSaleText} <span class="text-cyan-400">${formatCurrency(t.planSaleValue)}</span> <span class="text-gray-400">(${t.planSalePaymentMethod})</span></p>`;
            } else {
                // If only plan sale, make it the primary line
                descriptionHtml += `<p class="font-semibold text-purple-400">${planSaleText} <span class="text-cyan-400">${formatCurrency(t.planSaleValue)}</span> <span class="text-gray-400">(${t.planSalePaymentMethod})</span></p>`;
            }
        }

        // Display client name if available (applies to all transaction types, but only if not already displayed as part of plan sale)
        if (t.clientName && !t.clientNamePlan) { // Only show general clientName if not a plan sale or if plan sale doesn't have clientNamePlan
            descriptionHtml += `<p class="text-xs text-gray-500">Cliente: ${t.clientName}</p>`;
        }
        
        item.innerHTML = `
          <div>
            ${descriptionHtml}
          </div>
          <div class="flex items-center gap-3">
            <button class="action-btn edit-btn text-blue-400 hover:text-blue-300" data-id="${t.id}"><i class="fa-solid fa-pencil"></i></button>
            <button class="action-btn delete-btn text-red-500 hover:text-red-400" data-id="${t.id}" data-transaction-day-index="${selectedDay}"><i class="fa-solid fa-trash"></i></button>
          </div>
        `;
        dailyLog.appendChild(item);
      });
    }

    // Pass transactionDayIndex to deleteTransaction
    dailyLog.querySelectorAll('.delete-btn').forEach(btn => btn.addEventListener('click', (event) => {
      const transactionId = event.currentTarget.dataset.id;
      const transactionDayIndex = parseInt(event.currentTarget.dataset.transactionDayIndex);
      deleteTransaction(transactionId, transactionDayIndex);
    }));
    dailyLog.querySelectorAll('.edit-btn').forEach(btn => btn.addEventListener('click', () => openEditModal(btn.dataset.id)));
    valeInput.value = dayData.vale || '';
  }

  async function updateFirestoreData(newData) {
    if (!selectedBarberId) return;
    try {
      const docRef = doc(db, "barbers", selectedBarberId, "weekly_entries", currentWeekId);
      await setDoc(docRef, newData);
    } catch (error) {
      console.error("Error updating Firestore:", error);
      alert("ERRO AO SALVAR DADOS: Verifique suas Regras de Seguranﾃｧa no painel do Firebase. Detalhes: " + error.message);
    }
  }

  async function addTransaction() {
    const serviceDescription = transactionForm.serviceDescription.value.trim();
    const serviceValue = parseFloat(transactionForm.serviceValue.value) || 0;
    const paymentMethod = transactionForm.paymentMethod.value;

    const productDescription = transactionForm.productDescription.value.trim();
    const productsSold = parseInt(transactionForm.productsSold.value) || 0;
    const productSaleValue = parseFloat(transactionForm.productSaleValue.value) || 0;
    const productPaymentMethod = transactionForm.productPaymentMethod.value;

    const clientNamePlan = transactionForm.clientNamePlan.value.trim(); // NEW
    const planSaleValue = parseFloat(transactionForm.planSaleValue.value) || 0;
    const planSaleType = transactionForm.planSaleType.value;
    const planSalePaymentMethod = transactionForm.planSalePaymentMethod.value;

    const clientName = transactionForm.clientName.value.trim(); // General client name for services/products

    // Determine transaction type and validate
    let newTransaction = null;

    const isServiceEntry = serviceDescription && serviceValue > 0;
    const isProductEntry = productDescription && productsSold > 0 && productSaleValue > 0 && productPaymentMethod;
    const isPlanSaleEntry = clientNamePlan && planSaleValue > 0 && planSaleType && planSalePaymentMethod; // clientNamePlan is now required

    // Validation: Only one type of entry at a time
    if ((isServiceEntry || isProductEntry) && isPlanSaleEntry) {
        alert("Nﾃ｣o ﾃｩ possﾃｭvel registrar serviﾃｧo/produto e venda de plano/vale na mesma transaﾃｧﾃ｣o. Por favor, registre separadamente.");
        return;
    }

    if (isServiceEntry || isProductEntry) {
        if (isServiceEntry && !paymentMethod) {
            alert("Por favor, selecione a forma de pagamento para o serviﾃｧo.");
            return;
        }
        if (isProductEntry && (!productPaymentMethod || productSaleValue <= 0)) {
             alert("Por favor, preencha o valor total e a forma de pagamento para os produtos.");
             return;
        }
        // If no service or product details, but clientName is filled, prompt for service/product details
        if (!isServiceEntry && !isProductEntry && clientName) {
            alert("Por favor, preencha os detalhes do serviﾃｧo ou produto para o cliente.");
            return;
        }

        newTransaction = {
            id: crypto.randomUUID(),
            clientName: clientName,
            serviceDescription: serviceDescription,
            value: serviceValue,
            paymentMethod: paymentMethod,
            productDescription: productDescription,
            products: productsSold,
            productSaleValue: productSaleValue,
            productPaymentMethod: productPaymentMethod
        };
    } else if (isPlanSaleEntry) {
        if (!clientNamePlan) { // This is now explicitly required for plan sales
            alert("Por favor, preencha o nome do cliente para a venda do plano/vale.");
            return;
        }
        if (planSaleValue <= 0) {
            alert("Por favor, preencha um valor total vﾃ｡lido para a venda do plano/vale.");
            return;
        }
        if (!planSaleType) {
            alert("Por favor, selecione o tipo de venda (Assinatura/Cartﾃ｣o Presente).");
            return;
        }
        if (!planSalePaymentMethod) {
            alert("Por favor, selecione a forma de pagamento para a venda do plano/vale.");
            return;
        }

        newTransaction = {
            id: crypto.randomUUID(),
            clientNamePlan: clientNamePlan, // Store client name specifically for plan sales
            planDescription: planDescription, // Still keep description as optional
            planSaleValue: planSaleValue,
            planSaleType: planSaleType,
            planSalePaymentMethod: planSalePaymentMethod
        };
    } else {
        alert("Por favor, preencha os detalhes para um serviﾃｧo, produto OU uma venda de plano/vale.");
        return;
    }

    const dayKey = weekDays[selectedDay];
    const updatedData = JSON.parse(JSON.stringify(weeklyData));

    if (!updatedData[dayKey]) updatedData[dayKey] = { transactions: [], vale: 0 };
    if (!updatedData[dayKey].transactions) updatedData[dayKey].transactions = [];

    updatedData[dayKey].transactions.push(newTransaction);

    await updateFirestoreData(updatedData);

    // Clear form fields after adding
    transactionForm.clientName.value = '';
    transactionForm.serviceDescription.value = '';
    transactionForm.serviceValue.value = '';
    transactionForm.paymentMethod.value = 'Dinheiro';
    transactionForm.productDescription.value = '';
    transactionForm.productsSold.value = '';
    transactionForm.productSaleValue.value = '';
    transactionForm.productPaymentMethod.value = '';
    transactionForm.clientNamePlan.value = ''; // Clear new client name field
    transactionForm.planDescription.value = ''; // Clear plan description
    transactionForm.planSaleValue.value = '';
    transactionForm.planSaleType.value = '';
    transactionForm.planSalePaymentMethod.value = '';
  }

  async function deleteTransaction(transactionId, transactionDayIndex) {
    const currentDayIndex = new Date().getDay();

    if (loggedInUser.role === 'barber' && transactionDayIndex !== currentDayIndex) {
      alert("Vocﾃｪ sﾃｳ pode excluir lanﾃｧamentos do dia atual.");
      return;
    }

    if (!confirm("Tem certeza que deseja apagar este lanﾃｧamento?")) return;

    const dayKey = weekDays[transactionDayIndex]; // Use the actual day of the transaction
    const updatedData = JSON.parse(JSON.stringify(weeklyData));

    if (updatedData[dayKey] && updatedData[dayKey].transactions) {
      updatedData[dayKey].transactions = updatedData[dayKey].transactions.filter(t => t.id !== transactionId);
      await updateFirestoreData(updatedData);
    }
  }

  function openEditModal(transactionId) {
    const dayKey = weekDays[selectedDay];
    const transaction = weeklyData[dayKey]?.transactions.find(t => t.id === transactionId);

    if (!transaction) return;

    currentEditingTransactionId = transactionId;
    
    // Populate service/product fields
    editTransactionForm.clientName.value = transaction.clientName || '';
    editTransactionForm.serviceDescription.value = transaction.serviceDescription || '';
    editTransactionForm.serviceValue.value = transaction.value || '';
    editTransactionForm.paymentMethod.value = transaction.paymentMethod || 'Dinheiro';
    editTransactionForm.productDescription.value = transaction.productDescription || '';
    editTransactionForm.productsSold.value = transaction.products || '';
    editTransactionForm.productSaleValue.value = transaction.productSaleValue || '';
    editTransactionForm.productPaymentMethod.value = transaction.productPaymentMethod || '';

    // Populate plan sale fields
    editTransactionForm.clientNamePlan.value = transaction.clientNamePlan || ''; // NEW
    editTransactionForm.planDescription.value = transaction.planDescription || '';
    editTransactionForm.planSaleValue.value = transaction.planSaleValue || '';
    editTransactionForm.planSaleType.value = transaction.planSaleType || '';
    editTransactionForm.planSalePaymentMethod.value = transaction.planSalePaymentMethod || '';

    editModal.classList.remove('hidden');
    editModal.classList.add('flex');
  }

  async function saveEditedTransaction() {
    if (!currentEditingTransactionId) return;

    const serviceDescription = editTransactionForm.serviceDescription.value.trim();
    const serviceValue = parseFloat(editTransactionForm.serviceValue.value) || 0;
    const paymentMethod = editTransactionForm.paymentMethod.value;

    const productDescription = editTransactionForm.productDescription.value.trim();
    const productsSold = parseInt(editTransactionForm.productsSold.value) || 0;
    const productSaleValue = parseFloat(editTransactionForm.productSaleValue.value) || 0;
    const productPaymentMethod = editTransactionForm.productPaymentMethod.value;

    const clientNamePlan = editTransactionForm.clientNamePlan.value.trim(); // NEW
    const planSaleValue = parseFloat(editTransactionForm.planSaleValue.value) || 0;
    const planSaleType = editTransactionForm.planSaleType.value;
    const planSalePaymentMethod = editTransactionForm.planSalePaymentMethod.value;

    const clientName = editTransactionForm.clientName.value.trim(); // General client name for services/products

    let updatedTransaction = null;

    const isServiceEntry = serviceDescription && serviceValue > 0;
    const isProductEntry = productDescription && productsSold > 0 && productSaleValue > 0 && productPaymentMethod;
    const isPlanSaleEntry = clientNamePlan && planSaleValue > 0 && planSaleType && planSalePaymentMethod; // clientNamePlan is now required


    // Validation similar to addTransaction
    if ((isServiceEntry || isProductEntry) && isPlanSaleEntry) {
        alert("Nﾃ｣o ﾃｩ possﾃｭvel registrar serviﾃｧo/produto e venda de plano/vale na mesma transaﾃｧﾃ｣o. Por favor, registre separadamente.");
        return;
    }

    if (isServiceEntry || isProductEntry) {
        if (isServiceEntry && !paymentMethod) {
            alert("Por favor, selecione a forma de pagamento para o serviﾃｧo.");
            return;
        }
        if (isProductEntry && (!productPaymentMethod || productSaleValue <= 0)) {
             alert("Por favor, preencha o valor total e a forma de pagamento para os produtos.");
             return;
        }
        if (!isServiceEntry && !isProductEntry && clientName) {
            alert("Por favor, preencha os detalhes do serviﾃｧo ou produto para o cliente.");
            return;
        }

        updatedTransaction = {
            id: currentEditingTransactionId, // Keep original ID
            clientName: clientName,
            serviceDescription: serviceDescription,
            value: serviceValue,
            paymentMethod: paymentMethod,
            productDescription: productDescription,
            products: productsSold,
            productSaleValue: productSaleValue,
            productPaymentMethod: productPaymentMethod
        };
    } else if (isPlanSaleEntry) {
        if (!clientNamePlan) { // This is now explicitly required for plan sales
            alert("Por favor, preencha o nome do cliente para a venda do plano/vale.");
            return;
        }
        if (planSaleValue <= 0) {
            alert("Por favor, preencha um valor total vﾃ｡lido para a venda do plano/vale.");
            return;
        }
        if (!planSaleType) {
            alert("Por favor, selecione o tipo de venda (Assinatura/Cartﾃ｣o Presente).");
            return;
        }
        if (!planSalePaymentMethod) {
            alert("Por favor, selecione a forma de pagamento para a venda do plano/vale.");
            return;
        }

        updatedTransaction = {
            id: currentEditingTransactionId, // Keep original ID
            clientNamePlan: clientNamePlan, // Store client name specifically for plan sales
            planDescription: planDescription, // Still keep description as optional
            planSaleValue: planSaleValue,
            planSaleType: planSaleType,
            planSalePaymentMethod: planSalePaymentMethod
        };
    } else {
        alert("Por favor, preencha os detalhes para um serviﾃｧo, produto OU uma venda de plano/vale.");
        return;
    }


    const dayKey = weekDays[selectedDay];
    const updatedData = JSON.parse(JSON.stringify(weeklyData));
    const transactionIndex = updatedData[dayKey]?.transactions.findIndex(t => t.id === currentEditingTransactionId);

    if (transactionIndex > -1) {
      updatedData[dayKey].transactions[transactionIndex] = updatedTransaction;
      await updateFirestoreData(updatedData);
    }

    editModal.classList.add('hidden');
    editModal.classList.remove('flex');
    currentEditingTransactionId = null;
  }

  async function saveVale() {
    const dayKey = weekDays[selectedDay];
    const vale = parseFloat(valeInput.value) || 0;

    const updatedData = JSON.parse(JSON.stringify(weeklyData));
    if (!updatedData[dayKey]) updatedData[dayKey] = { transactions: [], vale: 0 };
    updatedData[dayKey].vale = vale;

    await updateFirestoreData(updatedData);
    alert("Vale salvo com sucesso!");
  }

  function listenToWeeklyData() {
    if (!selectedBarberId) return;

    const docRef = doc(db, "barbers", selectedBarberId, "weekly_entries", currentWeekId);

    if (unsubscribeWeeklyData) unsubscribeWeeklyData();

    unsubscribeWeeklyData = onSnapshot(docRef, (docSnap) => {
      weeklyData = docSnap.exists() ? docSnap.data() : {};
      renderDailyLog();
      calculateWeeklySummary();
    }, (error) => {
      console.error("Erro ao ouvir dados semanais:", error);
      alert("ERRO AO CARREGAR DADOS: Verifique suas Regras de Seguranﾃｧa no painel do Firebase. O acesso pode estar bloqueado. Detalhes: " + error.message);
    });
  }

  function calculateWeeklySummary() {
    // --- Weekly Summary for "Resumo da Semana" (entire week) ---
    let totalBrutoSemana = 0; // All payments (services + products + subscriptions + gift cards)
    let comissaoServicosSemana = 0; // Services only, with deductions
    let comissaoAssinaturasSemana = 0;
    let comissaoCartaoPresenteSemana = 0;
    let totalValeSemana = 0;
    let totalProdutosVendidosSemana = 0; // Total quantity of products sold for commission

    // --- Daily Details for "Detalhes do Faturamento Diﾃ｡rio" (selected day only) ---
    // These will now sum all payment methods regardless of source (service, product, plan sale)
    let detalheAssinaturasDia = 0; // This will now represent total value of "Assinatura" plan sales for the day
    let detalheCartaoPresenteDia = 0; // This will now represent total value of "Cartﾃ｣o Presente" plan sales for the day
    let detalheDinheiroDia = 0;
    let detalhePixDia = 0;
    let detalheDebitoDia = 0;
    let detalheCreditoDia = 0;
    let detalheTotalProdutosDia = 0; // Total quantity of products for the day

    // Get transactions for the currently selected day
    const dayDataForSelectedDay = weeklyData[weekDays[selectedDay]] || { transactions: [], vale: 0 };
    const transactionsForSelectedDay = dayDataForSelectedDay.transactions || [];

    // Calculate details for the selected day
    transactionsForSelectedDay.forEach(t => {
        // Products quantity for daily details
        detalheTotalProdutosDia += t.products || 0;

        // Accumulate for daily details by payment method (services AND products AND plan sales)
        // Services
        if (t.serviceDescription && t.value > 0) {
            switch (t.paymentMethod) {
                // case 'Assinatura': detalheAssinaturasDia += t.value; break; // Removed from here
                // case 'Cartﾃ｣o Presente': detalheCartaoPresenteDia += t.value; break; // Removed from here
                case 'Dinheiro': detalheDinheiroDia += t.value; break;
                case 'Pix': detalhePixDia += t.value; break;
                case 'Dﾃｩbito': detalheDebitoDia += t.value; break;
                case 'Crﾃｩdito': detalheCreditoDia += t.value; break;
            }
        }
        // Products
        if (t.productDescription && t.products > 0 && t.productSaleValue > 0) {
            switch (t.productPaymentMethod) {
                case 'Dinheiro': detalheDinheiroDia += t.productSaleValue; break;
                case 'Pix': detalhePixDia += t.productSaleValue; break;
                case 'Dﾃｩbito': detalheDebitoDia += t.productSaleValue; break;
                case 'Crﾃｩdito': detalheCreditoDia += t.productSaleValue; break;
            }
        }
        // Plan Sales
        if (t.planSaleType && t.planSaleValue > 0) {
            switch (t.planSalePaymentMethod) {
                case 'Dinheiro': detalheDinheiroDia += t.planSaleValue; break;
                case 'Pix': detalhePixDia += t.planSaleValue; break;
                case 'Dﾃｩbito': detalheDebitoDia += t.planSaleValue; break;
                case 'Crﾃｩdito': detalheCreditoDia += t.planSaleValue; break;
            }
            // Add to specific Assinaturas/Cartﾃ｣o Presente totals if they are plan sales
            if (t.planSaleType === 'Assinatura') {
                detalheAssinaturasDia += t.planSaleValue;
            } else if (t.planSaleType === 'Cartﾃ｣o Presente') {
                detalheCartaoPresenteDia += t.planSaleValue;
            }
        }
    });


    // Calculate overall weekly summary (for "Resumo da Semana" section)
    Object.values(weeklyData).forEach(dayData => {
      const transactions = dayData.transactions || [];
      transactions.forEach(t => {
        // Services
        if (t.serviceDescription && t.value > 0) {
            totalProdutosVendidosSemana += t.products || 0; // Products associated with services count for commission
            totalBrutoSemana += t.value; // Add service value to total bruto
            if (t.paymentMethod === 'Assinatura') {
                comissaoAssinaturasSemana += t.value * 0.50;
            } else if (t.paymentMethod === 'Cartﾃ｣o Presente') {
                comissaoCartaoPresenteSemana += t.value * 0.50;
            } else { // Real payments for services
                let commissionableValue = t.value;
                if (t.paymentMethod === 'Dﾃｩbito') commissionableValue *= (1 - 0.015);
                else if (t.paymentMethod === 'Crﾃｩdito') commissionableValue *= (1 - 0.05);
                comissaoServicosSemana += commissionableValue * 0.50;
            }
        }

        // Products
        if (t.productDescription && t.products > 0 && t.productSaleValue > 0 && t.productPaymentMethod) {
            totalProdutosVendidosSemana += t.products; // Products from product sales also count for commission
            totalBrutoSemana += t.productSaleValue; // Add product sale value to total bruto
        }

        // Plan Sales (these do NOT generate commission for the barber)
        if (t.planSaleType && t.planSaleValue > 0 && t.planSalePaymentMethod) {
            totalBrutoSemana += t.planSaleValue; // Add plan sale value to total bruto
            // No commission added for plan sales here
        }
      });
      totalValeSemana += dayData.vale || 0;
    });

    const comissaoProdutosSemana = totalProdutosVendidosSemana * 5; // R$5.00 per product quantity
    const subtotalComissaoSemana = comissaoServicosSemana + comissaoAssinaturasSemana + comissaoCartaoPresenteSemana + comissaoProdutosSemana;
    const comissaoFinalSemana = subtotalComissaoSemana - totalValeSemana;

    // Update "Resumo da Semana" UI
    summarySpans.faturamentoBruto.textContent = formatCurrency(totalBrutoSemana);
    summarySpans.comissaoServicos.textContent = formatCurrency(comissaoServicosSemana);
    summarySpans.comissaoProdutos.textContent = formatCurrency(comissaoProdutosSemana);
    comissaoAssinaturas.textContent = formatCurrency(comissaoAssinaturasSemana);
    comissaoCartaoPresente.textContent = formatCurrency(comissaoCartaoPresenteSemana);
    summarySpans.subtotalComissao.textContent = formatCurrency(subtotalComissaoSemana);
    summarySpans.descontoVale.textContent = `- ${formatCurrency(totalValeSemana)}`;
    summarySpans.comissaoFinal.textContent = formatCurrency(comissaoFinalSemana);

    // Update "Detalhes do Faturamento Diﾃ｡rio" UI
    detalheAssinaturas.textContent = formatCurrency(detalheAssinaturasDia);
    detalheCartaoPresente.textContent = formatCurrency(detalheCartaoPresenteDia);
    detalheDinheiro.textContent = formatCurrency(detalheDinheiroDia);
    detalhePix.textContent = formatCurrency(detalhePixDia);
    detalheDebito.textContent = formatCurrency(detalheDebitoDia);
    detalheCredito.textContent = formatCurrency(detalheCreditoDia);
    detalheTotalProdutos.textContent = detalheTotalProdutosDia;
  }

  // --- ADMIN REPORT FUNCTIONS ---
  function listenToAdminReportData() {
    if (unsubscribeWeeklyEntriesAdmin) unsubscribeWeeklyEntriesAdmin();
    if (unsubscribeWeeklyClosingsAdmin) unsubscribeWeeklyClosingsAdmin();

    const weeklyEntriesRef = collectionGroup(db, 'weekly_entries');

    unsubscribeWeeklyEntriesAdmin = onSnapshot(weeklyEntriesRef, (entriesSnapshot) => {
      latestWeeklyEntriesData = entriesSnapshot.docs.map(doc => ({
        type: 'entry',
        id: doc.id,
        barberId: doc.ref.parent.parent.id, // Get barberId from path
        data: doc.data()
      }));
      calculateAdminReport(latestWeeklyEntriesData);
    }, (error) => {
      console.error("Erro ao ouvir dados de entradas semanais para o relatﾃｳrio do administrador:", error);
    });

    unsubscribeWeeklyClosingsAdmin = onSnapshot(collectionGroup(db, 'weekly_closings'), (closingsSnapshot) => {
      latestWeeklyClosingsData = closingsSnapshot.docs.map(doc => ({
        type: 'closing',
        id: doc.id,
        barberId: doc.ref.parent.parent.id,
        data: doc.data()
      }));
      calculateAdminReport(latestWeeklyEntriesData); // Still pass entries for current week calculations
    }, (error) => {
      console.error("Erro ao ouvir dados de fechamentos semanais para o relatﾃｳrio do administrador:", error);
    });
  }

  function calculateAdminReport(allEntriesData) {
    const totals = {
      faturamentoTotalCurrentWeek: 0, // Overall weekly real faturamento (services + products + plan sales)
      dinheiro: 0, // Overall weekly real faturamento by payment method (services + products + plan sales)
      pix: 0,
      debito: 0,
      credito: 0,
      qtdAssinaturas: 0, // Quantity of services paid by subscription
      valorAssinaturas: 0, // Value of services paid by subscription
      qtdCartaoPresente: 0, // Quantity of services paid by gift card
      valorCartaoPresente: 0, // Value of services paid by gift card
      comissaoAssinaturasCartao: 0, // Commission from services paid by subscription/gift card
      faturamentoDiarioDinheiro: 0, // Overall daily real faturamento by payment method (services + products + plan sales)
      faturamentoDiarioPix: 0,
      faturamentoDiarioDebito: 0,
      faturamentoDiarioCredito: 0,
      loja01DailyDinheiro: 0, // Loja 01 daily real faturamento by payment method (services + products + plan sales)
      loja01DailyPix: 0,
      loja01DailyDebito: 0,
      loja01DailyCredito: 0,
      loja01WeeklyTotal: 0, // Loja 01 weekly real faturamento (services + products + plan sales)
      loja02DailyDinheiro: 0, // Loja 02 daily real faturamento by payment method (services + products + plan sales)
      loja02DailyPix: 0,
      loja02DailyDebito: 0,
      loja02DailyCredito: 0,
      loja02WeeklyTotal: 0, // Loja 02 weekly real faturamento (services + products + plan sales)
    };

    const barberWeeklyRevenue = {}; // To store weekly real revenue per barber for ranking (services + products ONLY)

    const today = new Date();
    const currentDayOfWeek = today.getDay();
    const currentDayKey = weekDays[currentDayOfWeek];
    const currentWeekIdCalculated = getWeekId(today);

    const barberNames = {};
    for (const email in users) {
        if (users[email].role === 'barber') {
            barberNames[users[email].barberId] = users[email].name;
        }
    }

    for (const item of allEntriesData) {
        const barberId = item.barberId;
        const barberStore = barberStoreMap[barberId];
        let weeklyTransactionsByDay = item.data;
        let itemWeekId = item.id;

        if (itemWeekId === currentWeekIdCalculated) {
            if (!barberWeeklyRevenue[barberId]) {
                barberWeeklyRevenue[barberId] = 0;
            }

            for (const dayKey in weeklyTransactionsByDay) {
                const dayData = weeklyTransactionsByDay[dayKey] || {};
                const transactions = dayData.transactions || [];

                for (const t of transactions) {
                    // Accumulate for Assinaturas/Cartﾃ｣o Presente specific totals (from services)
                    if (t.paymentMethod === 'Assinatura') {
                        totals.qtdAssinaturas++;
                        totals.valorAssinaturas += t.value;
                        totals.comissaoAssinaturasCartao += t.value * 0.50;
                    } else if (t.paymentMethod === 'Cartﾃ｣o Presente') {
                        totals.qtdCartaoPresente++;
                        totals.valorCartaoPresente += t.value;
                        totals.comissaoAssinaturasCartao += t.value * 0.50;
                    }

                    // Process service value (if it's a real payment method)
                    if (t.serviceDescription && t.value > 0) { // Check if it's a service transaction
                        totals.faturamentoTotalCurrentWeek += t.value; // Overall weekly faturamento (service value)
                        if (t.paymentMethod !== 'Assinatura' && t.paymentMethod !== 'Cartﾃ｣o Presente') {
                            barberWeeklyRevenue[barberId] += t.value; // Only real service payments for barber ranking

                            if (weekDays[currentDayOfWeek] === dayKey) {
                                switch (t.paymentMethod) {
                                    case 'Dinheiro': totals.faturamentoDiarioDinheiro += t.value; break;
                                    case 'Pix': totals.faturamentoDiarioPix += t.value; break;
                                    case 'Dﾃｩbito': totals.faturamentoDiarioDebito += t.value; break;
                                    case 'Crﾃｩdito': totals.faturamentoDiarioCredito += t.value; break;
                                }
                                if (barberStore === 'loja01') {
                                    switch (t.paymentMethod) {
                                        case 'Dinheiro': totals.loja01DailyDinheiro += t.value; break;
                                        case 'Pix': totals.loja01DailyPix += t.value; break;
                                        case 'Dﾃｩbito': totals.loja01DailyDebito += t.value; break;
                                        case 'Crﾃｩdito': totals.loja01DailyCredito += t.value; break;
                                    }
                                } else if (barberStore === 'loja02') {
                                    switch (t.paymentMethod) {
                                        case 'Dinheiro': totals.loja02DailyDinheiro += t.value; break;
                                        case 'Pix': totals.loja02DailyPix += t.value; break;
                                        case 'Dﾃｩbito': totals.loja02DailyDebito += t.value; break;
                                        case 'Crﾃｩdito': totals.loja02DailyCredito += t.value; break;
                                    }
                                }
                            }
                            if (barberStore === 'loja01') totals.loja01WeeklyTotal += t.value;
                            else if (barberStore === 'loja02') totals.loja02WeeklyTotal += t.value;

                            switch (t.paymentMethod) {
                                case 'Dinheiro': totals.dinheiro += t.value; break;
                                case 'Pix': totals.pix += t.value; break;
                                case 'Dﾃｩbito': totals.debito += t.value; break;
                                case 'Crﾃｩdito': totals.credito += t.value; break;
                            }
                        }
                    }

                    // Process product sale value
                    if (t.productDescription && t.products > 0 && t.productSaleValue > 0 && t.productPaymentMethod) { // Check if it's a product transaction
                        totals.faturamentoTotalCurrentWeek += t.productSaleValue; // Overall weekly faturamento (product value)
                        barberWeeklyRevenue[barberId] += t.productSaleValue; // Product sales count for barber ranking

                        if (weekDays[currentDayOfWeek] === dayKey) {
                            switch (t.productPaymentMethod) {
                                case 'Dinheiro': totals.faturamentoDiarioDinheiro += t.productSaleValue; break;
                                case 'Pix': totals.faturamentoDiarioPix += t.productSaleValue; break;
                                case 'Dﾃｩbito': totals.faturamentoDiarioDebito += t.productSaleValue; break;
                                case 'Crﾃｩdito': totals.faturamentoDiarioCredito += t.productSaleValue; break;
                            }
                            if (barberStore === 'loja01') {
                                switch (t.productPaymentMethod) {
                                    case 'Dinheiro': totals.loja01DailyDinheiro += t.productSaleValue; break;
                                    case 'Pix': totals.loja01DailyPix += t.productSaleValue; break;
                                    case 'Dﾃｩbito': totals.loja01DailyDebito += t.productSaleValue; break;
                                    case 'Crﾃｩdito': totals.loja01DailyCredito += t.productSaleValue; break;
                                }
                            } else if (barberStore === 'loja02') {
                                switch (t.productPaymentMethod) {
                                    case 'Dinheiro': totals.loja02DailyDinheiro += t.productSaleValue; break;
                                    case 'Pix': totals.loja02DailyPix += t.productSaleValue; break;
                                    case 'Dﾃｩbito': totals.loja02DailyDebito += t.productSaleValue; break;
                                    case 'Crﾃｩdito': totals.loja02DailyCredito += t.productSaleValue; break;
                                }
                            }
                        }
                        if (barberStore === 'loja01') totals.loja01WeeklyTotal += t.productSaleValue;
                        else if (barberStore === 'loja02') totals.loja02WeeklyTotal += t.productSaleValue;

                        switch (t.productPaymentMethod) {
                            case 'Dinheiro': totals.dinheiro += t.productSaleValue; break;
                            case 'Pix': totals.pix += t.productSaleValue; break;
                            case 'Dﾃｩbito': totals.debito += t.productSaleValue; break;
                            case 'Crﾃｩdito': totals.credito += t.productSaleValue; break;
                        }
                    }

                    // Process plan sale value (does NOT count for barber's commission/ranking)
                    if (t.planSaleType && t.planSaleValue > 0 && t.planSalePaymentMethod) { // Check if it's a plan sale transaction
                        totals.faturamentoTotalCurrentWeek += t.planSaleValue; // Overall weekly faturamento (plan sale value)
                        // Do NOT add to barberWeeklyRevenue

                        if (weekDays[currentDayOfWeek] === dayKey) {
                            switch (t.planSalePaymentMethod) {
                                case 'Dinheiro': totals.faturamentoDiarioDinheiro += t.planSaleValue; break;
                                case 'Pix': totals.faturamentoDiarioPix += t.planSaleValue; break;
                                case 'Dﾃｩbito': totals.faturamentoDiarioDebito += t.planSaleValue; break;
                                case 'Crﾃｩdito': totals.faturamentoDiarioCredito += t.planSaleValue; break;
                            }
                            if (barberStore === 'loja01') {
                                switch (t.planSalePaymentMethod) {
                                    case 'Dinheiro': totals.loja01DailyDinheiro += t.planSaleValue; break;
                                    case 'Pix': totals.loja01DailyPix += t.planSaleValue; break;
                                    case 'Dﾃｩbito': totals.loja01DailyDebito += t.planSaleValue; break;
                                    case 'Crﾃｩdito': totals.loja01DailyCredito += t.planSaleValue; break;
                                }
                            } else if (barberStore === 'loja02') {
                                switch (t.planSalePaymentMethod) {
                                    case 'Dinheiro': totals.loja02DailyDinheiro += t.planSaleValue; break;
                                    case 'Pix': totals.loja02DailyPix += t.planSaleValue; break;
                                    case 'Dﾃｩbito': totals.loja02DailyDebito += t.planSaleValue; break;
                                    case 'Crﾃｩdito': totals.loja02DailyCredito += t.planSaleValue; break;
                                }
                            }
                        }
                        if (barberStore === 'loja01') totals.loja01WeeklyTotal += t.planSaleValue;
                        else if (barberStore === 'loja02') totals.loja02WeeklyTotal += t.planSaleValue;

                        switch (t.planSalePaymentMethod) {
                            case 'Dinheiro': totals.dinheiro += t.planSaleValue; break;
                            case 'Pix': totals.pix += t.planSaleValue; break;
                            case 'Dﾃｩbito': totals.debito += t.planSaleValue; break;
                            case 'Crﾃｩdito': totals.credito += t.planSaleValue; break;
                        }
                    }
                }
            }
        }
    }

    // Prepare barber ranking (weekly)
    const rankedBarbersWeekly = Object.keys(barberWeeklyRevenue).map(barberId => ({
        name: barberNames[barberId] || `Barbeiro ${barberId}`,
        revenue: barberWeeklyRevenue[barberId]
    })).sort((a, b) => b.revenue - a.revenue); // Sort descending

    // Update UI for daily breakdown (overall)
    adminReportSpans.reportFaturamentoDiarioDinheiro.textContent = formatCurrency(totals.faturamentoDiarioDinheiro);
    adminReportSpans.reportFaturamentoDiarioPix.textContent = formatCurrency(totals.faturamentoDiarioPix);
    adminReportSpans.reportFaturamentoDiarioDebito.textContent = formatCurrency(totals.faturamentoDiarioDebito);
    adminReportSpans.reportFaturamentoDiarioCredito.textContent = formatCurrency(totals.faturamentoDiarioCredito);

    // Update UI for weekly summary (overall)
    adminReportSpans.faturamentoTotal.textContent = formatCurrency(totals.faturamentoTotalCurrentWeek);
    adminReportSpans.dinheiro.textContent = formatCurrency(totals.dinheiro);
    adminReportSpans.pix.textContent = formatCurrency(totals.pix);
    adminReportSpans.debito.textContent = formatCurrency(totals.debito);
    adminReportSpans.credito.textContent = formatCurrency(totals.credito);
    adminReportSpans.qtdAssinaturas.textContent = totals.qtdAssinaturas;
    adminReportSpans.valorAssinaturas.textContent = formatCurrency(totals.valorAssinaturas);
    adminReportSpans.qtdCartaoPresente.textContent = totals.qtdCartaoPresente;
    adminReportSpans.valorCartaoPresente.textContent = formatCurrency(totals.valorCartaoPresente);
    reportComissaoAssinaturasCartao.textContent = formatCurrency(totals.comissaoAssinaturasCartao);

    // Update UI for store-specific daily and weekly totals
    loja01DailyDinheiro.textContent = formatCurrency(totals.loja01DailyDinheiro);
    loja01DailyPix.textContent = formatCurrency(totals.loja01DailyPix);
    loja01DailyDebito.textContent = formatCurrency(totals.loja01DailyDebito);
    loja01DailyCredito.textContent = formatCurrency(totals.loja01DailyCredito);
    loja01WeeklyTotal.textContent = formatCurrency(totals.loja01WeeklyTotal);

    loja02DailyDinheiro.textContent = formatCurrency(totals.loja02DailyDinheiro);
    loja02DailyPix.textContent = formatCurrency(totals.loja02DailyPix);
    loja02DailyDebito.textContent = formatCurrency(totals.loja02DailyDebito);
    loja02DailyCredito.textContent = formatCurrency(totals.loja02DailyCredito);
    loja02WeeklyTotal.textContent = formatCurrency(totals.loja02WeeklyTotal);

    // Render barber ranking (weekly)
    barberRankingList.innerHTML = '';
    if (rankedBarbersWeekly.length === 0) {
        barberRankingList.innerHTML = '<p class="text-gray-500 text-center">Nenhum faturamento semanal registrado ainda.</p>';
    } else {
        rankedBarbersWeekly.forEach((barber, index) => {
            const rankItem = document.createElement('div');
            rankItem.className = 'flex justify-between items-center bg-gray-700/50 p-3 rounded-md';
            rankItem.innerHTML = `
                <span class="font-medium text-gray-300">${index + 1}. ${barber.name}</span>
                <span class="font-bold text-lg text-green-400">${formatCurrency(barber.revenue)}</span>
            `;
            barberRankingList.appendChild(rankItem);
        });
    }
  }

  async function closeWeek() {
    if (Object.keys(weeklyData).length === 0) {
      alert("Nﾃ｣o hﾃ｡ dados para fechar esta semana.");
      return;
    }

    if (!confirm("Tem certeza que deseja encerrar a semana? Esta aﾃｧﾃ｣o nﾃ｣o pode ser desfeita e irﾃ｡ arquivar os resultados.")) {
      return;
    }

    let totalBruto = 0, comissaoServicos = 0, totalVale = 0, totalProdutos = 0;
    let comissaoAssinaturasVal = 0; // NEW
    let comissaoCartaoPresenteVal = 0; // NEW

    Object.values(weeklyData).forEach(dayData => {
      const transactions = dayData.transactions || [];
      transactions.forEach(t => {
        // Products quantity for commission (from both service-associated products and standalone product sales)
        totalProdutos += t.products || 0;

        // Calculate commissions and total bruto for services
        if (t.serviceDescription && t.value > 0) {
          totalBruto += t.value; // Add service value to total bruto
          if (t.paymentMethod === 'Assinatura') {
            comissaoAssinaturasVal += t.value * 0.50; // 50% commission for subscriptions
          } else if (t.paymentMethod === 'Cartﾃ｣o Presente') {
            comissaoCartaoPresenteVal += t.value * 0.50; // 50% commission for gift cards
          } else { // Real payments for services
            let commissionableValue = t.value;
            if (t.paymentMethod === 'Dﾃｩbito') commissionableValue *= (1 - 0.015);
            else if (t.paymentMethod === 'Crﾃｩdito') commissionableValue *= (1 - 0.05);
            comissaoServicos += commissionableValue * 0.50; // 50% commission on services (after deductions)
          }
        }

        // Add product sale value to total bruto (from standalone product sales)
        if (t.productDescription && t.products > 0 && t.productSaleValue > 0 && t.productPaymentMethod) {
            totalBruto += t.productSaleValue;
        }

        // Add plan sale value to total bruto (from standalone plan sales)
        if (t.planSaleType && t.planSaleValue > 0 && t.planSalePaymentMethod) {
            totalBruto += t.planSaleValue;
        }
      });
      totalVale += dayData.vale || 0;
    });

    const comissaoProdutos = totalProdutos * 5;
    // NEW: Subtotal Comissﾃ｣o now includes all commission types
    const subtotalComissao = comissaoServicos + comissaoAssinaturasVal + comissaoCartaoPresenteVal + comissaoProdutos;
    const comissaoFinal = subtotalComissao - totalVale;

    const weekStartDate = new Date();
    weekStartDate.setDate(weekStartDate.getDate() - (weekStartDate.getDay() - 2 + 7) % 7);
    const weekEndDate = new Date(weekStartDate);
    weekEndDate.setDate(weekEndDate.getDate() + 4);
    const periodo = `${weekStartDate.toLocaleDateString('pt-BR')} - ${weekEndDate.toLocaleDateString('pt-BR')}`;

    try {
      const historyCollectionRef = collection(db, "barbers", selectedBarberId, "weekly_closings");
      await addDoc(historyCollectionRef, {
        weekId: currentWeekId,
        periodo,
        faturamentoBruto: totalBruto,
        totalVale,
        comissaoPaga: comissaoFinal,
        closedAt: serverTimestamp(),
        details: weeklyData // Store a snapshot of the week's data
      });

      const weekDocRef = doc(db, "barbers", selectedBarberId, "weekly_entries", currentWeekId);
      await deleteDoc(weekDocRef);

      alert(`Semana ${periodo} fechada com sucesso! Comissﾃ｣o final: ${formatCurrency(comissaoFinal)}.`);

    } catch (error) {
      console.error("Erro ao fechar a semana: ", error);
      alert("Ocorreu um erro ao fechar a semana.");
    }
  }

  function listenToClosingsHistory() {
    if (!selectedBarberId) return;

    const historyCollectionRef = collection(db, "barbers", selectedBarberId, "weekly_closings");
    const q = query(historyCollectionRef);

    if (unsubscribeHistory) unsubscribeHistory();

    unsubscribeHistory = onSnapshot(q, (snapshot) => {
      historyTableBody.innerHTML = '';
      historyPlaceholder.style.display = snapshot.empty ? 'block' : 'none';

      let docs = snapshot.docs.map(d => d.data());
      docs.sort((a,b) => (b.closedAt?.seconds || 0) - (a.closedAt?.seconds || 0));

      docs.forEach(data => {
        const tr = document.createElement('tr');
        tr.className = 'bg-gray-800 border-b border-gray-700 hover:bg-gray-700/80';
        tr.innerHTML = `
          <td class="px-4 py-3 text-gray-400">${data.periodo || data.weekId}</td>
          <td class="px-4 py-3 text-right font-medium text-cyan-400">${formatCurrency(data.faturamentoBruto || 0)}</td>
          <td class="px-4 py-3 text-right font-medium text-yellow-400">${formatCurrency(data.totalVale || 0)}</td>
          <td class="px-4 py-3 text-right font-bold text-green-400">${formatCurrency(data.comissaoPaga || 0)}</td>
        `;
        historyTableBody.appendChild(tr);
      });
    }, (error) => {
      console.error("Erro ao ouvir o histﾃｳrico:", error);
      alert("ERRO AO CARREGAR HISTﾃ迭ICO: Verifique suas Regras de Seguranﾃｧa no painel do Firebase. Detalhes: " + error.message);
    });
  }

  document.addEventListener('DOMContentLoaded', initializeAppAndAuth);
</script>
</body>
</html>
