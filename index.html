<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Calculadora de Comiss√£o Semanal - Barbearia</title>
<script src="https://cdn.tailwindcss.com"></script>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" integrity="sha512-iecdLmaskl7CVkqkXNQ/ZH/XLlvWZOJyj7Yy7tcenmpD1ypASozpmT/E0iPtmFIB46ZmdtAc9eNBvH0H/ZpiBw==" crossorigin="anonymous" referrerpolicy="no-referrer" />
<style>
  body { font-family: 'Inter', sans-serif; }
  .day-btn.active { background-color: #0891b2; color: white; }
  .transaction-item:hover .action-btn { opacity: 1; }
  .action-btn { opacity: 0; transition: opacity 0.2s ease-in-out; }
  .modal-backdrop {
    background-color: rgba(0,0,0,0.5);
    transition: opacity 0.3s ease;
  }
  input:disabled, select:disabled, button:disabled {
    background-color: #4a5568 !important;
    cursor: not-allowed;
    opacity: 0.6;
  }
</style>
</head>
<body class="bg-gray-900 text-white antialiased">

<!-- Tela de Login -->
<div id="login-screen" class="min-h-screen flex items-center justify-center">
  <div class="bg-gray-800 p-8 rounded-xl shadow-lg border border-gray-700 w-full max-w-sm">
    <h2 class="text-3xl font-bold text-center text-cyan-400 mb-6">Barber<span class="text-white">Commission</span></h2>
    <div class="space-y-4">
      <div>
        <label for="email" class="block text-sm font-medium text-gray-300 mb-1">Email</label>
        <input type="email" id="email" class="w-full bg-gray-700 border border-gray-600 rounded-md px-3 py-2 focus:ring-2 focus:ring-cyan-500 transition" placeholder="seu@email.com">
      </div>
      <div>
        <label for="password" class="block text-sm font-medium text-gray-300 mb-1">Senha</label>
        <input type="password" id="password" class="w-full bg-gray-700 border border-gray-600 rounded-md px-3 py-2 focus:ring-2 focus:ring-cyan-500 transition" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢">
      </div>
      <button id="loginBtn" class="w-full bg-cyan-600 hover:bg-cyan-700 text-white font-bold py-2 px-4 rounded-md transition duration-300">Entrar</button>
    </div>
  </div>
</div>

<!-- Container Principal do App -->
<div id="app-container" class="hidden">
  <div class="container mx-auto p-4 md:p-8 max-w-7xl">

    <!-- Cabe√ßalho -->
    <header class="text-center mb-6">
      <h1 class="text-4xl font-bold text-cyan-400">Barber<span class="text-white">Commission</span></h1>
      <p class="text-gray-400 mt-2">Fechamento de comiss√£o semanal (Ter√ßa a S√°bado)</p>
      <p id="currentWeek" class="text-cyan-500 font-semibold mt-2"></p>
      <p id="welcomeMessage" class="text-white mt-2"></p>
    </header>

    <!-- Se√ß√£o do Relat√≥rio do Admin -->
    <div id="admin-report-section" class="hidden bg-gray-800 p-6 rounded-xl shadow-lg border border-gray-700 mb-8">
      <h2 class="text-2xl font-semibold mb-4 text-center text-cyan-400">üìä Relat√≥rio Geral da Barbearia</h2>
      <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 text-center">
        <div class="lg:col-span-2 bg-gray-700 p-4 rounded-lg">
            <h3 class="text-lg font-medium text-gray-300 mt-4 mb-2">Faturamento Semanal - Loja 01</h3>
            <p id="loja01WeeklyTotal" class="text-2xl font-bold text-blue-400">R$ 0,00</p>
        </div>
        <div class="lg:col-span-2 bg-gray-700 p-4 rounded-lg">
            <h3 class="text-lg font-medium text-gray-300 mt-4 mb-2">Faturamento Semanal - Loja 02</h3>
            <p id="loja02WeeklyTotal" class="text-2xl font-bold text-yellow-400">R$ 0,00</p>
        </div>
        <div class="lg:col-span-2 bg-gray-700 p-4 rounded-lg">
          <h3 class="text-lg font-medium text-gray-300 mb-2">Faturamento Di√°rio - Loja 01 (Hoje)</h3>
          <p id="loja01DailyTotal" class="text-xl font-bold text-blue-400">R$ 0,00</p>
        </div>
        <div class="lg:col-span-2 bg-gray-700 p-4 rounded-lg">
            <h3 class="text-lg font-medium text-gray-300 mb-2">Faturamento Di√°rio - Loja 02 (Hoje)</h3>
            <p id="loja02DailyTotal" class="text-xl font-bold text-yellow-400">R$ 0,00</p>
        </div>
        <div class="lg:col-span-4 bg-gray-700 p-4 rounded-lg flex flex-col">
          <h3 class="text-lg font-medium text-gray-300 mb-2">Ranking de Faturamento (Semanal)</h3>
          <div id="barberRankingList" class="space-y-2 flex-grow overflow-y-auto"></div>
        </div>
      </div>
    </div>
    
    <!-- Seletor de Barbeiro (Vis√£o Admin/L√≠der) -->
    <div id="admin-selector-container" class="max-w-md mx-auto mb-8 hidden">
      <label for="barberSelector" class="block text-center text-lg font-medium text-gray-300 mb-2">Selecione o Funcion√°rio</label>
      <select id="barberSelector" class="w-full bg-gray-700 border border-gray-600 rounded-md px-3 py-3 text-lg focus:ring-2 focus:ring-cyan-500 transition"></select>
    </div>

    <!-- Conte√∫do Principal (Lan√ßamentos e Resumo) -->
    <div id="main-content" class="grid grid-cols-1 lg:grid-cols-5 gap-8 hidden">
      <!-- Coluna Esquerda: Lan√ßamentos -->
      <div class="lg:col-span-3 flex flex-col gap-6">
        <div class="bg-gray-800 p-6 rounded-xl shadow-lg border border-gray-700">
          <h2 class="text-2xl font-semibold mb-4">Lan√ßamentos da Semana</h2>
          <div id="day-selector" class="grid grid-cols-3 sm:grid-cols-5 gap-2 mb-6"></div>
          
          <!-- Formul√°rio de Lan√ßamento -->
          <div id="transaction-form" class="bg-gray-700/50 p-4 rounded-lg space-y-4">
            <!-- (o resto do formul√°rio permanece id√™ntico) -->
          </div>

          <!-- Atividade e Vale -->
          <div class="mt-6">
            <h3 class="font-semibold text-lg mb-2">Atividade do Dia</h3>
            <div id="daily-log" class="space-y-2 max-h-96 overflow-y-auto pr-2">
              <p id="daily-log-placeholder" class="text-gray-500 text-center p-4">Nenhum lan√ßamento para este dia.</p>
            </div>
            <div class="relative mt-4">
              <label for="vale" class="block text-sm font-medium text-yellow-400 mb-1">Registrar Vale para o Dia</label>
              <div class="flex gap-2">
                <input type="number" id="vale" placeholder="Valor do Vale (R$)" class="entry-input w-full bg-gray-700 border border-gray-600 rounded-md px-3 py-2">
                <button id="saveValeBtn" class="bg-yellow-600 hover:bg-yellow-700 text-white font-bold py-2 px-4 rounded-md transition">Salvar</button>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Coluna Direita: Resumo -->
      <div class="lg:col-span-2">
        <div class="bg-gray-800 p-6 rounded-xl shadow-lg border border-gray-700 sticky top-8">
          <h2 class="text-2xl font-semibold mb-4">Resumo da Semana</h2>
          <!-- (a estrutura do resumo permanece id√™ntica) -->
          <button id="closeWeekBtn" class="mt-6 w-full bg-green-600 hover:bg-green-700 text-white font-bold py-3 px-4 rounded-md transition duration-300 flex items-center justify-center gap-2">
            <i class="fa-solid fa-lock"></i>
            Encerrar e Pagar Semana
          </button>
        </div>
      </div>
    </div>
    
    <!-- Se√ß√£o de Hist√≥rico -->
    <div id="history-section" class="mt-12 hidden lg:col-span-5">
      <!-- (a estrutura do hist√≥rico permanece id√™ntica) -->
    </div>
  </div>
</div>

<!-- Modal de Edi√ß√£o -->
<div id="edit-modal" class="fixed inset-0 z-50 items-center justify-center hidden modal-backdrop">
  <!-- (a estrutura do modal permanece id√™ntica) -->
</div>

<!-- ======================================================== -->
<!-- =================== C√ìDIGO JAVASCRIPT ================== -->
<!-- ======================================================== -->
<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
  import { getAuth, signInWithEmailAndPassword, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
  import { getFirestore, doc, setDoc, onSnapshot, collection, addDoc, serverTimestamp, query, deleteDoc, getDocs, collectionGroup } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

  // *****************************************************************
  // CONFIGURA√á√ÉO E DADOS GLOBAIS
  // *****************************************************************
  const firebaseConfig = {
    apiKey: "AIzaSyBCfdVci2RFEearjQzByEysTXtV6D4Tofs",
    authDomain: "comisao-dos-barbeiros.firebaseapp.com",
    projectId: "comisao-dos-barbeiros",
    storageBucket: "comisao-dos-barbeiros.firebasestorage.app",
    messagingSenderId: "571199864529",
    appId: "1:571199864529:web:0ea9584c0c5372192e4ff0",
    measurementId: "G-VW7EZCR5G5"
  };

  const users = {
    "admin@exemplo.com": { password: "753951", role: "admin", name: "Admin", email: "admin@exemplo.com", barberId: "1DlWcbIq0ANITQiquGcTV5RzY7y2" },
    "adrianopessanha@exemplo.com": { password: "123456", role: "barber", name: "Adriano Pessanha", email: "adrianopessanha@exemplo.com", barberId: "mZAck0O4a6Ts2VUSSV75OHauzMG3" },
    "rodrigo@exemplo.com": { password: "123456", role: "barber", name: "Rodrigo Azevedo", email: "rodrigo@exemplo.com", barberId: "zs99mAYa5eNKoEPh56qINO8w7J22", canViewBarbers: ["hTaN1vL0afbINmeOjdbQJ13sJPg1", "xfk8NmhR9haZwjmagOAeYXCU9PY2"] },
    "veloso@exemplo.com": { password: "123456", role: "barber", name: "Veloso", email: "veloso@exemplo.com", barberId: "hTaN1vL0afbINmeOjdbQJ13sJPg1" },
    "wellington@exemplo.com": { password: "123456", role: "barber", name: "Wellington", email: "wellington@exemplo.com", barberId: "HE7OZUptfdVbN8QmUaGzYgRUWrU2" },
    "jonata@exemplo.com": { password: "123456", role: "barber", name: "Jonata Silva", email: "jonata@exemplo.com", barberId: "q0v1NPLF6jVrqWvPgTkiJBLcq242" },
    "mauro@exemplo.com": { password: "123456", role: "barber", name: "Mauro", email: "mauro@exemplo.com", barberId: "xfk8NmhR9haZwjmagOAeYXCU9PY2" }
  };

  const barberStoreMap = {
    "mZAck0O4a6Ts2VUSSV75OHauzMG3": "loja02", "zs99mAYa5eNKoEPh56qINO8w7J22": "loja01", "hTaN1vL0afbINmeOjdbQJ13sJPg1": "loja01", "HE7OZUptfdVbN8QmUaGzYgRUWrU2": "loja02", "q0v1NPLF6jVrqWvPgTkiJBLcq242": "loja02", "xfk8NmhR9haZwjmagOAeYXCU9PY2": "loja01"
  };

  // --- VARI√ÅVEIS GLOBAIS DE ESTADO E DOM ---
  let db, auth;
  let loggedInUser = null;
  let selectedBarberId = null;
  let currentWeekId;
  let selectedDay;
  let weeklyData = {};
  let unsubscribeWeeklyData = () => {};
  let unsubscribeHistory = () => {};
  let unsubscribeAdminReport = () => {};
  let elements = {}; // Objeto para guardar todos os elementos do DOM

  const weekDays = { 2: 'Ter√ßa', 3: 'Quarta', 4: 'Quinta', 5: 'Sexta', 6: 'S√°bado' };
  const formatCurrency = (value) => new Intl.NumberFormat('pt-BR', { style: 'currency', currency: 'BRL' }).format(value || 0);
  const getWeekId = (d = new Date()) => { /* ... */ return `${d.getUTCFullYear()}-W${String(Math.ceil((((new Date(Date.UTC(d.getUTCFullYear(),d.getMonth(),d.getDate())) - new Date(Date.UTC(d.getUTCFullYear(),0,1))) / 86400000) + 1)/7)).padStart(2, '0')}`; };

  // --- PONTO DE ENTRADA PRINCIPAL ---
  document.addEventListener('DOMContentLoaded', main);

  function main() {
    try {
      const app = initializeApp(firebaseConfig);
      db = getFirestore(app);
      auth = getAuth(app);
      
      initializeDOMElements(); // Pega todos os elementos da p√°gina
      setupLoginListeners();   // Configura o bot√£o de login
      setupAuthListener();     // Ouve o estado de login/logout
      
      currentWeekId = getWeekId();
    } catch (error) {
      console.error("ERRO CR√çTICO: N√£o foi poss√≠vel inicializar o Firebase.", error);
      alert("ERRO CR√çTICO: N√£o foi poss√≠vel inicializar o Firebase. Detalhes: " + error.message);
    }
  }

  // --- FUN√á√ïES DE SETUP ---
  function initializeDOMElements() {
    const allIds = [ 'login-screen', 'app-container', 'loginBtn', 'email', 'password', 'barberSelector', 'admin-selector-container', 'welcomeMessage', 'main-content', 'history-section', 'day-selector', 'addServiceTransactionBtn', 'addProductTransactionBtn', 'addPlanTransactionBtn', 'saveValeBtn', 'vale', 'daily-log', 'daily-log-placeholder', 'edit-modal', 'close-edit-modal-btn', 'saveEditBtn', 'closeWeekBtn', 'currentWeek', 'historyTableBody', 'historyPlaceholder', 'admin-report-section', 'barberDetailsSection', 'faturamentoBruto', 'comissaoServicos', 'comissaoProdutos', 'subtotalComissao', 'descontoVale', 'comissaoFinal', 'reportFaturamentoTotal', 'reportDinheiro', 'reportPix', 'reportDebito', 'reportCredito', 'reportQtdAssinaturas', 'reportValorAssinaturas', 'reportQtdCartaoPresente', 'reportValorCartaoPresente', 'reportComissaoAssinaturasCartao', 'reportFaturamentoDiarioDinheiro', 'reportFaturamentoDiarioPix', 'reportFaturamentoDiarioDebito', 'reportFaturamentoDiarioCredito', 'reportFaturamentoDiarioTotal', 'barberRankingList', 'loja01DailyDinheiro', 'loja01DailyPix', 'loja01DailyDebito', 'loja01DailyCredito', 'loja01WeeklyTotal', 'loja01DailyTotal', 'loja02DailyDinheiro', 'loja02DailyPix', 'loja02DailyDebito', 'loja02DailyCredito', 'loja02WeeklyTotal', 'loja02DailyTotal', 'comissaoAssinaturas', 'comissaoCartaoPresente', 'detalheAssinaturas', 'detalheCartaoPresente', 'detalheDinheiro', 'detalhePix', 'detalheDebito', 'detalheCredito', 'detalheTotalProdutos' ];
    allIds.forEach(id => elements[id] = document.getElementById(id));
  }

  function setupLoginListeners() {
    elements.loginBtn.addEventListener('click', handleLogin);
    elements.password.addEventListener('keyup', (event) => {
      if (event.key === 'Enter') handleLogin();
    });
  }

  function setupAuthListener() {
    onAuthStateChanged(auth, (user) => {
      if (user) {
        const userEmail = user.email.toLowerCase();
        const userInfo = users[userEmail];
        if (userInfo) {
            loggedInUser = { ...userInfo, uid: user.uid };
            elements.loginScreen.classList.add('hidden');
            elements.appContainer.classList.remove('hidden');
            setupUIForUser();
        } else {
            console.error("Usu√°rio logado no Firebase, mas n√£o encontrado na lista local:", userEmail);
            auth.signOut();
        }
      } else {
        loggedInUser = null;
        elements.loginScreen.classList.remove('hidden');
        elements.appContainer.classList.add('hidden');
        if (unsubscribeWeeklyData) unsubscribeWeeklyData();
        if (unsubscribeHistory) unsubscribeHistory();
      }
    });
  }

  // --- L√ìGICA DE LOGIN E UI ---
  async function handleLogin() {
    const email = elements.email.value.toLowerCase().trim();
    const password = elements.password.value;
    if (!email || !password) return alert("Por favor, preencha o e-mail e a senha.");
    try {
      await signInWithEmailAndPassword(auth, email, password);
    } catch (error) {
      console.error("Login Error:", error.code);
      alert("Email ou senha inv√°lidos. Verifique os dados.");
    }
  }

  function setupUIForUser() {
    elements.welcomeMessage.textContent = `Bem-vindo(a), ${loggedInUser.name}!`;
    if (loggedInUser.role === 'admin') {
      elements.adminSelectorContainer.classList.remove('hidden');
      elements.adminReportSection.classList.remove('hidden');
      listenToAdminReportData();
      elements.barberDetailsSection.classList.add('hidden');
      setupAdminBarberSelector();
    } else { 
      elements.adminReportSection.classList.add('hidden'); 
      if (loggedInUser.canViewBarbers?.length > 0) {
        elements.adminSelectorContainer.classList.remove('hidden');
        elements.barberDetailsSection.classList.remove('hidden');
        setupLeaderBarberSelector();
      } else {
        elements.adminSelectorContainer.classList.add('hidden');
        elements.barberDetailsSection.classList.remove('hidden');
        selectedBarberId = loggedInUser.barberId;
        elements.mainContent.classList.remove('hidden');
        elements.historySection.classList.remove('hidden');
        startListeners();
      }
    }
    setupCommonUI();
  }
  
  function setupAdminBarberSelector() {
    elements.barberSelector.innerHTML = '<option value="">-- Vis√£o Geral / Selecione um funcion√°rio --</option>';
    const sortedBarbers = Object.values(users)
        .filter(u => u.role === 'barber')
        .sort((a, b) => a.name.localeCompare(b.name));
    
    sortedBarbers.forEach(barber => {
        elements.barberSelector.innerHTML += `<option value="${barber.barberId}">${barber.name}</option>`;
    });

    elements.barberSelector.addEventListener('change', () => {
      selectedBarberId = elements.barberSelector.value;
      if (selectedBarberId) {
        elements.mainContent.classList.remove('hidden');
        elements.historySection.classList.remove('hidden');
        elements.barberDetailsSection.classList.remove('hidden'); 
        startListeners();
      } else {
        elements.mainContent.classList.add('hidden');
        elements.historySection.classList.add('hidden');
        elements.barberDetailsSection.classList.add('hidden'); 
        if (unsubscribeWeeklyData) unsubscribeWeeklyData();
        if (unsubscribeHistory) unsubscribeHistory();
      }
    });
  }

  // (Cole o resto das suas fun√ß√µes aqui: setupLeaderBarberSelector, setupCommonUI, startListeners, etc...)
  // Elas j√° est√£o corretas, apenas precisam ser inclu√≠das.

</script>
</body>
</html>
