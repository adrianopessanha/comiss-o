<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Sistema de Gest√£o - Barbearia</title>
<script src="https://cdn.tailwindcss.com"></script>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" integrity="sha512-iecdLmaskl7CVkqkXNQ/ZH/XLlvWZOJyj7Yy7tcenmpD1ypASozpmT/E0iPtmFIB46ZmdtAc9eNBvH0H/ZpiBw==" crossorigin="anonymous" referrerpolicy="no-referrer" />
<!-- NOVO: Adicionando Chart.js para os gr√°ficos -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<style>
  body { font-family: 'Inter', sans-serif; }
  .day-btn.active, .view-tab.active { background-color: #0891b2; color: white; }
  .transaction-item:hover .action-btn { opacity: 1; }
  .action-btn { opacity: 0; transition: opacity 0.2s ease-in-out; }
  .modal-backdrop {
    background-color: rgba(0,0,0,0.5);
    transition: opacity 0.3s ease;
  }
</style>
</head>
<body class="bg-gray-900 text-white antialiased">

<div id="login-screen" class="min-h-screen flex items-center justify-center">
  <div class="bg-gray-800 p-8 rounded-xl shadow-lg border border-gray-700 w-full max-w-sm">
    <h2 class="text-3xl font-bold text-center text-cyan-400 mb-6">Barber<span class="text-white">System</span></h2>
    <div class="space-y-4">
      <div>
        <label for="email" class="block text-sm font-medium text-gray-300 mb-1">Email</label>
        <input type="email" id="email" class="w-full bg-gray-700 border border-gray-600 rounded-md px-3 py-2 focus:ring-2 focus:ring-cyan-500 transition" placeholder="admin@exemplo.com">
      </div>
      <div>
        <label for="password" class="block text-sm font-medium text-gray-300 mb-1">Senha</label>
        <input type="password" id="password" class="w-full bg-gray-700 border border-gray-600 rounded-md px-3 py-2 focus:ring-2 focus:ring-cyan-500 transition" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢">
      </div>
      <button id="loginBtn" class="w-full bg-cyan-600 hover:bg-cyan-700 text-white font-bold py-2 px-4 rounded-md transition duration-300">Entrar</button>
    </div>
    <p class="text-xs text-gray-500 mt-4 text-center">Use admin@exemplo.com (senha: 753951)</p>
  </div>
</div>

<div id="app-container" class="hidden">
  <div class="container mx-auto p-4 md:p-8 max-w-7xl">

    <header class="text-center mb-6">
      <h1 class="text-4xl font-bold text-cyan-400">Barber<span class="text-white">System</span></h1>
      <p id="welcomeMessage" class="text-white mt-2"></p>
    </header>
    
    <!-- NOVO: Abas para trocar entre vis√£o Semanal e Mensal -->
    <div id="view-tabs-container" class="mb-8 flex justify-center hidden">
        <div class="flex p-1 bg-gray-700 rounded-lg">
            <button id="tab-weekly" class="view-tab px-6 py-2 rounded-md transition-colors">Operacional Semanal</button>
            <button id="tab-monthly" class="view-tab px-6 py-2 rounded-md transition-colors">Gest√£o Mensal</button>
        </div>
    </div>

    <!-- Container da Vis√£o Semanal (Seu c√≥digo original adaptado) -->
    <div id="weekly-view">
        <p class="text-center text-gray-400 mt-2">Fechamento de comiss√£o semanal (Ter√ßa a S√°bado)</p>
        <p id="currentWeek" class="text-cyan-500 font-semibold mt-2 text-center"></p>
        
        <!-- Se√ß√£o de Relat√≥rios do Admin (j√° existente) -->
        <div id="admin-report-section" class="hidden bg-gray-800 p-6 rounded-xl shadow-lg border border-gray-700 my-8">
            <!-- Seu conte√∫do de relat√≥rio semanal aqui, sem altera√ß√µes -->
        </div>

        <div id="admin-selector-container" class="max-w-md mx-auto mb-8 hidden">
            <!-- Seu seletor de funcion√°rio aqui, sem altera√ß√µes -->
        </div>

        <!-- Conte√∫do principal da vis√£o semanal -->
        <div id="main-content" class="grid grid-cols-1 lg:grid-cols-5 gap-8 hidden">
            <!-- Coluna de Lan√ßamentos -->
            <div class="lg:col-span-3 flex flex-col gap-6">
                <!-- Conte√∫do do formul√°rio de lan√ßamento -->
            </div>
            <!-- Coluna de Resumo -->
            <div class="lg:col-span-2">
                <!-- Conte√∫do do resumo semanal -->
            </div>
        </div>
         <!-- Hist√≥rico Semanal -->
        <div id="history-section" class="mt-12 hidden lg:col-span-5">
            <!-- Conte√∫do do hist√≥rico semanal -->
        </div>
    </div>

    <!-- NOVO: Container da Vis√£o Mensal -->
    <div id="monthly-view" class="hidden">
        <div class="bg-gray-800 p-6 rounded-xl shadow-lg border border-gray-700">
            <h2 class="text-2xl font-semibold mb-6 text-center text-cyan-400">üìä Painel de Gest√£o Mensal</h2>

            <!-- Seletor de M√™s e Ano -->
            <div class="flex justify-center items-center gap-4 mb-8">
                <select id="month-selector" class="bg-gray-700 border border-gray-600 rounded-md px-3 py-2"></select>
                <select id="year-selector" class="bg-gray-700 border border-gray-600 rounded-md px-3 py-2"></select>
            </div>

            <!-- Cards de Resumo Financeiro -->
            <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8 text-center">
                <div class="bg-gray-700 p-5 rounded-lg">
                    <h3 class="text-lg font-medium text-gray-300">Faturamento Bruto</h3>
                    <p id="monthly-revenue" class="text-3xl font-bold text-green-400 mt-2">R$ 0,00</p>
                </div>
                <div class="bg-gray-700 p-5 rounded-lg">
                    <h3 class="text-lg font-medium text-gray-300">Total Despesas</h3>
                    <p id="monthly-expenses" class="text-3xl font-bold text-red-400 mt-2">R$ 0,00</p>
                </div>
                <div class="bg-gray-700 p-5 rounded-lg">
                    <h3 class="text-lg font-medium text-gray-300">Lucro / Preju√≠zo</h3>
                    <p id="monthly-profit" class="text-3xl font-bold text-cyan-400 mt-2">R$ 0,00</p>
                </div>
            </div>

            <!-- Gr√°fico e Ranking -->
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-8 mb-8">
                <!-- Gr√°fico de Faturamento Semanal -->
                <div class="bg-gray-700 p-5 rounded-lg">
                    <h3 class="text-lg font-medium text-gray-300 mb-4">Faturamento por Semana</h3>
                    <canvas id="weekly-revenue-chart"></canvas>
                </div>
                <!-- Ranking de Barbeiros do M√™s -->
                <div class="bg-gray-700 p-5 rounded-lg">
                    <h3 class="text-lg font-medium text-gray-300 mb-4">Ranking de Faturamento (M√™s)</h3>
                    <div id="monthly-barber-ranking" class="space-y-2 overflow-y-auto max-h-64">
                        <p class="text-gray-500">Nenhum dado para exibir.</p>
                    </div>
                </div>
            </div>

            <!-- Controle de Despesas -->
            <div class="bg-gray-700 p-6 rounded-lg">
                <h3 class="text-xl font-semibold mb-4 text-cyan-300">Controle de Despesas do M√™s</h3>
                <!-- Formul√°rio para adicionar despesa -->
                <div class="grid grid-cols-1 md:grid-cols-4 gap-4 items-end mb-6 p-4 bg-gray-800/50 rounded-lg">
                    <input type="date" id="expense-date" class="w-full bg-gray-600 border border-gray-500 rounded-md px-3 py-2">
                    <input type="text" id="expense-description" placeholder="Descri√ß√£o da Despesa" class="w-full bg-gray-600 border border-gray-500 rounded-md px-3 py-2 md:col-span-2">
                    <input type="number" id="expense-value" placeholder="Valor (R$)" class="w-full bg-gray-600 border border-gray-500 rounded-md px-3 py-2">
                    <button id="add-expense-btn" class="w-full bg-cyan-600 hover:bg-cyan-700 text-white font-bold py-2 rounded-md transition md:col-span-4"><i class="fas fa-plus"></i> Adicionar Despesa</button>
                </div>
                <!-- Tabela de Despesas -->
                <div class="overflow-x-auto">
                    <table class="w-full text-sm text-left text-gray-300">
                        <thead class="text-xs text-cyan-400 uppercase bg-gray-800">
                            <tr>
                                <th class="px-4 py-3">Data</th>
                                <th class="px-4 py-3">Descri√ß√£o</th>
                                <th class="px-4 py-3 text-right">Valor</th>
                                <th class="px-4 py-3 text-center">A√ß√µes</th>
                            </tr>
                        </thead>
                        <tbody id="expenses-table-body">
                            <!-- Linhas de despesa ser√£o inseridas aqui -->
                        </tbody>
                    </table>
                     <div id="expenses-placeholder" class="text-center py-10 text-gray-500">
                        <p>Nenhuma despesa registrada para este m√™s.</p>
                     </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modais (seu c√≥digo original) -->
    <div id="edit-modal" class="fixed inset-0 z-50 items-center justify-center hidden modal-backdrop">
       <!-- Conte√∫do do modal de edi√ß√£o, sem altera√ß√µes -->
    </div>
  </div>
</div>

<script type="module">
  // --- Importa√ß√µes e Configura√ß√£o do Firebase (sem altera√ß√µes) ---
  import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
  import { getAuth, signInAnonymously } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
  import { getFirestore, doc, setDoc, onSnapshot, collection, addDoc, serverTimestamp, query, deleteDoc, getDocs, where, orderBy } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

  const firebaseConfig = { /* ...sua config ... */ };
  const users = { /* ...seus usu√°rios... */ };
  const barberStoreMap = { /* ...seu mapeamento de lojas... */ };

  // --- Vari√°veis Globais ---
  let db;
  let loggedInUser = null;
  let weeklyData = {}; // Mant√©m os dados da vis√£o semanal
  
  // NOVO: Vari√°veis para a gest√£o mensal
  let monthlyChart = null;
  let selectedMonth, selectedYear;
  let unsubscribeExpenses = () => {};

  // Refer√™ncias de DOM
  let loginScreen, appContainer, loginBtn, emailInput, passwordInput;
  // NOVO: Refer√™ncias para abas e pain√©is
  let viewTabsContainer, tabWeekly, tabMonthly, weeklyView, monthlyView;
  // NOVO: Refer√™ncias para o painel mensal
  let monthSelector, yearSelector, monthlyRevenueEl, monthlyExpensesEl, monthlyProfitEl, monthlyBarberRankingEl;
  let expenseDateInput, expenseDescriptionInput, expenseValueInput, addExpenseBtn, expensesTableBody, expensesPlaceholder;


  // --- Fun√ß√µes de Inicializa√ß√£o e Autentica√ß√£o (adaptadas) ---

  function initializeDOMReferences() {
    // ... suas refer√™ncias de DOM existentes ...
    loginScreen = document.getElementById('login-screen');
    appContainer = document.getElementById('app-container');
    loginBtn = document.getElementById('loginBtn');
    emailInput = document.getElementById('email');
    passwordInput = document.getElementById('password');
    welcomeMessage = document.getElementById('welcomeMessage');

    // NOVO: Refer√™ncias de abas e pain√©is
    viewTabsContainer = document.getElementById('view-tabs-container');
    tabWeekly = document.getElementById('tab-weekly');
    tabMonthly = document.getElementById('tab-monthly');
    weeklyView = document.getElementById('weekly-view');
    monthlyView = document.getElementById('monthly-view');

    // NOVO: Refer√™ncias do painel mensal
    monthSelector = document.getElementById('month-selector');
    yearSelector = document.getElementById('year-selector');
    monthlyRevenueEl = document.getElementById('monthly-revenue');
    monthlyExpensesEl = document.getElementById('monthly-expenses');
    monthlyProfitEl = document.getElementById('monthly-profit');
    monthlyBarberRankingEl = document.getElementById('monthly-barber-ranking');
    expenseDateInput = document.getElementById('expense-date');
    expenseDescriptionInput = document.getElementById('expense-description');
    expenseValueInput = document.getElementById('expense-value');
    addExpenseBtn = document.getElementById('add-expense-btn');
    expensesTableBody = document.getElementById('expenses-table-body');
    expensesPlaceholder = document.getElementById('expenses-placeholder');
  }

  async function initializeAppAndAuth() {
    // ... sua fun√ß√£o de inicializa√ß√£o, sem altera√ß√µes ...
  }

  function handleLogin() {
    // ... sua fun√ß√£o de login, sem altera√ß√µes ...
  }
  
  function setupUIForUser() {
    welcomeMessage.textContent = `Bem-vindo(a), ${loggedInUser.name}!`;

    if (loggedInUser.role === 'admin') {
        viewTabsContainer.classList.remove('hidden');
        setupViewTabs();
        // Inicializa a vis√£o mensal por padr√£o para o admin
        switchView('monthly'); 
    } else {
        // Barbeiros veem apenas a vis√£o operacional semanal
        viewTabsContainer.classList.add('hidden');
        switchView('weekly'); 
        // L√≥gica original para barbeiros...
        // ...
    }
    // ... resto da sua l√≥gica setupUIForUser ...
  }

  // --- NOVO: L√≥gica de Gest√£o de Vis√£o (Abas) ---

  function setupViewTabs() {
    tabWeekly.addEventListener('click', () => switchView('weekly'));
    tabMonthly.addEventListener('click', () => switchView('monthly'));
  }

  function switchView(view) {
    if (view === 'weekly') {
        weeklyView.classList.remove('hidden');
        monthlyView.classList.add('hidden');
        tabWeekly.classList.add('active');
        tabMonthly.classList.remove('active');
        // Aqui voc√™ pode re-ativar listeners da vis√£o semanal se necess√°rio
    } else { // 'monthly'
        weeklyView.classList.add('hidden');
        monthlyView.classList.remove('hidden');
        tabWeekly.classList.remove('active');
        tabMonthly.classList.add('active');
        // Inicializa o painel mensal
        initializeMonthlyDashboard();
    }
  }

  // --- NOVO: L√≥gica do Painel de Gest√£o Mensal ---

  function initializeMonthlyDashboard() {
    const today = new Date();
    // Preenche seletores de m√™s e ano
    const months = ["Janeiro", "Fevereiro", "Mar√ßo", "Abril", "Maio", "Junho", "Julho", "Agosto", "Setembro", "Outubro", "Novembro", "Dezembro"];
    monthSelector.innerHTML = months.map((m, i) => `<option value="${i}">${m}</option>`).join('');
    
    const currentYear = today.getFullYear();
    yearSelector.innerHTML = '';
    for (let y = currentYear; y >= currentYear - 5; y--) {
        yearSelector.innerHTML += `<option value="${y}">${y}</option>`;
    }

    // Define o m√™s e ano atuais como padr√£o
    monthSelector.value = today.getMonth();
    yearSelector.value = currentYear;

    // Adiciona listeners para atualizar o painel quando o per√≠odo mudar
    monthSelector.addEventListener('change', renderMonthlyDashboard);
    yearSelector.addEventListener('change', renderMonthlyDashboard);
    addExpenseBtn.addEventListener('click', addExpense);

    // Renderiza o painel pela primeira vez
    renderMonthlyDashboard();
  }
  
  async function renderMonthlyDashboard() {
    selectedMonth = parseInt(monthSelector.value);
    selectedYear = parseInt(yearSelector.value);

    // Cancela listeners antigos para n√£o acumular
    if (unsubscribeExpenses) unsubscribeExpenses();

    const { closings, expenses } = await fetchMonthlyData(selectedYear, selectedMonth);

    // 1. Calcular e Exibir Resumos Financeiros
    const totalRevenue = closings.reduce((sum, closing) => sum + (closing.faturamentoBruto || 0), 0);
    const totalExpenses = expenses.reduce((sum, expense) => sum + (expense.value || 0), 0);
    const profit = totalRevenue - totalExpenses;

    monthlyRevenueEl.textContent = formatCurrency(totalRevenue);
    monthlyExpensesEl.textContent = formatCurrency(totalExpenses);
    monthlyProfitEl.textContent = formatCurrency(profit);
    monthlyProfitEl.className = `text-3xl font-bold mt-2 ${profit >= 0 ? 'text-cyan-400' : 'text-red-500'}`;

    // 2. Renderizar Gr√°fico de Faturamento Semanal
    renderWeeklyRevenueChart(closings);

    // 3. Renderizar Ranking de Barbeiros
    renderMonthlyBarberRanking(closings);

    // 4. Iniciar listener e renderizar Tabela de Despesas
    listenToExpenses();
  }

  async function fetchMonthlyData(year, month) {
      const startDate = new Date(year, month, 1);
      const endDate = new Date(year, month + 1, 0, 23, 59, 59);

      // Busca todos os fechamentos semanais que ocorreram no m√™s
      const closingsRef = collection(db, "barbers", loggedInUser.barberId, "weekly_closings"); // Simplificando para o admin logado por enquanto
      const closingsQuery = query(closingsRef, 
          where("closedAt", ">=", startDate),
          where("closedAt", "<=", endDate)
      );
      const closingsSnapshot = await getDocs(closingsQuery);
      const closings = closingsSnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));

      // Busca todas as despesas do m√™s
      // NOTA: Idealmente, despesas seriam uma cole√ß√£o no topo, n√£o por barbeiro. Ex: `collections('despesas')`
      // Para simplificar, vamos colocar sob o admin por enquanto.
      const expensesRef = collection(db, "expenses"); 
      const expensesQuery = query(expensesRef, 
          where("date", ">=", startDate.toISOString().split('T')[0]),
          where("date", "<=", endDate.toISOString().split('T')[0]),
          orderBy("date", "desc")
      );
      const expensesSnapshot = await getDocs(expensesQuery);
      const expenses = expensesSnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));

      return { closings, expenses };
  }

  function renderWeeklyRevenueChart(closings) {
      if (monthlyChart) {
          monthlyChart.destroy();
      }
      const ctx = document.getElementById('weekly-revenue-chart').getContext('2d');
      
      const labels = closings.map(c => c.periodo || c.weekId).reverse();
      const data = closings.map(c => c.faturamentoBruto || 0).reverse();

      monthlyChart = new Chart(ctx, {
          type: 'bar',
          data: {
              labels: labels,
              datasets: [{
                  label: 'Faturamento Bruto',
                  data: data,
                  backgroundColor: 'rgba(8, 145, 178, 0.6)', // cyan-600
                  borderColor: 'rgba(8, 145, 178, 1)',
                  borderWidth: 1
              }]
          },
          options: {
              responsive: true,
              scales: {
                  y: {
                      beginAtZero: true,
                      ticks: { color: '#9ca3af' }, // gray-400
                      grid: { color: '#4b5563' } // gray-600
                  },
                  x: {
                      ticks: { color: '#9ca3af' },
                      grid: { color: '#4b5563' }
                  }
              },
              plugins: {
                  legend: { display: false }
              }
          }
      });
  }

  function renderMonthlyBarberRanking(closings) {
    // Esta fun√ß√£o precisaria de uma l√≥gica mais complexa para buscar dados de TODOS os barbeiros.
    // Por ora, vamos simular com os dados que temos.
    // TODO: Implementar busca de fechamentos de todos os barbeiros para o m√™s.
    monthlyBarberRankingEl.innerHTML = '<p class="text-gray-500">Funcionalidade de ranking mensal em desenvolvimento.</p>';
  }

  function listenToExpenses() {
    const startDate = new Date(selectedYear, selectedMonth, 1).toISOString().split('T')[0];
    const endDate = new Date(selectedYear, selectedMonth + 1, 0).toISOString().split('T')[0];
    
    const expensesRef = collection(db, "expenses");
    const q = query(expensesRef, 
        where("date", ">=", startDate), 
        where("date", "<=", endDate),
        orderBy("date", "desc")
    );

    unsubscribeExpenses = onSnapshot(q, (snapshot) => {
        expensesTableBody.innerHTML = '';
        if (snapshot.empty) {
            expensesPlaceholder.classList.remove('hidden');
        } else {
            expensesPlaceholder.classList.add('hidden');
            let totalExpenses = 0;
            snapshot.forEach(doc => {
                const expense = { id: doc.id, ...doc.data() };
                totalExpenses += expense.value;
                const tr = document.createElement('tr');
                tr.className = 'bg-gray-800 border-b border-gray-700 hover:bg-gray-700/80';
                tr.innerHTML = `
                    <td class="px-4 py-3">${new Date(expense.date + 'T00:00:00').toLocaleDateString('pt-BR')}</td>
                    <td class="px-4 py-3">${expense.description}</td>
                    <td class="px-4 py-3 text-right font-medium text-red-400">${formatCurrency(expense.value)}</td>
                    <td class="px-4 py-3 text-center">
                        <button data-id="${expense.id}" class="delete-expense-btn text-gray-500 hover:text-red-500"><i class="fa-solid fa-trash"></i></button>
                    </td>
                `;
                expensesTableBody.appendChild(tr);
            });
            // Atualiza o card de despesas em tempo real
            monthlyExpensesEl.textContent = formatCurrency(totalExpenses);
            // Recalcula o lucro
            const totalRevenue = parseFloat(monthlyRevenueEl.textContent.replace(/[^\d,-]/g, '').replace(',', '.'))
            const profit = totalRevenue - totalExpenses;
            monthlyProfitEl.textContent = formatCurrency(profit);
            monthlyProfitEl.className = `text-3xl font-bold mt-2 ${profit >= 0 ? 'text-cyan-400' : 'text-red-500'}`;
        }
        
        // Adiciona listeners para os novos bot√µes de deletar
        document.querySelectorAll('.delete-expense-btn').forEach(btn => {
            btn.addEventListener('click', () => deleteExpense(btn.dataset.id));
        });
    });
  }

  async function addExpense() {
    const date = expenseDateInput.value;
    const description = expenseDescriptionInput.value.trim();
    const value = parseFloat(expenseValueInput.value);

    if (!date || !description || !value || value <= 0) {
        alert("Por favor, preencha todos os campos da despesa corretamente.");
        return;
    }

    try {
        await addDoc(collection(db, "expenses"), {
            date,
            description,
            value,
            createdAt: serverTimestamp()
        });
        // Limpa o formul√°rio
        expenseDescriptionInput.value = '';
        expenseValueInput.value = '';
        expenseDateInput.value = '';

    } catch(error) {
        console.error("Erro ao adicionar despesa: ", error);
        alert("Ocorreu um erro ao salvar a despesa.");
    }
  }

  async function deleteExpense(expenseId) {
    if (!confirm("Tem certeza que deseja apagar esta despesa?")) return;
    try {
        await deleteDoc(doc(db, "expenses", expenseId));
    } catch(error) {
        console.error("Erro ao deletar despesa: ", error);
        alert("Ocorreu um erro ao apagar a despesa.");
    }
  }


  // --- Fun√ß√µes Auxiliares (sem altera√ß√µes ou com pequenas adapta√ß√µes) ---
  const formatCurrency = (value) => new Intl.NumberFormat('pt-BR', { style: 'currency', currency: 'BRL' }).format(value);
  // ... resto das suas fun√ß√µes auxiliares ...

  document.addEventListener('DOMContentLoaded', initializeAppAndAuth);

</script>
</body>
</html>
